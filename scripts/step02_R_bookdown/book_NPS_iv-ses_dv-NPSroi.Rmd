# [fMRI] NPS ~ session {#nps_ses}

## What is the purpose of this notebook? {.unlisted .unnumbered}

- Here, I model NPS dot products as a function of cue, stimulus intensity and expectation ratings.
- One of the findings is that low cues lead to higher NPS dotproducts in the high intensity group, and that this effect becomes non-significant across sessions.
- 03/23/2023: For now, I'm grabbing participants that have complete data, i.e. 18 runs, all three sessions.

```{r libraries_nps_stim, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(car)
library(lme4)
library(optimx)
library(minqa)
library(dfoptim)
library(tidyverse)
library(psych)
library(reshape)
library(dplyr)

library(tidyr)
library(stringr)
library(lmerTest)
library(gghalves)
library(plyr)
library(ggpubr)
library(r2mlm)
library(effectsize)
# library(devtools)
options(es.use_symbols = TRUE) # get nice symbols when printing! (On Windows, requires R >= 4.2.0)
library(EMAtools)
library(emmeans)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(plotly)
library(DT)
library(raincloudplots)
# devtools::source_url("https://raw.githubusercontent.com/RainCloudPlots/RainCloudPlots/master/tutorial_R/R_rainclouds.R")
# devtools::source_url("https://raw.githubusercontent.com/RainCloudPlots/RainCloudPlots/master/tutorial_R/summarySE.R")

devtools::source_url("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")
library(r2mlm)
main_dir <- dirname(dirname(getwd()))
file.sources = list.files(file.path(main_dir, 'scripts', 'step02_R', 'utils'),
                          pattern="*.R",
                          full.names=TRUE,
                          ignore.case=TRUE)
sapply(file.sources,source,.GlobalEnv)

```

## 0. load data and find intersection between behavioral and nps dataframes
```{r}
# "/Users/h/Documents/projects_local/cue_expectancy/analysis/fmri/nilearn/deriv05_canlabapplyNPS/sub-0016/extract-NPS_sub-0016.csv"
# # load events.tsv
# analysis_folder <- "fmri_nps"

library(tidyverse)

# Define the directory containing the CSV files
base_dir <- "/Users/h/Documents/projects_local/cue_expectancy/analysis/fmri/nilearn/deriv05_canlabapplyNPS"
analysis_folder <- "fmri_npsroi"
# List all CSV files matching the pattern
file_paths <- list.files(base_dir, pattern = "extract-NPS_sub-.*\\.csv$", full.names = TRUE, recursive = TRUE)

# Read and stack the CSV files
all_data <- file_paths %>% 
  map_dfr(~read_csv(.x, show_col_types = FALSE), .id = "file_path")

# If you want to extract and include the subject ID in the data frame:
# all_data_with_id <- file_paths %>%
#   map_dfr(read_csv, .id = "file_path") %>%
#   mutate(sub_id = str_extract(file_path, "sub-\\d+"))
canlabnpsdf <- file_paths %>%
  map_dfr(~read_csv(.x, show_col_types = FALSE), .id = "file_path") %>%
  mutate(sub_id = str_extract(file_path, "sub-\\d+"))
canlabnpsdf

write.csv(canlabnpsdf, "/Users/h/Documents/projects_local/cue_expectancy/analysis/fmri/nilearn/deriv05_canlabapplyNPS/sub-all_runtype-pvc.csv", row.names = FALSE)
```

# intersect single trials with clean data
```{r}

canlabnpsdf <- read.csv( "/Users/h/Documents/projects_local/cue_expectancy/analysis/fmri/nilearn/deriv05_canlabapplyNPS/sub-all_runtype-pvc.csv")


nps_df <- read.csv(file.path("/Volumes/spacetop_projects_cue/analysis/fmri/nilearn/deriv01_signature/rampup_plateau/signature-NPS_sub-all_runtype-pvc_event-stimulus.tsv"), sep = ",")
nps_df <- nps_df %>%
  mutate(filename_no_ext = tools::file_path_sans_ext(singletrial_fname))

canlabnpsdf$filename_no_ext <- canlabnpsdf$filename

# Now, merge the two data frames based on the new column
merged_df <- inner_join(nps_df, canlabnpsdf, by = "filename_no_ext")#, all = TRUE) # or use `all.x = TRUE` or `all.y = TRUE` depending on your needs

```



```{r}
# extract metadata from filename
library(tidyverse)

df <- merged_df %>%
  mutate(filename = as.character(filename_no_ext)) %>%
  extract(filename, into = c("sub", "ses", "run", "runtype", "event", "trial", "cuetype", "stimintensity"),
          regex = "^(sub-\\d+)_(ses-\\d+)_(run-\\d+)_runtype-(pain|vicarious|cognitive)_event-(cue|stimulus)_trial-(\\d+)_cuetype-(high|low)(?:_stimintensity-(high|med|low))?\\.nii$",
          remove = FALSE)

# Adjust the dataframe to handle NA for missing stimintensity, if tidyr version doesn't support `fill`
df$stimintensity[df$stimintensity == ""] <- NA

```


```{r}

df <- canlabnpsdf %>%
  mutate(filename = as.character(filename_no_ext)) %>%
  extract(filename, into = c("sub", "ses", "run", "runtype", "event", "trial", "cuetype", "stimintensity"),
          regex = "^(sub-\\d+)_(ses-\\d+)_(run-\\d+)_runtype-(pain|vicarious|cognitive)_event-(cue|stimulus)_trial-(\\d+)_cuetype-(high|low)(?:_stimintensity-(high|med|low))?\\.nii$",
          remove = FALSE)
data <-df[df$runtype == "pain" & df$event == "stimulus" ,]
# Adjust the dataframe to handle NA for missing stimintensity, if tidyr version doesn't support `fill`
data$stimintensity[data$stimintensity == ""] <- NA
# contrast code ________________________________________________________________
data$stim <- NA; data$STIM_linear <- NA; data$STIM_quadratic <- NA; 
data$cue <- NA;
data$CUE_high_gt_low <- NA;
data$SES_linear <- NA;data$SES_quadratic <- NA
data$stim[data$stimintensity == "low"] <-  -0.5 # social influence task
data$stim[data$stimintensity == "med"] <- 0 # no influence task
data$stim[data$stimintensity == "high"] <-  0.5 # no influence task

data$STIM <- factor(data$stimintensity)

# contrast code 1 linear
data$STIM_linear[data$stimintensity == "low"] <- -0.5
data$STIM_linear[data$stimintensity == "med"] <- 0
data$STIM_linear[data$stimintensity == "high"] <- 0.5

# contrast code 2 quadratic
data$STIM_quadratic[data$stimintensity == "low"] <- -0.33
data$STIM_quadratic[data$stimintensity == "med"] <- 0.66
data$STIM_quadratic[data$stimintensity == "high"] <- -0.33

# social cude contrast
data$CUE_high_gt_low[data$cuetype == "low"] <-  -0.5 # social influence task
data$CUE_high_gt_low[data$cuetype == "high"] <-  0.5 # no influence task

data$EXPECT <- data$expectrating
data$OUTCOME <- data$outcomerating


data$SES_linear[data$ses == "ses-01"] <- -0.5
data$SES_linear[data$ses == "ses-03"] <- 0
data$SES_linear[data$ses == "ses-04"] <- 0.5

# contrast code 2 quadratic
data$SES_quadratic[data$ses == "ses-01"] <- -0.33
data$SES_quadratic[data$ses == "ses-03"] <- 0.66
data$SES_quadratic[data$ses == "ses-04"] <- -0.33

# stim_con1 <- "STIM_linear"
# stim_con2 <- "STIM_quadratic"
iv1 <- "CUE_high_gt_low"
dv <- "nps"
dv_keyword <- "nps"

# filter data __________________________________________________________________
# Make sure that each condition cell has adequate amount of trials

subjects_with_inadequate_data <- data %>%
  group_by(sub, CUE_high_gt_low, STIM_linear) %>% #SES_linear, 
  dplyr::summarise(count = n(), .groups = 'drop') %>%
  filter(count < 6) %>%
  distinct(sub) %>%
  pull(sub)
df_filter <- data %>%
  filter(!(sub %in% subjects_with_inadequate_data))
print(subjects_with_inadequate_data)
print(sprintf("after filtering out subjects that have less than 3 trials in cell, we have N=%d -> N=%d",length(unique(data$sub)), length(unique(df_filter$sub)) ))
```


## QC. check NPS distribution
```{r}
df_filter.NA <- df_filter %>% filter(!is.na(nps))  # Remove NA values
head(df_filter.NA)
# Sort the data by median "outcome" in ascending order
sorted_data <- df_filter.NA %>%
  group_by(sub) %>%
  dplyr::summarize(median_nps = median(nps, na.rm = TRUE)) %>%
  arrange(median_nps) %>%
  select(sub)

# Reorder the "subject" factor based on the sorted order
df_filter.NA$sub <- factor(df_filter.NA$sub, levels = sorted_data$sub)

# Create the ggplot
g <- ggplot(df_filter.NA, aes(x = sub, y = nps, fill = sub)) +
  geom_boxplot(outlier.shape = NA, width = 1.2, position = position_dodge(2)) +  
  geom_jitter(width = .1, alpha = 0, size = 1) +
  labs(x = "Subject", y = "NPS") +
  theme_classic() +
  theme(legend.position = "none") +
  scale_x_discrete(breaks = NULL) 

# Convert ggplot object to a plotly object with hover information
g_plotly <- ggplotly(ggplot_largetext(g), tooltip = c("x", "y"))
g_plotly
```




#### Contrast weight table {.unlisted .unnumbered}
```{r echo=FALSE}
tab <- matrix(c(0, .5, -.5,
                .66, -.34, -.34), ncol=3, byrow=TRUE)
colnames(tab) <- c('pain','vicarious','cognitive')
rownames(tab) <- c('task_V_gt_C','task_P_gt_VC')
kableExtra::kable_styling(
  knitr::kable(
    tab, caption = "Contrast weights", "html"),
  "striped", position = "left", font_size = 15)
```


## 2. NPS ~ paintask: 2 cue x 3 stimulus_intensity
### Q. Within pain task, Does stimulus intenisty level and cue level significantly predict NPS dotproducts? {.unlisted .unnumbered}
# 03/10/2024
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
combined_se_calc_cooksd <- data.frame()
taskname = "pain"
ggtitle <- paste(taskname, " - NPS (degree)")
title <- paste(taskname, " - actual")
subject <- "sub"
w <- 10
h <- 6
# p.sig <- df_merge[df_merge$runtype == "pain" ,]
analysis_folder <- "fmri_npsroi"
analysis_dir <-
  file.path(main_dir,
            "analysis",
            "mixedeffect",
            analysis_folder,
            as.character(Sys.Date())) # nolint
dir.create(analysis_dir,
           showWarnings = FALSE,
           recursive = TRUE)
savedir <- analysis_dir
# combined_psig <-
#   rbind(combined_psig, p.sig)


# lmer model __________________________________________________________________
model_savefname <- file.path(
  analysis_dir,
  paste(
    "lmer_task-",taskname,"_rating-",dv_keyword,"_",as.character(Sys.Date()),"_cooksd.txt",
    sep = ""
  )
)


# [ PLOT ] reordering for plots _________________________ # nolint
df_filter.NA$cue_name[df_filter.NA$cuetype == "high"] <-
  "high cue"
df_filter.NA$cue_name[df_filter.NA$cuetype == "low"] <-
  "low cue"

# df_filter$stim_name[df_filter$stimulusintensity == "high_stim"] <-
#   "high"
# df_filter$stim_name[df_filter$stimulusintensity == "med_stim"] <-
#   "med"
# df_filter$stim_name[df_filter$stimulusintensity == "low_stim"] <-
#   "low"

# DATA$levels_ordered <- factor(DATA$param_stimulus_type, levels=c("low", "med", "high"))
# 
df_filter.NA$stim_ordered <- factor(df_filter.NA$stimintensity,
                                   levels = c("low", "med", "high"))
df_filter.NA$cue_ordered <- factor(df_filter.NA$cue_name,
                                  levels = c("low cue", "high cue"))
model_iv1 <- "stim_ordered"
model_iv2 <- "cue_ordered"
dv <- "npspos"
#  [ PLOT ] calculate mean and se  _________________________
NPSstimcue_subjectwise <- meanSummary(df_filter.NA,
                                      c(subject,  model_iv1, model_iv2), dv)
NPSstimcue_groupwise <- summarySEwithin(
  data = NPSstimcue_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
NPSstimcue_groupwise$task <- taskname
# https://stackoverflow.com/questions/29402528/append-data-frames-together-in-a-for-loop/29419402

combined_se_calc_cooksd <-
  rbind(combined_se_calc_cooksd, NPSstimcue_groupwise)
# calculate mean and se
sub_mean <- "mean_per_sub"
group_mean <- "mean_per_sub_norm_mean"
se <- "se"
subject <- "sub"
ggtitle <- paste(taskname, " - NPS")
title <- paste(taskname, " - NPS")
xlab <- ""
ylab <- "NPS (degree)"
ylim <- c(-10, 15)
# dv_keyword <- "NPS"
if (any(startsWith(dv_keyword, c("expect", "Expect")))) {
  color <- c("#1B9E77", "#D95F02")
} else {
  color <- c("#4575B4", "#D73027")
} # if keyword starts with
plot_savefname <- file.path(
  analysis_dir,
  paste(
    "raincloud_task-", taskname, "_rating-", dv_keyword, "_", as.character(Sys.Date()), "_cooksd.png",
    sep = ""
  )
)
g <- plot_halfrainclouds_twofactor(
  NPSstimcue_subjectwise,
  NPSstimcue_groupwise,
  model_iv1,
  model_iv2,
  sub_mean,
  group_mean,
  se,
  subject,
  ggtitle,
  title,
  xlab,
  ylab,
  taskname,
  ylim,
  w,
  h,
  dv_keyword,
  color,
  plot_savefname
)
g

g <- plot_lineplot_twofactor(NPSstimcue_groupwise,# taskname = "pain",
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("low cue" = "#4C77ED","high cue" = "#D73027"), 
                        ggtitle = "NPS dotproducts as a function of stimulus intensity level and cue",
                        xlab = "Stimulus intensity", ylab = "NPS (dot product)")
g + theme(aspect.ratio=.8,
          text = element_text(size = 18), # Default text size for the plot
          axis.title = element_text(size = 24, ), # Axis titles
          axis.text = element_text(size = 18), # Axis text (x and y)
          plot.title = element_text(size = 24, hjust = 0.5) # Plot title
          ) +
  geom_line(size = 1) + # Adjust line thickness
  geom_point(size = 3)  # Adjust point size
  
```

### Lineplots tilt axis {.unlisted .unnumbered}

```{r echo=FALSE, warning=FALSE}
g <- plot_lineplot_twofactor(NPSstimcue_groupwise,
                        iv2 = "stim_ordered", iv1 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("high" = "red",
                                  "med" = "orange",
                                  "low" = "yellow"),
                        ggtitle = "Within pain task: NPS dotproducts as a function of stimulus intensity level and cue",
                        xlab = "Stimulus intensity", ylab = "NPS (dot product)")
g + theme(aspect.ratio=.8)
```

## Linear model results (NPS ~ paintask: 2 cue x 3 stimulus_intensity)
> Modeling random slopes and random cues, we find a significnat effect of cue  and stimintensity  on NPS dot products. The greater the stimulus intensity, the greater the NPS values (b = -0.31, SE = 0.13, t(131.98) = -2.355, p < .020). Higher cues lead to lower NPS values ( b = 1.29, SE = 0.16, t(140.04) = 8.024, p < .001) 

lmer
```{r echo=TRUE, message=FALSE, warning=TRUE, paged.print=FALSE}
df_filter.NA$stim[df_filter.NA$stimintensity == "low"] <-  -0.5 # social influence task
df_filter.NA$stim[df_filter.NA$stimintensity == "med"] <- 0 # no influence task
df_filter.NA$stim[df_filter.NA$stimintensity == "high"] <-  0.5 # no influence task

df_filter.NA$STIM <- factor(df_filter.NA$stimintensity)

# contrast code 1 linear
df_filter.NA$STIM_linear[df_filter.NA$stimintensity == "low"] <- -0.5
df_filter.NA$STIM_linear[df_filter.NA$stimintensity == "med"] <- 0
df_filter.NA$STIM_linear[df_filter.NA$stimintensity == "high"] <- 0.5

# contrast code 2 quadratic
df_filter.NA$STIM_quadratic[df_filter.NA$stimintensity == "low"] <- -0.33
df_filter.NA$STIM_quadratic[df_filter.NA$stimintensity == "med"] <- 0.66
df_filter.NA$STIM_quadratic[df_filter.NA$stimintensity == "high"] <- -0.33

# social cude contrast
df_filter.NA$CUE_high_gt_low[df_filter.NA$cuetype == "low"] <-  -0.5 # social influence task
df_filter.NA$CUE_high_gt_low[df_filter.NA$cuetype == "high"] <-  0.5 # no influence task

df_filter.NA$EXPECT <- df_filter.NA$expectrating
df_filter.NA$OUTCOME <- df_filter.NA$outcomerating


df_filter.NA$SES_linear[df_filter.NA$ses == "ses-01"] <- -0.5
df_filter.NA$SES_linear[df_filter.NA$ses == "ses-03"] <- 0
df_filter.NA$SES_linear[df_filter.NA$ses == "ses-04"] <- 0.5

# contrast code 2 quadratic
df_filter.NA$SES_quadratic[df_filter.NA$ses == "ses-01"] <- -0.33
df_filter.NA$SES_quadratic[df_filter.NA$ses == "ses-03"] <- 0.66
df_filter.NA$SES_quadratic[df_filter.NA$ses == "ses-04"] <- -0.33

model.npscuestim <- lmer(nps ~
                          CUE_high_gt_low* STIM_linear + CUE_high_gt_low* STIM_quadratic +  
                          (CUE_high_gt_low + STIM_linear|sub), data = df_filter.NA, 
                         control = lmerControl(optimizer = "nmkbw")
                    )


summary(model.npscuestim)
sjPlot::tab_model(model.npscuestim,
                  title = "Multilevel-modeling: \nlmer(NPS ~ CUE + (CUE | sub), data = pvc)",
                  CSS = list(css.table = '+font-size: 12;'))

```

```{r}
# model.npscuestim.summarystats <- df_filter %>%
#   group_by(CUE_high_gt_low) %>%
#   dplyr::summarize(
#     mean_NPS = mean(NPS, na.rm = TRUE), 
#     std_NPS = sd(NPS, na.rm = TRUE)
#   )
# model.npscuestim.summarystats


model.npscuestim.summarystats.sub <- meanSummary(df_filter.NA,
                                      c("sub", "CUE_high_gt_low"), dv_keyword)
model.npscuestim.summarystats.group <- summarySEwithin(
  data = model.npscuestim.summarystats.sub,
  measurevar = "mean_per_sub",
  withinvars = c("CUE_high_gt_low"),
  idvar = "sub"
)
model.npscuestim.summarystats.group
```



### optimizers
```{r}

library(parallel)
ncores <- detectCores()
diff_optims <- allFit(model.npscuestim, maxfun = 1e5, parallel = 'multicore', ncpus = ncores)
# diff_optims <- allFit(model.full, maxfun = 1e5)
diff_optims_OK <- diff_optims[sapply(diff_optims, is, "merMod")]
lapply(diff_optims_OK, function(x) x@optinfo$conv$lme4$messages)
```
```{r}
diff_optims <- allFit(model.npscuestim, maxfun = 1e5)
```


### model converge [OK: optimizer nmkbw]

```{r}
library(optimx)
model.npscuestim <- lmer(nps ~
                          CUE_high_gt_low*STIM_linear +
                          CUE_high_gt_low*STIM_quadratic +
                          (CUE_high_gt_low *STIM_linear|sub), data = df_filter.NA,
                                    control=lmerControl(optimizer="nmkbw"
                                 ))
                         # control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)))

summary(model.npscuestim)
```

```
lmer(NPS ~
                          CUE_high_gt_low*STIM_linear +CUE_high_gt_low * STIM_quadratic +
                          (CUE_high_gt_low+STIM|sub), data = data
                    )
```



#### Linear model eta-squared {.unlisted .unnumbered}

```{r echo=FALSE, message=FALSE, warning=TRUE, paged.print=FALSE}
kableExtra::kable_styling(
  knitr::kable(
    eta_squared(model.npscuestim, partial = TRUE), # MODIFY
    "html"), "striped", position = "left", font_size = 12)
#parameters::model_parameters(model.npscuestim)
```

#### Linear model Cohen's d: NPS stimulus_intensity d = 1.16, cue d = 0.45 {.unlisted .unnumbered}

```{r echo=FALSE, message=FALSE, warning=TRUE, paged.print=FALSE}

kableExtra::kable_styling(
  knitr::kable(
    lme.dscore(model.npscuestim, data, type = "lme4"),
    "html"), "striped", position = "left", font_size = 12)
```



# B. Check HJ code after applying brain mask
```{r}
nps_brainmask_fname = '/Volumes/spacetop_projects_cue/analysis/fmri/nilearn/deriv01_signature/rampup_plateau_brainmask/signature-NPS_sub-all_runtype-pvc_event-stimulus.tsv'
analysis_folder <- "fmri_nps"
beh <- readr::read_tsv(file.path(main_dir, "data/beh/sub-all_task-all_events.tsv"))

nps_brainmask <- read.csv(nps_brainmask_fname, sep = ",")
# intersect
# Assuming df1 and df2 are your data frames and 'key_column' is the name of your key column
df_merge <- inner_join(beh, nps_brainmask, by = "singletrial_fname")
df_merge$NPS <- df_merge$NPS_dot_product
```

```{r}
data <-df_merge[df_merge$runtype == "pain" ,]

# contrast code ________________________________________________________________
data$stim <- NA; data$STIM_linear <- NA; data$STIM_quadratic <- NA; 
data$CUE_high_gt_low <- NA;
data$SES_linear <- NA;data$SES_quadratic <- NA
data$stim[data$stimulusintensity == "low_stim"] <-  -0.5 # social influence task
data$stim[data$stimulusintensity == "med_stim"] <- 0 # no influence task
data$stim[data$stimulusintensity == "high_stim"] <-  0.5 # no influence task

data$STIM <- factor(data$stimulusintensity)

# contrast code 1 linear
data$STIM_linear[data$stimulusintensity == "low_stim"] <- -0.5
data$STIM_linear[data$stimulusintensity == "med_stim"] <- 0
data$STIM_linear[data$stimulusintensity == "high_stim"] <- 0.5

# contrast code 2 quadratic
data$STIM_quadratic[data$stimulusintensity == "low_stim"] <- -0.33
data$STIM_quadratic[data$stimulusintensity == "med_stim"] <- 0.66
data$STIM_quadratic[data$stimulusintensity == "high_stim"] <- -0.33

# social cude contrast
data$CUE_high_gt_low[data$cue == "low_cue"] <-  -0.5 # social influence task
data$CUE_high_gt_low[data$cue == "high_cue"] <-  0.5 # no influence task

data$EXPECT <- data$expectrating
data$OUTCOME <- data$outcomerating


data$SES_linear[data$ses == "ses-01"] <- -0.5
data$SES_linear[data$ses == "ses-03"] <- 0
data$SES_linear[data$ses == "ses-04"] <- 0.5

# contrast code 2 quadratic
data$SES_quadratic[data$ses == "ses-01"] <- -0.33
data$SES_quadratic[data$ses == "ses-03"] <- 0.66
data$SES_quadratic[data$ses == "ses-04"] <- -0.33

stim_con1 <- "STIM_linear"
stim_con2 <- "STIM_quadratic"
iv1 <- "CUE_high_gt_low"
dv <- "NPS"
dv_keyword <- "NPS"

# filter data __________________________________________________________________
# Make sure that each condition cell has adequate amount of trials

subjects_with_inadequate_data <- data %>%
  group_by(sub, CUE_high_gt_low, STIM_linear) %>% #SES_linear, 
  dplyr::summarise(count = n(), .groups = 'drop') %>%
  filter(count < 3) %>%
  distinct(sub) %>%
  pull(sub)
df_filter <- data %>%
  filter(!(sub %in% subjects_with_inadequate_data))

print(sprintf("after filtering out subjects that have less than 3 trials in cell, we have N=%d -> N=%d",length(unique(data$sub)), length(unique(df_filter$sub)) ))
```


  ## QC. check NPS distribution
```{r}
df_filter.NA <- df_filter %>% filter(!is.na(NPS))  # Remove NA values
head(df_filter.NA)
# Sort the data by median "outcome" in ascending order
sorted_data <- df_filter.NA %>%
  group_by(sub) %>%
  dplyr::summarize(median_nps = median(NPS, na.rm = TRUE)) %>%
  arrange(median_nps) %>%
  select(sub)

# Reorder the "subject" factor based on the sorted order
df_filter.NA$sub <- factor(df_filter.NA$sub, levels = sorted_data$sub)

# Create the ggplot
g <- ggplot(df_filter.NA, aes(x = sub, y = NPS, fill = sub)) +
  geom_boxplot(outlier.shape = NA, width = 1.2, position = position_dodge(2)) +  
  geom_jitter(width = .1, alpha = 0, size = 1) +
  labs(x = "Subject", y = "NPS") +
  theme_classic() +
  theme(legend.position = "none") +
  scale_x_discrete(breaks = NULL) 

# Convert ggplot object to a plotly object with hover information
g_plotly <- ggplotly(ggplot_largetext(g), tooltip = c("x", "y"))
g_plotly
```




#### Contrast weight table {.unlisted .unnumbered}
```{r echo=FALSE}
tab <- matrix(c(0, .5, -.5,
                .66, -.34, -.34), ncol=3, byrow=TRUE)
colnames(tab) <- c('pain','vicarious','cognitive')
rownames(tab) <- c('task_V_gt_C','task_P_gt_VC')
kableExtra::kable_styling(
  knitr::kable(
    tab, caption = "Contrast weights", "html"),
  "striped", position = "left", font_size = 15)
```


## 2. NPS ~ paintask: 2 cue x 3 stimulus_intensity
### Q. Within pain task, Does stimulus intenisty level and cue level significantly predict NPS dotproducts? {.unlisted .unnumbered}
# 03/10/2024
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
combined_se_calc_cooksd <- data.frame()
# combined_psig <- data.frame()
taskname = "pain"
ggtitle <- paste(taskname, " - NPS (degree)")
title <- paste(taskname, " - actual")
subject <- "sub"
w <- 10
h <- 6
# p.sig <- df_merge[df_merge$runtype == "pain" ,]

analysis_dir <-
  file.path(main_dir,
            "analysis",
            "mixedeffect",
            analysis_folder,
            as.character(Sys.Date())) # nolint
dir.create(analysis_dir,
           showWarnings = FALSE,
           recursive = TRUE)
savedir <- analysis_dir
# combined_psig <-
#   rbind(combined_psig, p.sig)


# lmer model __________________________________________________________________
model_savefname <- file.path(
  analysis_dir,
  paste(
    "lmer_task-",taskname,"_rating-",dv_keyword,"_",as.character(Sys.Date()),"_cooksd.txt",
    sep = ""
  )
)


# [ PLOT ] reordering for plots _________________________ # nolint
df_filter$cue_name[df_filter$cue == "high_cue"] <-
  "high cue"
df_filter$cue_name[df_filter$cue == "low_cue"] <-
  "low cue"

df_filter$stim_name[df_filter$stimulusintensity == "high_stim"] <-
  "High"
df_filter$stim_name[df_filter$stimulusintensity == "med_stim"] <-
  "Med"
df_filter$stim_name[df_filter$stimulusintensity == "low_stim"] <-
  "Low"

# DATA$levels_ordered <- factor(DATA$param_stimulus_type, levels=c("low", "med", "high"))

df_filter$stim_ordered <- factor(df_filter$stim_name,
                                   levels = c("Low", "Med", "High"))
df_filter$cue_ordered <- factor(df_filter$cue_name,
                                  levels = c("low cue", "high cue"))
model_iv1 <- "stim_ordered"
model_iv2 <- "cue_ordered"

#  [ PLOT ] calculate mean and se  _________________________
NPSstimcue_subjectwise <- meanSummary(df_filter,
                                      c(subject, model_iv1, model_iv2), dv)
NPSstimcue_groupwise <- summarySEwithin(
  data = NPSstimcue_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
NPSstimcue_groupwise$task <- taskname
# https://stackoverflow.com/questions/29402528/append-data-frames-together-in-a-for-loop/29419402

combined_se_calc_cooksd <-
  rbind(combined_se_calc_cooksd, NPSstimcue_groupwise)
# calculate mean and se
sub_mean <- "mean_per_sub"
group_mean <- "mean_per_sub_norm_mean"
se <- "se"
subject <- "sub"
ggtitle <- paste(taskname, " - NPS Cooksd removed")
title <- paste(taskname, " - NPS")
xlab <- ""
ylab <- "NPS (degree)"
ylim <- c(-10, 60)
dv_keyword <- "NPS"
if (any(startsWith(dv_keyword, c("expect", "Expect")))) {
  color <- c("#1B9E77", "#D95F02")
} else {
  color <- c("#4575B4", "#D73027")
} # if keyword starts with
plot_savefname <- file.path(
  analysis_dir,
  paste(
    "raincloud_task-", taskname, "_rating-", dv_keyword, "_", as.character(Sys.Date()), "_cooksd.png",
    sep = ""
  )
)
g <- plot_halfrainclouds_twofactor(
  NPSstimcue_subjectwise,
  NPSstimcue_groupwise,
  model_iv1,
  model_iv2,
  sub_mean,
  group_mean,
  se,
  subject,
  ggtitle,
  title,
  xlab,
  ylab,
  taskname,
  ylim,
  w,
  h,
  dv_keyword,
  color,
  plot_savefname
)
g
```

### Lineplots with only low cue {.unlisted .unnumbered}

```{r echo=FALSE, warning=FALSE}
subsetNPS <- NPSstimcue_groupwise[NPSstimcue_groupwise$cue_ordered == "low cue",]
g <- plot_lineplot_twofactor_subset(subsetNPS, taskname = "pain",
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("low cue" = "#5D5C5C", "#D73027"), ggtitle = "Within pain task: NPS dotproducts as a function of stimulus intensity level and cue",
                        xlab = "Stimulus intensity", ylab = "NPS (dot product)")
g + theme(aspect.ratio=.8)
```

### Lineplots {.unlisted .unnumbered}

```{r echo=FALSE, warning=FALSE}
g <- plot_lineplot_twofactor_subset(NPSstimcue_groupwise, taskname = "pain",
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("low cue" = "#333333","high cue" = "#FEAE00"), 
                        ggtitle = "",
                        xlab = "Stimulus intensity", ylab = "NPS")
g <- g + theme(aspect.ratio=1,
          text = element_text(size = 18), # Default text size for the plot
          axis.title = element_text(size = 22, ), # Axis titles
          axis.text = element_text(size = 15), # Axis text (x and y)
          plot.title = element_text(size = 24, hjust = 0.5) # Plot title
          ) +
  # geom_line(size = 1) + # Adjust line thickness
  geom_point(size = 2)  # Adjust point size
  

#   print(arranged_plot)
  plot_filename = file.path(analysis_dir,
  paste('lineplot_task-all_rating-', dv_keyword,taskname, '.svg', sep = ""))

g

  ggsave(plot_filename, g, width = 8, height = 4, dpi=300)
  
```
# C. Check CANlab code (no smooth)
```{r}
nps_brainmask_fname = '/Volumes/spacetop_projects_cue/analysis/fmri/nilearn/deriv01_signature/rampup_plateau_brainmask/CANlab_applyNPS_singletrial_rampupplateau_nosmooth.csv'
analysis_folder <- "fmri_nps"
beh <- readr::read_tsv(file.path(main_dir, "data/beh/sub-all_task-all_events.tsv"))

nps_brainmask <- read.csv(nps_brainmask_fname, sep = ",")
nps_brainmask$singletrial_fname <- nps_brainmask$image_name
# intersect
# Assuming df1 and df2 are your data frames and 'key_column' is the name of your key column
df_merge <- inner_join(beh, nps_brainmask, by = "singletrial_fname")
df_merge$NPS <- df_merge$NPS_dot_product
df_merge$NPS <- df_merge$nps_value

df_merge <- df_merge %>%
  mutate(singletrial_fname = as.character(singletrial_fname)) %>%
  extract(singletrial_fname, into = c("sub", "ses", "run", "runtype", "event", "trial", "cuetype", "stimintensity"),
          regex = "^(sub-\\d+)_(ses-\\d+)_(run-\\d+)_runtype-(pain|vicarious|cognitive)_event-(cue|stimulus)_trial-(\\d+)_cuetype-(high|low)(?:_stimintensity-(high|med|low))?\\.nii.gz$",
          remove = FALSE)

# Adjust the dataframe to handle NA for missing stimintensity, if tidyr version doesn't support `fill`
df_merge$stimintensity[df_merge$stimintensity == ""] <- NA
```

```{r}
data <-df_merge[df_merge$runtype == "pain" ,]

# contrast code ________________________________________________________________
data$stim <- NA; data$STIM_linear <- NA; data$STIM_quadratic <- NA; 
data$CUE_high_gt_low <- NA;
data$SES_linear <- NA;data$SES_quadratic <- NA
data$stim[data$stimulusintensity == "low_stim"] <-  -0.5 # social influence task
data$stim[data$stimulusintensity == "med_stim"] <- 0 # no influence task
data$stim[data$stimulusintensity == "high_stim"] <-  0.5 # no influence task

data$STIM <- factor(data$stimulusintensity)

# contrast code 1 linear
data$STIM_linear[data$stimulusintensity == "low_stim"] <- -0.5
data$STIM_linear[data$stimulusintensity == "med_stim"] <- 0
data$STIM_linear[data$stimulusintensity == "high_stim"] <- 0.5

# contrast code 2 quadratic
data$STIM_quadratic[data$stimulusintensity == "low_stim"] <- -0.33
data$STIM_quadratic[data$stimulusintensity == "med_stim"] <- 0.66
data$STIM_quadratic[data$stimulusintensity == "high_stim"] <- -0.33

# social cude contrast
data$CUE_high_gt_low[data$cue == "low_cue"] <-  -0.5 # social influence task
data$CUE_high_gt_low[data$cue == "high_cue"] <-  0.5 # no influence task

data$EXPECT <- data$expectrating
data$OUTCOME <- data$outcomerating


data$SES_linear[data$ses == "ses-01"] <- -0.5
data$SES_linear[data$ses == "ses-03"] <- 0
data$SES_linear[data$ses == "ses-04"] <- 0.5

# contrast code 2 quadratic
data$SES_quadratic[data$ses == "ses-01"] <- -0.33
data$SES_quadratic[data$ses == "ses-03"] <- 0.66
data$SES_quadratic[data$ses == "ses-04"] <- -0.33

stim_con1 <- "STIM_linear"
stim_con2 <- "STIM_quadratic"
iv1 <- "CUE_high_gt_low"
dv <- "NPS"
dv_keyword <- "NPS"

# filter data __________________________________________________________________
# Make sure that each condition cell has adequate amount of trials

subjects_with_inadequate_data <- data %>%
  group_by(sub, CUE_high_gt_low, STIM_linear) %>% #SES_linear, 
  dplyr::summarise(count = n(), .groups = 'drop') %>%
  filter(count < 2) %>%
  distinct(sub) %>%
  pull(sub)
df_filter <- data %>%
  filter(!(sub %in% subjects_with_inadequate_data))

print(sprintf("after filtering out subjects that have less than 3 trials in cell, we have N=%d -> N=%d",length(unique(data$sub)), length(unique(df_filter$sub)) ))
```


  ## QC. check NPS distribution
```{r}
df_filter.NA <- df_filter %>% filter(!is.na(NPS))  # Remove NA values
head(df_filter.NA)
# Sort the data by median "outcome" in ascending order
sorted_data <- df_filter.NA %>%
  group_by(sub) %>%
  dplyr::summarize(median_nps = median(NPS, na.rm = TRUE)) %>%
  arrange(median_nps) %>%
  select(sub)

# Reorder the "subject" factor based on the sorted order
df_filter.NA$sub <- factor(df_filter.NA$sub, levels = sorted_data$sub)

# Create the ggplot
g <- ggplot(df_filter.NA, aes(x = sub, y = NPS, fill = sub)) +
  geom_boxplot(outlier.shape = NA, width = 1.2, position = position_dodge(2)) +  
  geom_jitter(width = .1, alpha = 0, size = 1) +
  labs(x = "Subject", y = "NPS") +
  theme_classic() +
  theme(legend.position = "none") +
  scale_x_discrete(breaks = NULL) 

# Convert ggplot object to a plotly object with hover information
g_plotly <- ggplotly(ggplot_largetext(g), tooltip = c("x", "y"))
g_plotly
```




#### Contrast weight table {.unlisted .unnumbered}
```{r echo=FALSE}
tab <- matrix(c(0, .5, -.5,
                .66, -.34, -.34), ncol=3, byrow=TRUE)
colnames(tab) <- c('pain','vicarious','cognitive')
rownames(tab) <- c('task_V_gt_C','task_P_gt_VC')
kableExtra::kable_styling(
  knitr::kable(
    tab, caption = "Contrast weights", "html"),
  "striped", position = "left", font_size = 15)
```


## 2. NPS ~ paintask: 2 cue x 3 stimulus_intensity
### Q. Within pain task, Does stimulus intenisty level and cue level significantly predict NPS dotproducts? {.unlisted .unnumbered}
# 03/10/2024
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
combined_se_calc_cooksd <- data.frame()
# combined_psig <- data.frame()
taskname = "pain"
ggtitle <- paste(taskname, " - NPS (degree)")
title <- paste(taskname, " - actual")
subject <- "sub"
w <- 10
h <- 6
# p.sig <- df_merge[df_merge$runtype == "pain" ,]

analysis_dir <-
  file.path(main_dir,
            "analysis",
            "mixedeffect",
            analysis_folder,
            as.character(Sys.Date())) # nolint
dir.create(analysis_dir,
           showWarnings = FALSE,
           recursive = TRUE)
savedir <- analysis_dir
# combined_psig <-
#   rbind(combined_psig, p.sig)


# lmer model __________________________________________________________________
model_savefname <- file.path(
  analysis_dir,
  paste(
    "lmer_task-",taskname,"_rating-",dv_keyword,"_",as.character(Sys.Date()),"_cooksd.txt",
    sep = ""
  )
)


# [ PLOT ] reordering for plots _________________________ # nolint
df_filter$cue_name[df_filter$cue == "high_cue"] <-
  "high cue"
df_filter$cue_name[df_filter$cue == "low_cue"] <-
  "low cue"

df_filter$stim_name[df_filter$stimulusintensity == "high_stim"] <-
  "High"
df_filter$stim_name[df_filter$stimulusintensity == "med_stim"] <-
  "Med"
df_filter$stim_name[df_filter$stimulusintensity == "low_stim"] <-
  "Low"

# DATA$levels_ordered <- factor(DATA$param_stimulus_type, levels=c("low", "med", "high"))

df_filter$stim_ordered <- factor(df_filter$stim_name,
                                   levels = c("Low", "Med", "High"))
df_filter$cue_ordered <- factor(df_filter$cue_name,
                                  levels = c("low cue", "high cue"))
model_iv1 <- "stim_ordered"
model_iv2 <- "cue_ordered"

#  [ PLOT ] calculate mean and se  _________________________
NPSstimcue_subjectwise <- meanSummary(df_filter,
                                      c(subject, model_iv1, model_iv2), dv)
NPSstimcue_groupwise <- summarySEwithin(
  data = NPSstimcue_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
NPSstimcue_groupwise$task <- taskname
# https://stackoverflow.com/questions/29402528/append-data-frames-together-in-a-for-loop/29419402

combined_se_calc_cooksd <-
  rbind(combined_se_calc_cooksd, NPSstimcue_groupwise)
# calculate mean and se
sub_mean <- "mean_per_sub"
group_mean <- "mean_per_sub_norm_mean"
se <- "se"
subject <- "sub"
ggtitle <- paste(taskname, " - NPS Cooksd removed")
title <- paste(taskname, " - NPS")
xlab <- ""
ylab <- "NPS (degree)"
ylim <- c(-10, 60)
dv_keyword <- "NPS"
if (any(startsWith(dv_keyword, c("expect", "Expect")))) {
  color <- c("#1B9E77", "#D95F02")
} else {
  color <- c("#4575B4", "#D73027")
} # if keyword starts with
plot_savefname <- file.path(
  analysis_dir,
  paste(
    "raincloud_task-", taskname, "_rating-", dv_keyword, "_", as.character(Sys.Date()), "_cooksd.png",
    sep = ""
  )
)
g <- plot_halfrainclouds_twofactor(
  NPSstimcue_subjectwise,
  NPSstimcue_groupwise,
  model_iv1,
  model_iv2,
  sub_mean,
  group_mean,
  se,
  subject,
  ggtitle,
  title,
  xlab,
  ylab,
  taskname,
  ylim,
  w,
  h,
  dv_keyword,
  color,
  plot_savefname
)
g
```

```{r}
model.nps <- lmer(NPS ~
                          CUE_high_gt_low*STIM_linear +
                          CUE_high_gt_low*STIM_quadratic +
                          (CUE_high_gt_low +STIM_linear  |
         sub), data = df_filter.NA,
         control = lmerControl(optimizer = "nmkbw")
                    )

summary(model.nps)
# CUE_high_gt_low+STIM+EXPECT_demean
sjPlot::tab_model(model.nps,
                  title = "Multilevel-modeling: \nlmer(NPS ~ CUE * STIM  + (CUE + STIM | sub), data = pvc)",
                  CSS = list(css.table = '+font-size: 12;'))
```


### Lineplots with only low cue {.unlisted .unnumbered}

```{r echo=FALSE, warning=FALSE}
subsetNPS <- NPSstimcue_groupwise[NPSstimcue_groupwise$cue_ordered == "low cue",]
g <- plot_lineplot_twofactor_subset(subsetNPS, taskname = "pain",
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("low cue" = "#5D5C5C", "#D73027"), ggtitle = "Within pain task: NPS dotproducts as a function of stimulus intensity level and cue",
                        xlab = "Stimulus intensity", ylab = "NPS (dot product)")
g + theme(aspect.ratio=.8)
```

### Lineplots {.unlisted .unnumbered}

```{r echo=FALSE, warning=FALSE}
g <- plot_lineplot_twofactor_subset(NPSstimcue_groupwise, taskname = "pain",
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("low cue" = "#3E61EC","high cue" = "#FF0000"), 
                        ggtitle = "",
                        xlab = "Stimulus intensity", ylab = "NPS")
g <- g + theme(aspect.ratio=1,
          text = element_text(size = 18), # Default text size for the plot
          axis.title = element_text(size = 22, ), # Axis titles
          axis.text = element_text(size = 15), # Axis text (x and y)
          plot.title = element_text(size = 24, hjust = 0.5) # Plot title
          ) +
  # geom_line(size = 1) + # Adjust line thickness
  geom_point(size = 2)  # Adjust point size
  

#   print(arranged_plot)
  plot_filename = file.path(analysis_dir,
  paste('lineplot_task-all_rating-', dv_keyword,taskname, '.svg', sep = ""))

g

  ggsave(plot_filename, g, width = 8, height = 4, dpi=300)
  
```



# D. Check CANlab code (smooth data)
```{r}
analysis_folder <- "fmri_nps"
beh <- readr::read_tsv(file.path(main_dir, "data/beh/sub-all_task-all_events.tsv"))
nps_brainmask_fname = '/Volumes/spacetop_projects_cue/analysis/fmri/nilearn/deriv01_signature/rampup_plateau_brainmask/CANlab_applyNPS_singletrial_rampupplateau.csv'
nps_singletrial_fname = '/Volumes/spacetop_projects_cue/analysis/fmri/nilearn/deriv01_signature/rampup_plateau_brainmask/list_of_test_files.csv'
nps_brainmask <- read.csv(nps_brainmask_fname, sep = ",")
nps_fname <- read.csv(nps_singletrial_fname, sep = ",")
nps_fname$singletrial_fname <-  basename(nps_fname$Filenames)

# nps_brainmask$singletrial_fname <- canlabnpsdf$filename
nps_brainmask$singletrial_fname <- nps_fname$singletrial_fname
# intersect
# Assuming df1 and df2 are your data frames and 'key_column' is the name of your key column
df_merge <- inner_join(beh, nps_brainmask, by = "singletrial_fname")


df_merge <- df_merge %>%
  # mutate(singletrial_fname = basename(Filenames))
  mutate(singletrial_fname = as.character(singletrial_fname)) %>%
  
  extract(singletrial_fname, into = c("sub", "ses", "run", "runtype", "event", "trial", "cuetype", "stimintensity"),
          regex = "^(sub-\\d+)_(ses-\\d+)_(run-\\d+)_runtype-(pain|vicarious|cognitive)_event-(cue|stimulus)_trial-(\\d+)_cuetype-(high|low)(?:_stimintensity-(high|med|low))?\\.nii.gz$",
          remove = FALSE)

# Adjust the dataframe to handle NA for missing stimintensity, if tidyr version doesn't support `fill`
df_merge$stimintensity[df_merge$stimintensity == ""] <- NA
```

```{r}
data <-df_merge[df_merge$runtype == "pain" ,]

# contrast code ________________________________________________________________
data$stim <- NA; data$STIM_linear <- NA; data$STIM_quadratic <- NA; 
data$CUE_high_gt_low <- NA;
data$SES_linear <- NA;data$SES_quadratic <- NA
data$stim[data$stimulusintensity == "low_stim"] <-  -0.5 # social influence task
data$stim[data$stimulusintensity == "med_stim"] <- 0 # no influence task
data$stim[data$stimulusintensity == "high_stim"] <-  0.5 # no influence task

data$STIM <- factor(data$stimulusintensity)

# contrast code 1 linear
data$STIM_linear[data$stimulusintensity == "low_stim"] <- -0.5
data$STIM_linear[data$stimulusintensity == "med_stim"] <- 0
data$STIM_linear[data$stimulusintensity == "high_stim"] <- 0.5

# contrast code 2 quadratic
data$STIM_quadratic[data$stimulusintensity == "low_stim"] <- -0.33
data$STIM_quadratic[data$stimulusintensity == "med_stim"] <- 0.66
data$STIM_quadratic[data$stimulusintensity == "high_stim"] <- -0.33

# social cude contrast
data$CUE_high_gt_low[data$cue == "low_cue"] <-  -0.5 # social influence task
data$CUE_high_gt_low[data$cue == "high_cue"] <-  0.5 # no influence task

data$EXPECT <- data$expectrating
data$OUTCOME <- data$outcomerating


data$SES_linear[data$ses == "ses-01"] <- -0.5
data$SES_linear[data$ses == "ses-03"] <- 0
data$SES_linear[data$ses == "ses-04"] <- 0.5

# contrast code 2 quadratic
data$SES_quadratic[data$ses == "ses-01"] <- -0.33
data$SES_quadratic[data$ses == "ses-03"] <- 0.66
data$SES_quadratic[data$ses == "ses-04"] <- -0.33

stim_con1 <- "STIM_linear"
stim_con2 <- "STIM_quadratic"
iv1 <- "CUE_high_gt_low"
dv <- "NPS"
dv_keyword <- "NPS"

# filter data __________________________________________________________________
# Make sure that each condition cell has adequate amount of trials

subjects_with_inadequate_data <- data %>%
  group_by(sub, CUE_high_gt_low, STIM_linear) %>% #SES_linear, 
  dplyr::summarise(count = n(), .groups = 'drop') %>%
  filter(count < 2) %>%
  distinct(sub) %>%
  pull(sub)
df_filter <- data %>%
  filter(!(sub %in% subjects_with_inadequate_data))

print(sprintf("after filtering out subjects that have less than 3 trials in cell, we have N=%d -> N=%d",length(unique(data$sub)), length(unique(df_filter$sub)) ))



```


  ## QC. check NPS distribution
```{r}
df_filter.NA <- df_filter %>% filter(!is.na(NPS))  # Remove NA values
head(df_filter.NA)
# Sort the data by median "outcome" in ascending order
sorted_data <- df_filter.NA %>%
  group_by(sub) %>%
  dplyr::summarize(median_nps = median(NPS, na.rm = TRUE)) %>%
  arrange(median_nps) %>%
  select(sub)

# Reorder the "subject" factor based on the sorted order
df_filter.NA$sub <- factor(df_filter.NA$sub, levels = sorted_data$sub)

# Create the ggplot
g <- ggplot(df_filter.NA, aes(x = sub, y = NPS, fill = sub)) +
  geom_boxplot(outlier.shape = NA, width = 1.2, position = position_dodge(2)) +  
  geom_jitter(width = .1, alpha = 0, size = 1) +
  labs(x = "Subject", y = "NPS") +
  theme_classic() +
  theme(legend.position = "none") +
  scale_x_discrete(breaks = NULL) 

# Convert ggplot object to a plotly object with hover information
g_plotly <- ggplotly(ggplot_largetext(g), tooltip = c("x", "y"))
g_plotly
```




#### Contrast weight table {.unlisted .unnumbered}
```{r echo=FALSE}
tab <- matrix(c(0, .5, -.5,
                .66, -.34, -.34), ncol=3, byrow=TRUE)
colnames(tab) <- c('pain','vicarious','cognitive')
rownames(tab) <- c('task_V_gt_C','task_P_gt_VC')
kableExtra::kable_styling(
  knitr::kable(
    tab, caption = "Contrast weights", "html"),
  "striped", position = "left", font_size = 15)
```


## 2. NPS ~ paintask: 2 cue x 3 stimulus_intensity
### Q. Within pain task, Does stimulus intenisty level and cue level significantly predict NPS dotproducts? {.unlisted .unnumbered}
# 03/10/2024
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}



combined_se_calc_cooksd <- data.frame()
# combined_psig <- data.frame()
taskname = "pain"
ggtitle <- paste(taskname, " - NPS (degree)")
title <- paste(taskname, " - actual")
subject <- "sub"
w <- 10
h <- 6
# p.sig <- df_merge[df_merge$runtype == "pain" ,]


analysis_dir <-
  file.path(main_dir,
            "analysis",
            "mixedeffect",
            analysis_folder,
            as.character(Sys.Date())) # nolint
dir.create(analysis_dir,
           showWarnings = FALSE,
           recursive = TRUE)
savedir <- analysis_dir
# combined_psig <-
#   rbind(combined_psig, p.sig)


# lmer model __________________________________________________________________
model_savefname <- file.path(
  analysis_dir,
  paste(
    "lmer_task-",taskname,"_rating-",dv_keyword,"_",as.character(Sys.Date()),"_cooksd.txt",
    sep = ""
  )
)
df_filter <- df_filter %>%
    group_by(sub) %>%
    mutate(NPS_scaled = scale(NPS)) %>%
    ungroup()
dv <- "dACC"
# [ PLOT ] reordering for plots _________________________ # nolint
df_filter$cue_name[df_filter$cue == "high_cue"] <-
  "high cue"
df_filter$cue_name[df_filter$cue == "low_cue"] <-
  "low cue"

df_filter$stim_name[df_filter$stimulusintensity == "high_stim"] <-
  "High"
df_filter$stim_name[df_filter$stimulusintensity == "med_stim"] <-
  "Med"
df_filter$stim_name[df_filter$stimulusintensity == "low_stim"] <-
  "Low"

# DATA$levels_ordered <- factor(DATA$param_stimulus_type, levels=c("low", "med", "high"))

df_filter$stim_ordered <- factor(df_filter$stim_name,
                                   levels = c("Low", "Med", "High"))
df_filter$cue_ordered <- factor(df_filter$cue_name,
                                  levels = c("low cue", "high cue"))
model_iv1 <- "stim_ordered"
model_iv2 <- "cue_ordered"

#  [ PLOT ] calculate mean and se  _________________________
NPSstimcue_subjectwise <- meanSummary(df_filter,
                                      c(subject, model_iv1, model_iv2), dv)
NPSstimcue_groupwise <- summarySEwithin(
  data = NPSstimcue_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
NPSstimcue_groupwise$task <- taskname
# https://stackoverflow.com/questions/29402528/append-data-frames-together-in-a-for-loop/29419402

combined_se_calc_cooksd <-
  rbind(combined_se_calc_cooksd, NPSstimcue_groupwise)
# calculate mean and se
sub_mean <- "mean_per_sub"
group_mean <- "mean_per_sub_norm_mean"
se <- "se"
subject <- "sub"
ggtitle <- paste(taskname, " - NPS Cooksd removed")
title <- paste(taskname, " - NPS")
xlab <- ""
ylab <- "NPS (degree)"
ylim <- c(-1,1)
dv_keyword <- "NPS"
if (any(startsWith(dv_keyword, c("expect", "Expect")))) {
  color <- c("#1B9E77", "#D95F02")
} else {
  color <- c("#4575B4", "#D73027")
} # if keyword starts with
plot_savefname <- file.path(
  analysis_dir,
  paste(
    "raincloud_task-", taskname, "_rating-", dv_keyword, "_", as.character(Sys.Date()), "_cooksd.png",
    sep = ""
  )
)
g <- plot_halfrainclouds_twofactor(
  NPSstimcue_subjectwise,
  NPSstimcue_groupwise,
  model_iv1,
  model_iv2,
  sub_mean,
  group_mean,
  se,
  subject,
  ggtitle,
  title,
  xlab,
  ylab,
  taskname,
  ylim,
  w,
  h,
  dv_keyword,
  color,
  plot_savefname
)
g

model.npscuestim <- lmer(dACC ~
                          CUE_high_gt_low* STIM_linear + CUE_high_gt_low* STIM_quadratic +  
                          (CUE_high_gt_low + STIM_linear|sub), data = df_filter, 
                         control = lmerControl(optimizer = "nmkbw")
                    )


summary(model.npscuestim)
sjPlot::tab_model(model.npscuestim,
                  title = "Multilevel-modeling: \nlmer(NPS ~ CUE*STIM + (CUE*STIM | sub), data = pvc)",
                  CSS = list(css.table = '+font-size: 12;'))
```

### Lineplots with only low cue {.unlisted .unnumbered}

```{r echo=FALSE, warning=FALSE}
subsetNPS <- NPSstimcue_groupwise[NPSstimcue_groupwise$cue_ordered == "low cue",]
g <- plot_lineplot_twofactor_subset(subsetNPS, taskname = "pain",
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("low cue" = "#5D5C5C", "#D73027"), ggtitle = "Within pain task: NPS dotproducts as a function of stimulus intensity level and cue",
                        xlab = "Stimulus intensity", ylab = "NPS (dot product)")
g + theme(aspect.ratio=.8)
```

### Lineplots {.unlisted .unnumbered}

```{r echo=FALSE, warning=FALSE}
g <- plot_lineplot_twofactor_subset(NPSstimcue_groupwise, taskname = "pain",
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("low cue" = "#3E61EC","high cue" = "#FF0000"), 
                        ggtitle = "",
                        xlab = "Stimulus intensity", ylab = "NPS")
g <- g + theme(aspect.ratio=1,
          text = element_text(size = 18), # Default text size for the plot
          axis.title = element_text(size = 22, ), # Axis titles
          axis.text = element_text(size = 15), # Axis text (x and y)
          plot.title = element_text(size = 24, hjust = 0.5) # Plot title
          ) +
  # geom_line(size = 1) + # Adjust line thickness
  geom_point(size = 2)  # Adjust point size
  

#   print(arranged_plot)
  plot_filename = file.path(analysis_dir,
  paste('lineplot_task-all_rating-', dv_keyword,taskname, '.svg', sep = ""))

g

  ggsave(plot_filename, g, width = 8, height = 4, dpi=300)
  
```
# D. canlab forloop
```{r}
library(lme4)
library(dplyr)
library(ggplot2)
library(lmerTest)  # For p-values and summary stats
library(sjPlot)

# Assuming you have predefined your main_dir and analysis_folder
analysis_dir <- file.path(main_dir, "analysis", "mixedeffect", analysis_folder, as.character(Sys.Date()))
dir.create(analysis_dir, showWarnings = FALSE, recursive = TRUE)

# Example list of dependent variables
dependent_vars <- c("NPS","vermis","rIns","rV1","rThal","lIns","rdpIns","rS2_Op","dACC","rLOC","lLOC","rpLOC","pgACC","lSTS","rIPL","PCC"  )  # Update this with your actual DVs

# Initialize a DataFrame to collect combined results
combined_se_calc_cooksd <- data.frame()

for (dv in dependent_vars) {
    # Scale the dependent variable within each subject
  NPSstimcue_subjectwise <- data.frame()
    NPSstimcue_groupwise <- data.frame()

    # Define the formula dynamically
    formula_string <- paste(dv, "~ CUE_high_gt_low * STIM_linear + CUE_high_gt_low * STIM_quadratic + (CUE_high_gt_low + STIM_linear | sub)")
    model_formula <- as.formula(formula_string)
    model_savefname <- file.path(analysis_dir, paste("lmer_task-", taskname, "_rating-", dv, "_", Sys.Date(), "_cooksd.txt", sep = ""))
    # Fit the model
    sink(model_savefname)
    model.npscuestim <- lmer(model_formula, data = df_filter.NA, control = lmerControl(optimizer = "nmkbw"))
    print(summary(model.npscuestim))
    sink()

    # [ PLOT ] reordering for plots _________________________ # nolint
    df_filter.NA$cue_name[df_filter.NA$cue == "high_cue"] <-
      "high cue"
    df_filter.NA$cue_name[df_filter.NA$cue == "low_cue"] <-
      "low cue"
    
    df_filter.NA$stim_name[df_filter.NA$stimulusintensity == "high_stim"] <-
      "High"
    df_filter.NA$stim_name[df_filter.NA$stimulusintensity == "med_stim"] <-
      "Med"
    df_filter.NA$stim_name[df_filter.NA$stimulusintensity == "low_stim"] <-
      "Low"
    
    # DATA$levels_ordered <- factor(DATA$param_stimulus_type, levels=c("low", "med", "high"))
    
    df_filter.NA$stim_ordered <- factor(df_filter.NA$stim_name,
                                       levels = c("Low", "Med", "High"))
    df_filter.NA$cue_ordered <- factor(df_filter.NA$cue_name,
                                      levels = c("low cue", "high cue"))
    model_iv1 <- "stim_ordered"
    model_iv2 <- "cue_ordered"
    # Calculate means and SE within subject for plotting

    NPSstimcue_subjectwise <- meanSummary(df_filter.NA,
                                          c(subject, model_iv1, model_iv2), dv)
    NPSstimcue_groupwise <- summarySEwithin(
      data = NPSstimcue_subjectwise,
      measurevar = "mean_per_sub",
      withinvars = c(model_iv1, model_iv2),
      idvar = subject
    )
    NPSstimcue_groupwise$ROI <- dv
    # Append to the combined results
    # combined_se_calc_cooksd <- rbind(combined_se_calc_cooksd, NPSstimcue_groupwise)
sub_mean <- "mean_per_sub"
group_mean <- "mean_per_sub_norm_mean"
se <- "se"
subject <- "sub"
ggtitle <- paste(taskname, " - NPS Cooksd removed")
title <- paste(taskname, " - NPS")
xlab <- ""
ylab <- "NPS (degree)"
ylim <- c(-1,1)
dv_keyword <- dv
    # Save the plot
    # plot_savefname <- file.path(analysis_dir, paste("raincloud_task-", taskname, "_rating-", dv, "_", Sys.Date(), ".svg", sep = ""))
    # g <- plot_halfrainclouds_twofactor(
    #   NPSstimcue_subjectwise,
    #   NPSstimcue_groupwise,
    #   model_iv1,
    #   model_iv2,
    #   sub_mean,
    #   group_mean,
    #   se,
    #   subject,
    #   ggtitle,
    #   title,
    #   xlab,
    #   ylab,
    #   taskname,
    #   ylim,
    #   w,
    #   h,
    #   dv_keyword,
    #   color,
    #   plot_savefname
    # )
    # g
    # ggsave(plot_savefname, plot = g, width = w, height = h)

g <- plot_lineplot_twofactor_subset(NPSstimcue_groupwise, taskname = "pain",
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("low cue" = "#3E61EC","high cue" = "#FF0000"), 
                        ggtitle = dv,
                        xlab = "Stimulus intensity", ylab = "Mean score")
g <- g + theme(aspect.ratio=1,
          text = element_text(size = 18), # Default text size for the plot
          axis.title = element_text(size = 22, ), # Axis titles
          axis.text = element_text(size = 15), # Axis text (x and y)
          plot.title = element_text(size = 24, hjust = 0.5) # Plot title
          ) +
  geom_line(size = 1) + # Adjust line thickness
  geom_point(size = 2)  # Adjust point size
  

#   print(arranged_plot)
  plot_filename = file.path(analysis_dir,
  paste('lineplot_task-all_rating-', dv_keyword,taskname, '.svg', sep = ""))

g

  ggsave(plot_filename, g, width = 8, height = 4, dpi=300)
}

# Optionally return the combined dataframe
combined_se_calc_cooksd

```


# F. check HJ resample resolution code

```{r}
analysis_folder <- "fmri_nps"
beh <- readr::read_tsv(file.path(main_dir, "data/beh/sub-all_task-all_events.tsv"))
nps_brainmask_fname = '/Volumes/spacetop_projects_cue/analysis/fmri/nilearn/deriv01_signature/rampup_plateau_brainmask/CANlab_applyNPS_singletrial_rampupplateau.csv'
nps_singletrial_fname = '/Volumes/spacetop_projects_cue/analysis/fmri/nilearn/deriv01_signature/rampup_plateau_brainmask/list_of_test_files.csv'
nps_brainmask <- read.csv(nps_brainmask_fname, sep = ",")
nps_fname <- read.csv(nps_singletrial_fname, sep = ",")
nps_fname$singletrial_fname <-  basename(nps_fname$Filenames)

# nps_brainmask$singletrial_fname <- canlabnpsdf$filename
nps_brainmask$singletrial_fname <- nps_fname$singletrial_fname
# intersect
# Assuming df1 and df2 are your data frames and 'key_column' is the name of your key column
df_merge <- inner_join(beh, nps_brainmask, by = "singletrial_fname")


df_merge <- df_merge %>%
  # mutate(singletrial_fname = basename(Filenames))
  mutate(singletrial_fname = as.character(singletrial_fname)) %>%
  
  extract(singletrial_fname, into = c("sub", "ses", "run", "runtype", "event", "trial", "cuetype", "stimintensity"),
          regex = "^(sub-\\d+)_(ses-\\d+)_(run-\\d+)_runtype-(pain|vicarious|cognitive)_event-(cue|stimulus)_trial-(\\d+)_cuetype-(high|low)(?:_stimintensity-(high|med|low))?\\.nii.gz$",
          remove = FALSE)

# Adjust the dataframe to handle NA for missing stimintensity, if tidyr version doesn't support `fill`
df_merge$stimintensity[df_merge$stimintensity == ""] <- NA

data <-df_merge[df_merge$runtype == "pain" ,]

# contrast code ________________________________________________________________
data$stim <- NA; data$STIM_linear <- NA; data$STIM_quadratic <- NA; 
data$CUE_high_gt_low <- NA;
data$SES_linear <- NA;data$SES_quadratic <- NA
data$stim[data$stimulusintensity == "low_stim"] <-  -0.5 # social influence task
data$stim[data$stimulusintensity == "med_stim"] <- 0 # no influence task
data$stim[data$stimulusintensity == "high_stim"] <-  0.5 # no influence task

data$STIM <- factor(data$stimulusintensity)

# contrast code 1 linear
data$STIM_linear[data$stimulusintensity == "low_stim"] <- -0.5
data$STIM_linear[data$stimulusintensity == "med_stim"] <- 0
data$STIM_linear[data$stimulusintensity == "high_stim"] <- 0.5

# contrast code 2 quadratic
data$STIM_quadratic[data$stimulusintensity == "low_stim"] <- -0.33
data$STIM_quadratic[data$stimulusintensity == "med_stim"] <- 0.66
data$STIM_quadratic[data$stimulusintensity == "high_stim"] <- -0.33

# social cude contrast
data$CUE_high_gt_low[data$cue == "low_cue"] <-  -0.5 # social influence task
data$CUE_high_gt_low[data$cue == "high_cue"] <-  0.5 # no influence task

data$EXPECT <- data$expectrating
data$OUTCOME <- data$outcomerating


data$SES_linear[data$ses == "ses-01"] <- -0.5
data$SES_linear[data$ses == "ses-03"] <- 0
data$SES_linear[data$ses == "ses-04"] <- 0.5

# contrast code 2 quadratic
data$SES_quadratic[data$ses == "ses-01"] <- -0.33
data$SES_quadratic[data$ses == "ses-03"] <- 0.66
data$SES_quadratic[data$ses == "ses-04"] <- -0.33

stim_con1 <- "STIM_linear"
stim_con2 <- "STIM_quadratic"
iv1 <- "CUE_high_gt_low"
dv <- "NPS"
dv_keyword <- "NPS"

# filter data __________________________________________________________________
# Make sure that each condition cell has adequate amount of trials

subjects_with_inadequate_data <- data %>%
  group_by(sub, CUE_high_gt_low, STIM_linear) %>% #SES_linear, 
  dplyr::summarise(count = n(), .groups = 'drop') %>%
  filter(count < 2) %>%
  distinct(sub) %>%
  pull(sub)
df_filter <- data %>%
  filter(!(sub %in% subjects_with_inadequate_data))

print(sprintf("after filtering out subjects that have less than 3 trials in cell, we have N=%d -> N=%d",length(unique(data$sub)), length(unique(df_filter$sub)) ))

## QC. check NPS distribution __________________________________________________________________

df_filter.NA <- df_filter %>% filter(!is.na(NPS))  # Remove NA values
head(df_filter.NA)
# Sort the data by median "outcome" in ascending order
sorted_data <- df_filter.NA %>%
  group_by(sub) %>%
  dplyr::summarize(median_nps = median(NPS, na.rm = TRUE)) %>%
  arrange(median_nps) %>%
  select(sub)

# Reorder the "subject" factor based on the sorted order
df_filter.NA$sub <- factor(df_filter.NA$sub, levels = sorted_data$sub)

# Create the ggplot
g <- ggplot(df_filter.NA, aes(x = sub, y = NPS, fill = sub)) +
  geom_boxplot(outlier.shape = NA, width = 1.2, position = position_dodge(2)) +  
  geom_jitter(width = .1, alpha = 0, size = 1) +
  labs(x = "Subject", y = "NPS") +
  theme_classic() +
  theme(legend.position = "none") +
  scale_x_discrete(breaks = NULL) 

# Convert ggplot object to a plotly object with hover information
g_plotly <- ggplotly(ggplot_largetext(g), tooltip = c("x", "y"))
g_plotly



combined_se_calc_cooksd <- data.frame()
# combined_psig <- data.frame()
taskname = "pain"
ggtitle <- paste(taskname, " - NPS (degree)")
title <- paste(taskname, " - actual")
subject <- "sub"
w <- 10
h <- 6
# p.sig <- df_merge[df_merge$runtype == "pain" ,]


analysis_dir <-
  file.path(main_dir,
            "analysis",
            "mixedeffect",
            analysis_folder,
            as.character(Sys.Date())) # nolint
dir.create(analysis_dir,
           showWarnings = FALSE,
           recursive = TRUE)
savedir <- analysis_dir
# combined_psig <-
#   rbind(combined_psig, p.sig)


# lmer model __________________________________________________________________
model_savefname <- file.path(
  analysis_dir,
  paste(
    "lmer_task-",taskname,"_rating-",dv_keyword,"_",as.character(Sys.Date()),"_cooksd.txt",
    sep = ""
  )
)
df_filter <- df_filter %>%
    group_by(sub) %>%
    mutate(NPS_scaled = scale(NPS)) %>%
    ungroup()
dv <- "dACC"
# [ PLOT ] reordering for plots _________________________ # nolint
df_filter$cue_name[df_filter$cue == "high_cue"] <-
  "high cue"
df_filter$cue_name[df_filter$cue == "low_cue"] <-
  "low cue"

df_filter$stim_name[df_filter$stimulusintensity == "high_stim"] <-
  "High"
df_filter$stim_name[df_filter$stimulusintensity == "med_stim"] <-
  "Med"
df_filter$stim_name[df_filter$stimulusintensity == "low_stim"] <-
  "Low"

# DATA$levels_ordered <- factor(DATA$param_stimulus_type, levels=c("low", "med", "high"))

df_filter$stim_ordered <- factor(df_filter$stim_name,
                                   levels = c("Low", "Med", "High"))
df_filter$cue_ordered <- factor(df_filter$cue_name,
                                  levels = c("low cue", "high cue"))
model_iv1 <- "stim_ordered"
model_iv2 <- "cue_ordered"

#  [ PLOT ] calculate mean and se  _________________________
NPSstimcue_subjectwise <- meanSummary(df_filter,
                                      c(subject, model_iv1, model_iv2), dv)
NPSstimcue_groupwise <- summarySEwithin(
  data = NPSstimcue_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
NPSstimcue_groupwise$task <- taskname
# https://stackoverflow.com/questions/29402528/append-data-frames-together-in-a-for-loop/29419402

combined_se_calc_cooksd <-
  rbind(combined_se_calc_cooksd, NPSstimcue_groupwise)
# calculate mean and se
sub_mean <- "mean_per_sub"
group_mean <- "mean_per_sub_norm_mean"
se <- "se"
subject <- "sub"
ggtitle <- paste(taskname, " - NPS Cooksd removed")
title <- paste(taskname, " - NPS")
xlab <- ""
ylab <- "NPS (degree)"
ylim <- c(-1,1)
dv_keyword <- "NPS"
if (any(startsWith(dv_keyword, c("expect", "Expect")))) {
  color <- c("#1B9E77", "#D95F02")
} else {
  color <- c("#4575B4", "#D73027")
} # if keyword starts with
plot_savefname <- file.path(
  analysis_dir,
  paste(
    "raincloud_task-", taskname, "_rating-", dv_keyword, "_", as.character(Sys.Date()), "_cooksd.png",
    sep = ""
  )
)
g <- plot_halfrainclouds_twofactor(
  NPSstimcue_subjectwise,
  NPSstimcue_groupwise,
  model_iv1,
  model_iv2,
  sub_mean,
  group_mean,
  se,
  subject,
  ggtitle,
  title,
  xlab,
  ylab,
  taskname,
  ylim,
  w,
  h,
  dv_keyword,
  color,
  plot_savefname
)
g

model.npscuestim <- lmer(dACC ~
                          CUE_high_gt_low* STIM_linear + CUE_high_gt_low* STIM_quadratic +  
                          (CUE_high_gt_low + STIM_linear|sub), data = df_filter, 
                         control = lmerControl(optimizer = "nmkbw")
                    )


summary(model.npscuestim)
sjPlot::tab_model(model.npscuestim,
                  title = "Multilevel-modeling: \nlmer(NPS ~ CUE*STIM + (CUE*STIM | sub), data = pvc)",
                  CSS = list(css.table = '+font-size: 12;'))


### Lineplots with only low cue {.unlisted .unnumbered}
subsetNPS <- NPSstimcue_groupwise[NPSstimcue_groupwise$cue_ordered == "low cue",]
g <- plot_lineplot_twofactor_subset(subsetNPS, taskname = "pain",
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("low cue" = "#5D5C5C", "#D73027"), ggtitle = "Within pain task: NPS dotproducts as a function of stimulus intensity level and cue",
                        xlab = "Stimulus intensity", ylab = "NPS (dot product)")
g + theme(aspect.ratio=.8)


### Lineplots {.unlisted .unnumbered}
g <- plot_lineplot_twofactor_subset(NPSstimcue_groupwise, taskname = "pain",
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("low cue" = "#3E61EC","high cue" = "#FF0000"), 
                        ggtitle = "",
                        xlab = "Stimulus intensity", ylab = "NPS")
g <- g + theme(aspect.ratio=1,
          text = element_text(size = 18), # Default text size for the plot
          axis.title = element_text(size = 22, ), # Axis titles
          axis.text = element_text(size = 15), # Axis text (x and y)
          plot.title = element_text(size = 24, hjust = 0.5) # Plot title
          ) +
  # geom_line(size = 1) + # Adjust line thickness
  geom_point(size = 2)  # Adjust point size
  

#   print(arranged_plot)
  plot_filename = file.path(analysis_dir,
  paste('lineplot_task-all_rating-', dv_keyword,taskname, '.svg', sep = ""))

g

  ggsave(plot_filename, g, width = 8, height = 4, dpi=300)
  
```



# F. check CANLAB extract ROI
## F-1. load data
```{r}
analysis_folder <- "fmri_nps_canlab"
beh <- readr::read_tsv(file.path(main_dir, "data/beh/sub-all_task-all_events.tsv"))
dv <- "nps"
base_dir <- "/Volumes/spacetop_projects_cue/analysis/fmri/nilearn/deriv01_signature/rampup_plateau_canlab"
analysis_folder <- "fmri_npsroi"
# List all CSV files matching the pattern
file_paths <- list.files(base_dir, pattern =  "sub-.*_signature-NPSroi_.*\\.csv$", full.names = TRUE, recursive = TRUE)


# Read and stack the CSV files
all_data <- file_paths %>% 
  map_dfr(~read_csv(.x, show_col_types = FALSE), .id = "file_path")


# nps_brainmask_fname = '/Volumes/spacetop_projects_cue/analysis/fmri/nilearn/deriv01_signature/rampup_plateau_brainmask/CANlab_applyNPS_singletrial_rampupplateau.csv'
# nps_singletrial_fname = '/Volumes/spacetop_projects_cue/analysis/fmri/nilearn/deriv01_signature/rampup_plateau_brainmask/list_of_test_files.csv'
# nps_brainmask <- read.csv(nps_brainmask_fname, sep = ",")
# nps_fname <- read.csv(nps_singletrial_fname, sep = ",")
# nps_fname$singletrial_fname <-  basename(nps_fname$Filenames)

# nps_brainmask$singletrial_fname <- canlabnpsdf$filename
# nps_brainmask$singletrial_fname <- nps_fname$singletrial_fname
# intersect
# Assuming df1 and df2 are your data frames and 'key_column' is the name of your key column
df_merge <- inner_join(beh, all_data, by = "singletrial_fname")


df_merge <- df_merge %>%
  # mutate(singletrial_fname = basename(Filenames))
  mutate(singletrial_fname = as.character(singletrial_fname)) %>%
  
  extract(singletrial_fname, into = c("sub", "ses", "run", "runtype", "event", "trial", "cuetype", "stimintensity"),
          regex = "^(sub-\\d+)_(ses-\\d+)_(run-\\d+)_runtype-(pain|vicarious|cognitive)_event-(cue|stimulus)_trial-(\\d+)_cuetype-(high|low)(?:_stimintensity-(high|med|low))?\\.nii.gz$",
          remove = FALSE)

# Adjust the dataframe to handle NA for missing stimintensity, if tidyr version doesn't support `fill`
df_merge$stimintensity[df_merge$stimintensity == ""] <- NA

data <-df_merge[df_merge$runtype == "pain" ,]

# contrast code ________________________________________________________________
data$stim <- NA; data$STIM_linear <- NA; data$STIM_quadratic <- NA; 
data$CUE_high_gt_low <- NA;
data$SES_linear <- NA;data$SES_quadratic <- NA
data$stim[data$stimulusintensity == "low_stim"] <-  -0.5 # social influence task
data$stim[data$stimulusintensity == "med_stim"] <- 0 # no influence task
data$stim[data$stimulusintensity == "high_stim"] <-  0.5 # no influence task

data$STIM <- factor(data$stimulusintensity)

# contrast code 1 linear
data$STIM_linear[data$stimulusintensity == "low_stim"] <- -0.5
data$STIM_linear[data$stimulusintensity == "med_stim"] <- 0
data$STIM_linear[data$stimulusintensity == "high_stim"] <- 0.5

# contrast code 2 quadratic
data$STIM_quadratic[data$stimulusintensity == "low_stim"] <- -0.33
data$STIM_quadratic[data$stimulusintensity == "med_stim"] <- 0.66
data$STIM_quadratic[data$stimulusintensity == "high_stim"] <- -0.33

# social cude contrast
data$CUE_high_gt_low[data$cue == "low_cue"] <-  -0.5 # social influence task
data$CUE_high_gt_low[data$cue == "high_cue"] <-  0.5 # no influence task

data$EXPECT <- data$expectrating
data$OUTCOME <- data$outcomerating


data$SES_linear[data$ses == "ses-01"] <- -0.5
data$SES_linear[data$ses == "ses-03"] <- 0
data$SES_linear[data$ses == "ses-04"] <- 0.5

# contrast code 2 quadratic
data$SES_quadratic[data$ses == "ses-01"] <- -0.33
data$SES_quadratic[data$ses == "ses-03"] <- 0.66
data$SES_quadratic[data$ses == "ses-04"] <- -0.33

stim_con1 <- "STIM_linear"
stim_con2 <- "STIM_quadratic"
iv1 <- "CUE_high_gt_low"
dv <- "nps"
dv_keyword <- "NPS"
```

## F-2. Filter data and plot
```{r}
# filter data __________________________________________________________________
# Make sure that each condition cell has adequate amount of trials
dependent_vars <- c("nps","npspos","npsneg", 
                    "pos_nps_vermis","pos_nps_rIns","pos_nps_rV1","pos_nps_rThal",
                    "pos_nps_lIns","pos_nps_rdpIns","pos_nps_rS2_Op","pos_nps_dACC",
                    "neg_nps_rLOC","neg_nps_lLOC","neg_nps_rpLOC","neg_nps_pgACC","neg_nps_lSTS","neg_nps_rIPL","neg_nps_PCC"  )  # Update this with your actual DVs
newlist <- c("NPS","NPS positive weights","NPS negative weights", 
                    "Vermis","rIns","rV1","rThal",
                    "lIns","rdpIns","rS2 & Op","dACC",
                    "neg_nps_rLOC","neg_nps_lLOC","rpLOC","pgACC","lSTS","rIPL","PCC"  )  # Update this with your actual DVs

# Initialize a DataFrame to collect combined results
combined_se_calc_cooksd <- data.frame()
for (i in seq_along(dependent_vars)) {
  dv <- dependent_vars[i]
  dv_title <- newlist[i]
# for (dv in dependent_vars) {
subjects_with_inadequate_data <- data %>%
  group_by(sub, CUE_high_gt_low, STIM_linear) %>% #SES_linear, 
  dplyr::summarise(count = n(), .groups = 'drop') %>%
  filter(count < 3) %>%
  distinct(sub) %>%
  pull(sub)
df_filter <- data %>%
  filter(!(sub %in% subjects_with_inadequate_data))

print(sprintf("after filtering out subjects that have less than 3 trials in cell, we have N=%d -> N=%d",length(unique(data$sub)), length(unique(df_filter$sub)) ))

## QC. check NPS distribution __________________________________________________________________

df_filter.NA <- df_filter %>% filter(!is.na(nps))  # Remove NA values
head(df_filter.NA)


combined_se_calc_cooksd <- data.frame()
taskname = "pain"
ggtitle <- paste(taskname, " - NPS (degree)")
title <- paste(taskname, " - actual")
subject <- "sub"
w <- 10
h <- 6


analysis_dir <-
  file.path(main_dir,
            "analysis",
            "mixedeffect",
            analysis_folder,
            as.character(Sys.Date())) # nolint
dir.create(analysis_dir,
           showWarnings = FALSE,
           recursive = TRUE)
savedir <- analysis_dir



df_filter.NA <- df_filter.NA %>%
    group_by(sub) %>%
    mutate(NPS_scaled = scale(nps)) %>%
    ungroup()

# [ PLOT ] reordering for plots _________________________ # nolint
df_filter.NA$cue_name[df_filter.NA$cue == "high_cue"] <-  "high cue"
df_filter.NA$cue_name[df_filter.NA$cue == "low_cue"] <-  "low cue"

df_filter.NA$stim_name[df_filter.NA$stimulusintensity == "high_stim"] <-  "High"
df_filter.NA$stim_name[df_filter.NA$stimulusintensity == "med_stim"] <-  "Med"
df_filter.NA$stim_name[df_filter.NA$stimulusintensity == "low_stim"] <-  "Low"

df_filter.NA$stim_ordered <- factor(df_filter.NA$stim_name, levels = c("Low", "Med", "High"))
df_filter.NA$cue_ordered <- factor(df_filter.NA$cue_name, levels = c("low cue", "high cue"))
model_iv1 <- "stim_ordered"
model_iv2 <- "cue_ordered"
# lmer model __________________________________________________________________
model_savefname <- file.path(
  analysis_dir,
  paste(
    "lmer_nps-",dv,"_",as.character(Sys.Date()),".txt",
    sep = ""
  )
)
formula_string <- paste(dv, "~ CUE_high_gt_low * STIM_linear + CUE_high_gt_low * STIM_quadratic + (CUE_high_gt_low + STIM_linear | sub)")
model_formula <- as.formula(formula_string)
# Fit the model
sink(model_savefname)
model.npscuestim <- lmer(model_formula, data = df_filter.NA, control = lmerControl(optimizer = "nmkbw"))
print(summary(model.npscuestim))
sink()
# summary statistics calculate mean and se  ____________________________________
NPSstimcue_subjectwise <- meanSummary(df_filter.NA,
                                      c(subject, model_iv1, model_iv2), dv)
NPSstimcue_groupwise <- summarySEwithin(
  data = NPSstimcue_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
NPSstimcue_groupwise$task <- taskname
# https://stackoverflow.com/questions/29402528/append-data-frames-together-in-a-for-loop/29419402

combined_se_calc_cooksd <-
  rbind(combined_se_calc_cooksd, NPSstimcue_groupwise)
# plot parameters ______________________________________________________________
sub_mean <- "mean_per_sub"
group_mean <- "mean_per_sub_norm_mean"
se <- "se"
subject <- "sub"
ggtitle <- paste(taskname, " - NPS Cooksd removed")
title <- paste(taskname, " - NPS")
xlab <- ""
ylab <- "NPS (degree)"
ylim <- c(-1,1)
dv_keyword <- "NPS"
if (any(startsWith(dv_keyword, c("expect", "Expect")))) {
  color <- c("#1B9E77", "#D95F02")
} else {
  color <- c("#4575B4", "#D73027")
} # if keyword starts with
plot_savefname <- file.path(
  analysis_dir,
  paste(
    "raincloud_task-", taskname, "_rating-", dv_keyword, "_", as.character(Sys.Date()), "_cooksd.png",
    sep = ""
  )
)



### Lineplots with only low cue ____________________________________
subsetNPS <- NPSstimcue_groupwise[NPSstimcue_groupwise$cue_ordered == "low cue",]
g <- plot_lineplot_twofactor_subset(subsetNPS, taskname = "pain",
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("low cue" = "#3E61EC", "#D73027"), 
                        ggtitle = dv_title,
                        xlab = "Stimulus intensity", ylab = "Mean score")
g + theme(aspect.ratio=.8)


### Lineplots________________________________________________________________________
g <- plot_lineplot_twofactor_subset(NPSstimcue_groupwise, taskname = "pain",
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("low cue" = "#3E61EC","high cue" = "#FF0000"), 
                        ggtitle = dv_title,
                        xlab = "Stimulus intensity", ylab = "Mean score")
g <- g + theme(aspect.ratio=1,
          text = element_text(size = 18), # Default text size for the plot
          axis.title = element_text(size = 22, ), # Axis titles
          axis.text = element_text(size = 15), # Axis text (x and y)
          plot.title = element_text(size = 24, hjust = 0.5) # Plot title
          ) +
  # geom_line(size = 1) + # Adjust line thickness
  geom_point(size = 2)  # Adjust point size
  

#   print(arranged_plot)
  plot_filename = file.path(analysis_dir,
  paste('lineplot_task-all_rating-', dv_keyword,dv, '.svg', sep = ""))

g

  ggsave(plot_filename, g, width = 8, height = 4, dpi=300)
}
```



# E. check which files don't overlap
```{r}
discovery_fname <- '/Volumes/spacetop_projects_cue/analysis/fmri/nilearn/deriv01_signature/rampup_plateau_brainmask/signature-NPS_sub-all_runtype-pvc_event-stimulus.tsv'
canlab_fname <- '/Volumes/spacetop_projects_cue/analysis/fmri/nilearn/deriv01_signature/rampup_plateau_brainmask/CANlab_applyNPS_singletrial_rampupplateau.csv'
discovery <- read.csv(discovery_fname)
canlab <- read.csv(canlab_fname)
canlabdf <- canlab %>%
  # mutate(singletrial_fname = basename(Filenames))
  mutate(singletrial_fname = as.character(singletrial_fname)) %>%
  
  extract(singletrial_fname, into = c("sub", "ses", "run", "runtype", "event", "trial", "cuetype", "stimintensity"),
          regex = "^(sub-\\d+)_(ses-\\d+)_(run-\\d+)_runtype-(pain|vicarious|cognitive)_event-(cue|stimulus)_trial-(\\d+)_cuetype-(high|low)(?:_stimintensity-(high|med|low))?\\.nii.gz$",
          remove = FALSE)
discoverydf <- discovery %>%
  # mutate(singletrial_fname = basename(Filenames))
  mutate(singletrial_fname = as.character(singletrial_fname)) %>%
  
  extract(singletrial_fname, into = c("sub", "ses", "run", "runtype", "event", "trial", "cuetype", "stimintensity"),
          regex = "^(sub-\\d+)_(ses-\\d+)_(run-\\d+)_runtype-(pain|vicarious|cognitive)_event-(cue|stimulus)_trial-(\\d+)_cuetype-(high|low)(?:_stimintensity-(high|med|low))?\\.nii.gz$",
          remove = FALSE)

pdiscovery <- discoverydf[discoverydf$runtype == "pain",]
pcanlab <- canlabdf[canlabdf$runtype == "pain",]

result <- merge(pdiscovery, pcanlab, by = c("singletrial_fname"), all = TRUE, indicator = TRUE)

# Filter rows that are only in one of the dataframes
non_overlapping <- subset(result, grepl("left_only|right_only", result$ind))
print(non_overlapping)

print("correlation between canlb dot product using apply nps and python np.dot:")
cor(result$NPS_dot_product, result$NPS, use = "complete.obs")
```


## 3. NPS ~ SES _ CUE _ STIM

### Q. Is the cue effect on NPS different across sessions? {.unlisted .unnumbered}

> Quick answer: Yes, the cue effect in session 1 (for high intensity group) is significantly different; whereas this different becomes non significant in session 4.
> To unpack, a participant was informed to experience a low stimulus intensity, when in fact they were delivered a high intensity stimulus. This violation presumably leads to a higher NPS response, given that they were delivered a much painful stimulus than expected. The fact that the cue effect is almost non significant during the last session indicates that the cue effects are not just an anchoring effect.

### filter with including session
```{r}
subjects_with_inadequate_data <- df_filter.NA %>%
  group_by(sub, CUE_high_gt_low, SES_linear) %>% 
  dplyr::summarise(count = n(), .groups = 'drop') %>%
  filter(count < 3) %>%
  distinct(sub) %>%
  pull(sub)
df_filter_ses <- df_filter.NA %>%
  filter(!(sub %in% subjects_with_inadequate_data))

print(sprintf("after filtering out subjects that have less than 3 trials in cell, we have N=%d -> N=%d",length(unique(data$sub)), length(unique(df_filter_ses$sub)) ))
```


```{r}
model.npsses <- lmer(nps ~
                          CUE_high_gt_low*SES_linear +
                          CUE_high_gt_low*SES_linear +
                          (CUE_high_gt_low +SES_quadratic  |
         sub), data = df_filter_ses,
         control = lmerControl(optimizer = "nmkbw")
                    )

summary(model.npsses)
# CUE_high_gt_low+STIM+EXPECT_demean
sjPlot::tab_model(model.npsses,
                  title = "Multilevel-modeling: \nlmer(NPS ~ CUE * STIM * SES + (CUE + STIM + SES| sub), data = pvc)",
                  CSS = list(css.table = '+font-size: 12;'))
```
> Using nmkbw optimizer, random slopes of cue, stimulus intensity, and sessions are modeled using orthogonal contrast codes. Cue effects on NPS are significant (b = -0.28, SE = 0.13, t(95.65) = -2.09, CI = [-0.54, -0.02], p = 0.037), where higher cues lead to lower NPS values. Stimulus intensity effects are significant; higher temperature leads to greater NPS response (b =  1.33, SE = 0.15, t(279.51) = 8.63, p < .001)

```{r}
library(parallel)
ncores <- detectCores()
diff_optims <- allFit(model.npsses, maxfun = 1e5, parallel = 'multicore', ncpus = ncores)
# diff_optims <- allFit(model.full, maxfun = 1e5)
diff_optims_OK <- diff_optims[sapply(diff_optims, is, "merMod")]
lapply(diff_optims_OK, function(x) x@optinfo$conv$lme4$messages)
```
### model converge [OK: optimizer nmkbw]

```{r}
library(optimx)
model.npscuestim <- lmer(
  NPS ~
    CUE_high_gt_low  * SES_quadratic +
    CUE_high_gt_low  * SES_linear +

    (CUE_high_gt_low + SES_quadratic  |
       sub),
  data = df_filter_ses,
  control = lmerControl(optimizer = "nmkbw")
)
                         # control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 1e5)))

summary(model.npscuestim)
```

### convergence
```{r}
optimx_options <- c("L-BFGS-B", "nlminb", "nlm", "bobyqa", "nmkb", "hjkb")
for(i in 1:length(optimx_options)){
  print(paste0("Testing optimx: ", optimx_options[i]))
  model_flex <-   lmer(
    nps ~
      CUE_high_gt_low * STIM_linear * SES_linear +
      CUE_high_gt_low * STIM_quadratic * SES_linear +
      CUE_high_gt_low * STIM_linear * SES_quadratic +
      CUE_high_gt_low * STIM_quadratic * SES_quadratic +
      (CUE_high_gt_low + SES_linear + STIM_linear |
         sub),
    data = df_filter_ses,
    control = lmerControl(
      optimizer = "optimx",
      optCtrl = list(
        method = optimx_options[i],
        maxit = 1e9,
        maxfun = 1e9,
        maxeval = 1e7,
        xtol_abs = 1e-9,
        ftol_abs = 1e-9
      )
    )
  )
        # control = lmerControl(optimizer = "nloptwrap",
        #                    optCtrl = list(algorithm = "NLOPT_LN_BOBYQA",
        #                                   maxfun = 1e9,
        #                                   maxeval = 1e7,
        #                                   xtol_abs = 1e-9,
        #                                   ftol_abs = 1e-9))
  if(is.null(model_flex@optinfo$conv$lme4$messages)){
    print(paste0("One of the optimx options, ", optimx_options[i],", worked!"))
    print(model_flex)
    break
  }
}
```


#### eta squared {.unlisted .unnumbered}

```{r echo=FALSE, warning=TRUE}
kableExtra::kable_styling(
  knitr::kable(
    eta_squared(model.npsses, partial = TRUE), # MODIFY
    "html"), "striped", position = "left", font_size = 12)
```

#### Cohen's d {.unlisted .unnumbered}

```{r echo=FALSE, warning=TRUE}
kableExtra::kable_styling(
  knitr::kable(
    lme.dscore(model.npsses, df_filter_ses, type = "lme4"), # MODIFY
    "html"), "striped", position = "left", font_size = 12)
```

#### Session wise plots {.unlisted .unnumbered}

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

combined_se_calc_cooksd <- data.frame()
for (sesname in c("ses-01", "ses-03", "ses-04")) {
taskname = "pain"
    ggtitle <- paste(taskname, " - actual judgment (degree)")
    title <- paste(taskname, " - actual")
    subject <- "sub"
    w <- 10
    h <- 6
s1.sig <- df_filter_ses[df_filter_ses$runtype == "pain" & df_filter_ses$ses == sesname,]
data <- s1.sig
    # [ CONTRASTS ]  ________________________________________________________________________________ # nolint
# contrast code ________________________________________
# data$stim[data$stimulusintensity == "low_stim"] <- -0.5 # social influence task
# data$stim[data$stimulusintensity == "med_stim"] <- 0 # no influence task
# data$stim[data$stimulusintensity == "high_stim"] <- 0.5 # no influence task
# 
# data$STIM <- factor(data$stimulusintensity)
# 
# # contrast code 1 linear
# data$STIM_linear[data$stimulusintensity == "low_stim"] <- -0.5
# data$STIM_linear[data$stimulusintensity == "med_stim"] <- 0
# data$STIM_linear[data$stimulusintensity == "high_stim"] <- 0.5
# 
# # contrast code 2 quadratic
# data$STIM_quadratic[data$stimulusintensity == "low_stim"] <- -0.33
# data$STIM_quadratic[data$stimulusintensity == "med_stim"] <- 0.66
# data$STIM_quadratic[data$stimulusintensity == "high_stim"] <- -0.33
# 
# # social cude contrast
# data$CUE_high_gt_low[data$cue == "low_cue"] <- -0.5 # social influence task
# data$CUE_high_gt_low[data$cue == "high_cue"] <- 0.5 # no influence task
# 

# stim_con1 <- "STIM_linear"
# stim_con2 <- "STIM_quadratic"
iv1 <- "CUE_high_gt_low"


    # [ MODEL ] _________________________________________________ # nolint
    model_savefname <- file.path(
        analysis_dir,
        paste("lmer_task-", taskname,
            "_rating-", dv_keyword,
            "_", as.character(Sys.Date()), "_cooksd.txt",
            sep = ""
        )
    )


    # [ PLOT ] reordering for plots _________________________ # nolint
    data$cue_name[data$cuetype == "high"] <- "high cue"
    data$cue_name[data$cuetype == "low"] <- "low cue"
# 
    data$stim_name[data$stimintensity == "high"] <- "high"
    data$stim_name[data$stimintensity == "med"] <- "med"
    data$stim_name[data$stimintensity == "low"] <- "low"

    # DATA$levels_ordered <- factor(DATA$param_stimulus_type, levels=c("low", "med", "high"))

    data$stim_ordered <- factor(
        data$stim_name,
        levels = c("low", "med", "high")
    )
    data$cue_ordered <- factor(
        data$cue_name,
        levels = c("low cue", "high cue")
    )
    model_iv1 <- "stim_ordered"
    model_iv2 <- "cue_ordered"

    #  [ PLOT ] calculate mean and se  _________________________
    actual_subjectwise <- meanSummary(
        data,
        c(subject, model_iv1, model_iv2), dv
    )
    actual_groupwise <- summarySEwithin(
        data = actual_subjectwise,
        measurevar = "mean_per_sub",
        withinvars = c(model_iv1, model_iv2), idvar = subject
    )
    actual_groupwise$task <- taskname
    actual_groupwise$ses <- sesname
    # https://stackoverflow.com/questions/29402528/append-data-frames-together-in-a-for-loop/29419402

    combined_se_calc_cooksd <- rbind(combined_se_calc_cooksd, actual_groupwise)
   # calculate mean and se
    sub_mean <- "mean_per_sub"
    group_mean <- "mean_per_sub_norm_mean"
    se <- "se"
    subject <- "sub"
    ggtitle <- paste(str_to_title(taskname), " - NPS Cooksd removed ", sesname )
    title <- paste(str_to_title(taskname), " - cue level")
    xlab <- ""
    ylab <- "NPS (degree)"
    ylim <- c(-10,60)
    dv_keyword <- "NPS"
    if (any(startsWith(dv_keyword, c("expect", "Expect")))) {
        color <- c("#1B9E77", "#D95F02")
    } else {
        color <- c("#4575B4", "#D73027")
    } # if keyword starts with
    plot_savefname <- file.path(
        analysis_dir,
        paste("raincloud_task-", taskname,
            "_rating-", dv_keyword,
            "_", as.character(Sys.Date()), "_cooksd.png",
            sep = ""
        )
    )
    g <- plot_halfrainclouds_twofactor(
        actual_subjectwise, actual_groupwise, model_iv1, model_iv2,
        sub_mean, group_mean, se, subject,
        ggtitle, title, xlab, ylab, taskname,ylim,
        w, h, dv_keyword, color, plot_savefname
    )
print(g)
}
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
# lineplot per session

DATA = as.data.frame(combined_se_calc_cooksd)
color = c("#4C77ED", "#ED220D")
model_iv1 <- "stim_ordered"
model_iv2 <- "ses_ordered"
LINEIV1 = "stim_ordered"
LINEIV2 = "cue_ordered"
MEAN = "mean_per_sub_norm_mean"
ERROR = "se"
dv_keyword = "actual"
p1 = plot_lineplot_twofactor(DATA[DATA$ses == "ses-01",], 
               LINEIV1, LINEIV2, MEAN, ERROR, color, xlab = "cue type", ggtitle ='ses-01',
               ylab = "NPS (dot products)" )

p2 = plot_lineplot_twofactor(DATA[DATA$ses == "ses-03",], 
               LINEIV1, LINEIV2, MEAN, ERROR, color, xlab = "cue type", ggtitle ='ses-03',
               ylab = "NPS (dot products)" )
p3 = plot_lineplot_twofactor(DATA[DATA$ses == "ses-04",],
               LINEIV1, LINEIV2, MEAN, ERROR, color, xlab = "cue type", ggtitle ='ses-04',
               ylab = "NPS (dot products)" )


ggpubr::ggarrange(p1,p2,p3,ncol = 3, nrow = 1, common.legend = TRUE,legend = "bottom")
 
plot_filename = file.path(analysis_dir,
                          paste('lineplot_task-all_rating-',dv_keyword,'.png', sep = ""))
ggsave(plot_filename, width = 8, height = 4)
```

---


