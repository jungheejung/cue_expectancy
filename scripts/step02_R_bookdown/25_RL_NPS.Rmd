# RL :: simulated PE & NPS{#cNPSandPE}

## The purpose of this notebook? {.unlisted .unnumbered}

Investigate the relationship between prediction errors and NPS extracted values.

```{r include=FALSE}
library(car)
library(psych)
library(reshape)
library(dplyr)
library(tidyselect)
library(tidyr)
library(stringr)
library(lmerTest)
library(gghalves)
library(plyr)
library(ggpubr)
library(r2mlm)
library(effectsize)
library(devtools)
# options(es.use_symbols = TRUE) # get nice symbols when printing! (On Windows, requires R >= 4.2.0)
library(EMAtools)
library(emmeans)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(DT)
library(raincloudplots)
devtools::source_url("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")
library(r2mlm)
main_dir <- dirname(dirname(getwd()))
print(main_dir)
file.sources = list.files(file.path(main_dir, 'scripts', 'step02_R', 'utils'),
                          pattern="*.R",
                          full.names=TRUE,
                          ignore.case=TRUE)
sapply(file.sources,source,.GlobalEnv)

```

### load dataframe

```{r}

# load NPS dot product
NPSdf <- read.csv(file.path(main_dir, 'analysis/fmri/nilearn/deriv01_signature/rampupdown/signature-NPSpos_sub-all_runtype-pvc_event-stimulus.tsv' ))

# load RL data
RLdf <- read.csv(file.path(main_dir, "/data/RL/modelfit_jepma_0525/table_pain.csv"))

# create analysis directory to save files
analysis_dir <- file.path(main_dir, 'analysis', 'mixedeffect', 'model25_RL_NPS', as.character(Sys.Date()))
dir.create(analysis_dir, recursive = TRUE)
```

### some data wrangling:

split filenames into columns. This will serve as metadata. NPSsplit
We'll use this to merge NPSsplit and RLdf

```{r}


NPSsplit <- NPSdf %>%
  # 1) Extract the components from the singletrial_fname column (sub,ses, run etc)
  extract(col = singletrial_fname, into = c("sub", "ses", "run", "runtype", "event", "trial", "cuetype", "stimintensity"),
          regex = "(sub-\\w+)_+(ses-\\w+)_+(run-\\w+)_+(runtype-\\w+)_+(event-\\w+)_+(trial-\\w+)_+(cuetype-\\w+)_+(stimintensity-\\w+).nii.gz") %>%
  # 2) Extract numbers and keywords as specified
  mutate(
    src_subject_id = as.integer(str_extract(sub, "\\d+")),
    session_id = as.integer(str_extract(ses, "\\d+")),
    param_run_num = as.integer(str_extract(run, "\\d+")),
    trial_index_runwise = as.integer(str_extract(trial, "\\d+")) + 1,
    param_cue_type = case_when(
      str_detect(cuetype, "low") ~ "low_cue",
      str_detect(cuetype, "high") ~ "high_cue"
    ),
    param_task_name = str_replace(runtype, "runtype-", ""),
    param_stimulus_type = case_when(
      stimintensity == "stimintensity-low" ~ "low_stim",
      stimintensity == "stimintensity-med" ~ "med_stim",
      stimintensity == "stimintensity-high" ~ "high_stim",
      TRUE ~ stimintensity  # Retain original value if neither "low" nor "high"
    )
  ) %>%
  # 3) Select and rename the necessary columns
  select(
    src_subject_id,
    session_id,
    param_run_num,
    param_task_name,
    event,
    trial_index_runwise,
    param_cue_type,
    param_stimulus_type,
    NPSpos
  )

# names(NPSsplit)[names(NPSsplit) == "src_subject_id"] <- "sub"
# names(NPSsplit)[names(NPSsplit) == "session_id"] <- "ses"
# names(NPSsplit)[names(NPSsplit) == "param_run_num"] <- "run"

```

```{r}

NPSsplit <- NPSdf %>%
  # 1) Extract the components from the singletrial_fname column (sub,ses, run etc)
  extract(col = singletrial_fname, into = c("sub", "ses", "run", "runtype", "event", "trial", "cuetype", "stimintensity"),
          regex = "(sub-\\w+)_+(ses-\\w+)_+(run-\\w+)_+(runtype-\\w+)_+(event-\\w+)_+(trial-\\w+)_+(cuetype-\\w+)_+(stimintensity-\\w+).nii.gz") %>%
  # 2) Extract numbers and keywords as specified
  mutate(
    sub = as.integer(str_extract(sub, "\\d+")),
    ses = as.integer(str_extract(ses, "\\d+")),
    run = as.integer(str_extract(run, "\\d+")),
    trial = as.integer(str_extract(trial, "\\d+")) + 1,
    cue = case_when(
      str_detect(cuetype, "low") ~ "low_cue",
      str_detect(cuetype, "high") ~ "high_cue"
    ),
    task = str_replace(runtype, "runtype-", ""),
    stimintensity = case_when(
      stimintensity == "stimintensity-low" ~ "low_stim",
      stimintensity == "stimintensity-med" ~ "med_stim",
      stimintensity == "stimintensity-high" ~ "high_stim",
      TRUE ~ stimintensity  # Retain original value if neither "low" nor "high"
    )
  ) %>%
  # 3) Select and rename the necessary columns
  select(
    sub,
    ses,
    run,
    task,
    event,
    trial,
    cue,
    stimintensity,
    NPSpos
  )
```

### rename RL dataframe so that columns are identical. we will merge on these columns

```{r}
names(RLdf)[names(RLdf) == "src_subject_id"] <- "sub"
names(RLdf)[names(RLdf) == "session_id"] <- "ses"
names(RLdf)[names(RLdf) == "param_run_num"] <- "run"
names(RLdf)[names(RLdf) == "param_task_name"] <- "task"
names(RLdf)[names(RLdf) == "param_cue_type"] <- "cue"
names(RLdf)[names(RLdf) == "param_stimulus_type"] <- "stimintensity"
names(RLdf)[names(RLdf) == "trial_index_runwise"] <- "trial"
```

### merge the two dataframes

```{r}
merge_df <- inner_join(NPSsplit, RLdf, by = c("sub", "ses", "run", "task", "cue", "stimintensity", "trial"))
```

### remove bad runs

```{r}
library(jsonlite)
jsonfname <- file.path(main_dir, "scripts/bad_runs.json")


bad_runs <- fromJSON(jsonfname, simplifyDataFrame = FALSE)

# Initialize an empty data frame to store bad run entries
bad_runs_df <- data.frame(sub = integer(), ses = integer(), run = integer(), stringsAsFactors = FALSE)

# Parse the JSON content
for (sub_id in names(bad_runs)) {
  sub_num <- as.integer(substring(sub_id, 5))  # Extract the numeric part of the subject ID

  # Iterate over sessions and their runs for each subject
  for (ses_run_str in bad_runs[[sub_id]]) {
    ses_num <- as.integer(substring(strsplit(ses_run_str, "_")[[1]][1], 5))  # Extract session number
    run_num <- as.integer(substring(strsplit(ses_run_str, "_")[[1]][2], 5))  # Extract run number

    # Append to the bad_runs_df data frame
    bad_runs_df <- rbind(bad_runs_df, data.frame(sub = sub_num, ses = ses_num, run = run_num))
  }
}

# drop rows in merge_df if they overlap with bad_runs_df
clean_merge_df <- merge_df %>%
  anti_join(bad_runs_df, by = c("sub", "ses", "run"))

```

```{r}
# DROP sub 23
# clean_merge_df <- clean_merge_df[clean_merge_df$sub != 23, ]
```

### calculate behavioral PE

```{r}
# change columns names for better modeling
clean_merge_df$RATING_expectation <- clean_merge_df$event02_expect_angle
clean_merge_df$RATING_outcome <- clean_merge_df$event04_actual_angle

# PE :: prediction error ______________________________________________________
clean_merge_df$PE =   clean_merge_df$RATING_outcome - clean_merge_df$RATING_expectation

# Lag expectation rating ______________________________________________________
# per run/ses/sub
data_a3lag <- clean_merge_df %>%
  group_by(sub,ses,run) %>%
  mutate(prev_trial.RATING_expectation = lag(RATING_expectation, n = 1, default = NA)) %>%
  mutate(next_trial.RATING_expectation = lead(RATING_expectation, n = 1, default = NA)) %>%
  mutate(ave.RATING_expectation = mean(RATING_expectation, na.rm = TRUE))
data_a3lag <- data_a3lag[!is.na(data_a3lag$ave.RATING_expectation),]
taskname = 'pain'
data_a3lag$next_trial.RATING_expect_fill = coalesce(data_a3lag$next_trial.RATING_expectation, data_a3lag$ave.RATING_expectation)
data_a3lag$prev_trial.RATING_expect_fill = coalesce(data_a3lag$prev_trial.RATING_expectation, data_a3lag$ave.RATING_expectation)

# EXPECTUPDATE :: expectation (N) - expectation (N-1) ________________________
clean_merge_df <- data_a3lag %>%
  # group_by(sub,ses,run) %>%
  mutate(beh_PE =  next_trial.RATING_expect_fill-RATING_expectation )  %>%
  mutate(beh_PE_JEPMA =  (next_trial.RATING_expect_fill - RATING_expectation)/(PE+1))
# beh_PE_JEPMA: Jepma (2018)
```

## NPS plot N = 120

```{r warning=FALSE}
################################################################################
# contrast coding ______________________________________________________________
NPSdf <- NPSsplit %>%
  anti_join(bad_runs_df, by = c("sub", "ses", "run"))
data <- NPSdf
data$sub <- factor(data$sub)
# contrast code
data$stim[data$stimintensity == "low_stim"] <-  -0.5 # social influence task
data$stim[data$stimintensity == "med_stim"] <- 0 # no influence task
data$stim[data$stimintensity == "high_stim"] <-  0.5 # no influence task

data$STIM <- factor(data$stimintensity)

# contrast code 1 linear
data$STIM_linear[data$stimintensity == "low_stim"] <- -0.5
data$STIM_linear[data$stimintensity == "med_stim"] <- 0
data$STIM_linear[data$stimintensity == "high_stim"] <- 0.5

# contrast code 2 quadratic
data$STIM_quadratic[data$stimintensity == "low_stim"] <- -0.33
data$STIM_quadratic[data$stimintensity == "med_stim"] <- 0.66
data$STIM_quadratic[data$stimintensity == "high_stim"] <- -0.33

# social cue contrast
data$CUE_high_gt_low[data$cue == "low_cue"] <-  -0.5 # social influence task
data$CUE_high_gt_low[data$cue == "high_cue"] <-  0.5 # no influence task

data$EXPECT <- data$event02_expect_angle
stim_con1 <- "STIM_linear"
stim_con2 <- "STIM_quadratic"
iv1 <- "CUE_high_gt_low"
dv <- "NPSpos"; dv_keyword <- "NPSpos"
subject <- "sub"

################################################################################
# linear model _________________________________________________________________
model_savefname <- file.path(
  analysis_dir,
  paste(
    "lmer_task-", taskname, "_rating-", dv_keyword, "_", as.character(Sys.Date()), "_cooksd.txt",
    sep = ""
  )
)

cooksd <- lmer_twofactor_cooksd(
  data,  taskname,  iv1,  stim_con1,  stim_con2,  dv,  subject = "sub",  dv_keyword,  model_savefname,  'random_intercept',
  print_lmer_output = FALSE
)
influential <- as.numeric(names(cooksd)[(cooksd > (4 / as.numeric(length(unique(
  data$sub
)))))])
# data_screen <- data[-influential,]
data_screen <- data
################################################################################
# plot :: reorder column levels and names for plots ____________________________
data_screen$cue_name <- 0

data_screen$cue_name[data_screen$cue == "high_cue"] <-  "high cue"
data_screen$cue_name[data_screen$cue == "low_cue"] <-  "low cue"

data_screen$stim_name[data_screen$stimintensity == "high_stim"] <-  "high"
data_screen$stim_name[data_screen$stimintensity == "med_stim"] <-  "med"
data_screen$stim_name[data_screen$stimintensity == "low_stim"] <-  "low"

data_screen$stim_ordered <- factor(data_screen$stim_name, levels = c("low", "med", "high"))
data_screen$cue_ordered <- factor(data_screen$cue_name, levels = c("low cue", "high cue"))
model_iv1 <- "stim_ordered"
model_iv2 <- "cue_ordered"

################################################################################
# plot :: calculate mean and se  _______________________________________________
NPSstimcue_subjectwise <- meanSummary(data_screen,
                                      c(subject, model_iv1, model_iv2), dv)
NPSstimcue_groupwise <- summarySEwithin(
  data = NPSstimcue_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
NPSstimcue_groupwise$task <- taskname
signature_key <- "NPSpos"
  taskname <- "pain"
  plot_keyword <- "stimulusintensity"
  ggtitle_phrase <-  ""
  data_screen$task = factor(data_screen$task)
  plot_keys <- list(
    sub_mean = "mean_per_sub",
    group_mean = "mean_per_sub_norm_mean",
    legend_keyword = "stimulus intensity",
    se = "se",
    subject = "sub",
    ggtitle = paste0(
      str_to_title(signature_key),
      " dot product: ", str_to_title(taskname), ' ', ggtitle_phrase, " (N = ", length(unique(data_screen$sub)), ")"
    ),
    title = paste0(
      str_to_title(signature_key), " - ", str_to_title(plot_keyword)
    ),
    xlab = "",
    ylab = paste(signature_key, " (dot product)"),
    ylim = c(-250, 500)
  )


################################################################################
### Lineplots {.unlisted .unnumbered} __________________________________________

fig.nps120 <- plot_lineplot_twofactor(NPSstimcue_groupwise,
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("#5D5C5C", "#941100"), ggtitle = paste0(
      str_to_title(signature_key),
      " dot product: ", str_to_title(taskname), ' ', ggtitle_phrase, " (N = ", length(unique(data_screen$sub)), ")"
    ), #"Within pain task: NPS dotproducts as a function of stimulus intensity level and cue",
                        xlab = "Stimulus intensity", ylab = "NPS (dot product)")
fig.nps120

```

## contrast coding for the merged dataframe

```{r warning=FALSE}
clean_merge_df$sub <- factor(clean_merge_df$sub)
# contrast code ________________________________________
clean_merge_df$stim[clean_merge_df$stimintensity == "low_stim"] <-  -0.5 # social influence task
clean_merge_df$stim[clean_merge_df$stimintensity == "med_stim"] <- 0 # no influence task
clean_merge_df$stim[clean_merge_df$stimintensity == "high_stim"] <-  0.5 # no influence task
clean_merge_df$STIM <- factor(clean_merge_df$stimintensity)

# contrast code 1 linear
clean_merge_df$STIM_linear[clean_merge_df$stimintensity == "low_stim"] <- -0.5
clean_merge_df$STIM_linear[clean_merge_df$stimintensity == "med_stim"] <- 0
clean_merge_df$STIM_linear[clean_merge_df$stimintensity == "high_stim"] <- 0.5

# contrast code 2 quadratic
clean_merge_df$STIM_quadratic[clean_merge_df$stimintensity == "low_stim"] <- -0.33
clean_merge_df$STIM_quadratic[clean_merge_df$stimintensity == "med_stim"] <- 0.66
clean_merge_df$STIM_quadratic[clean_merge_df$stimintensity == "high_stim"] <- -0.33

# social cue contrast
clean_merge_df$CUE_high_gt_low[clean_merge_df$cue == "low_cue"] <-  -0.5 # social influence task
clean_merge_df$CUE_high_gt_low[clean_merge_df$cue == "high_cue"] <-  0.5 # no influence task

clean_merge_df$EXPECT <- clean_merge_df$event02_expect_angle
clean_merge_df$sub <- factor(clean_merge_df$sub)
# contrast code ________________________________________
clean_merge_df$stim[clean_merge_df$stimintensity == "low_stim"] <-  -0.5 # social influence task
clean_merge_df$stim[clean_merge_df$stimintensity == "med_stim"] <- 0 # no influence task
clean_merge_df$stim[clean_merge_df$stimintensity == "high_stim"] <-  0.5 # no influence task
clean_merge_df$STIM <- factor(clean_merge_df$stimintensity)

# contrast code 1 linear
clean_merge_df$STIM_linear[clean_merge_df$stimintensity == "low_stim"] <- -0.5
clean_merge_df$STIM_linear[clean_merge_df$stimintensity == "med_stim"] <- 0
clean_merge_df$STIM_linear[clean_merge_df$stimintensity == "high_stim"] <- 0.5

# contrast code 2 quadratic
clean_merge_df$STIM_quadratic[clean_merge_df$stimintensity == "low_stim"] <- -0.33
clean_merge_df$STIM_quadratic[clean_merge_df$stimintensity == "med_stim"] <- 0.66
clean_merge_df$STIM_quadratic[clean_merge_df$stimintensity == "high_stim"] <- -0.33

# social cue contrast
clean_merge_df$CUE_high_gt_low[clean_merge_df$cue == "low_cue"] <-  -0.5 # social influence task
clean_merge_df$CUE_high_gt_low[clean_merge_df$cue == "high_cue"] <-  0.5 # no influence task

clean_merge_df$EXPECT <- clean_merge_df$event02_expect_angle
```

## A. NPS plot N = 60

```{r warning=FALSE}
################################################################################
# contrast coding ______________________________________________________________

data <- clean_merge_df
stim_con1 <- "STIM_linear"
stim_con2 <- "STIM_quadratic"
iv1 <- "CUE_high_gt_low"
dv <- "NPSpos"
subject <- "sub"

################################################################################
# linear model _________________________________________________________________
model_savefname <- file.path(
  analysis_dir,
  paste(
    "lmer_task-", taskname, "_rating-", dv_keyword, "_", as.character(Sys.Date()), "_cooksd.txt",
    sep = ""
  )
)

cooksd <- lmer_twofactor_cooksd(
  data,  taskname,  iv1,  stim_con1,  stim_con2,  dv,  subject = "sub",  dv_keyword,  model_savefname,  'random_intercept',
  print_lmer_output = FALSE
)
influential <- as.numeric(names(cooksd)[(cooksd > (4 / as.numeric(length(unique(
  data$sub
)))))])
data_screen <- data[-influential,]

################################################################################
# plot :: reorder column levels and names for plots ____________________________
data_screen$cue_name[data_screen$cue == "high_cue"] <-  "high cue"
data_screen$cue_name[data_screen$cue == "low_cue"] <-  "low cue"

data_screen$stim_name[data_screen$stimintensity == "high_stim"] <-  "high"
data_screen$stim_name[data_screen$stimintensity == "med_stim"] <-  "med"
data_screen$stim_name[data_screen$stimintensity == "low_stim"] <-  "low"

data_screen$stim_ordered <- factor(data_screen$stim_name, levels = c("low", "med", "high"))
data_screen$cue_ordered <- factor(data_screen$cue_name, levels = c("low cue", "high cue"))
model_iv1 <- "stim_ordered"
model_iv2 <- "cue_ordered"

################################################################################
# plot :: calculate mean and se  _______________________________________________
NPSstimcue_subjectwise <- meanSummary(data_screen,
                                      c(subject, model_iv1, model_iv2), dv)
NPSstimcue_groupwise <- summarySEwithin(
  data = NPSstimcue_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
NPSstimcue_groupwise$task <- taskname
signature_key <- "NPSpos"
taskname <- "pain"
plot_keyword <- "stimulusintensity"
ggtitle_phrase <-  ""
data_screen$task = factor(data_screen$task)
plot_keys <- list(
    sub_mean = "mean_per_sub",
    group_mean = "mean_per_sub_norm_mean",
    legend_keyword = "stimulus intensity",
    se = "se",
    subject = "sub",
    ggtitle = paste0(
      str_to_title(signature_key),
      " dot product: ", str_to_title(taskname), ' ', ggtitle_phrase, " (N = ", length(unique(data_screen$sub)), ")"
    ),
    title = paste0(
      str_to_title(signature_key), " - ", str_to_title(plot_keyword)
    ),
    xlab = "",
    ylab = paste(signature_key, " (dot product)"),
    ylim = c(-250, 500)
  )

################################################################################
# Lineplots {.unlisted .unnumbered} ____________________________________________
# fig.nps60 <- plot_lineplot_twofactor(NPSstimcue_groupwise,
#                         iv1 = "stim_ordered", iv2 = "cue_ordered",
#                         mean = "mean_per_sub_norm_mean", error = "se",
#                         color = c("#5D5C5C", "#941100"),
#                         ggtitle = paste0(      str_to_title(signature_key), " dot product: ", str_to_title(taskname), ' ', ggtitle_phrase, " (N = ", length(unique(data_screen$sub)), ")"
#     ),
#                         xlab = "Stimulus intensity", ylab = "NPS (dot product)")
# fig.nps60   + theme(aspect.ratio=0.8)


fig.nps60 <- plot_lineplot_twofactorthick(NPSstimcue_groupwise,
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("skyblue", "red"),
                        ggtitle = paste0( "NPS ", " (N = ", length(unique(data_screen$sub)), ")"    ),
                        xlab = "Stimulus intensity", ylab = "NPS")
fig.nps60 <- fig.nps60 + theme(aspect.ratio=.8)
ggsave(file.path(analysis_dir, "iv-cue-stim-dv-NPS.png"), plot = fig.nps60, bg = "transparent", device = "png")

```

```{r}
model.nps <- lmer(NPSpos ~ CUE_high_gt_low *STIM_linear + CUE_high_gt_low *STIM_quadratic +
       (CUE_high_gt_low+STIM_linear|sub), data = clean_merge_df,REML=FALSE,
       control = lmerControl(optimizer = "Nelder_Mead", boundary.tol = 1e-2))
summary(model.nps)
```

## B. PE plot

```{r message=FALSE, warning=FALSE}
################################################################################
# contrast coding ______________________________________________________________

data <- clean_merge_df
stim_con1 <- "STIM_linear"
stim_con2 <- "STIM_quadratic"
iv1 <- "CUE_high_gt_low"
dv <- "PE_mdl2"
subject <- "sub"

################################################################################
# linear model _________________________________________________________________
model_savefname <- file.path(
  analysis_dir,
  paste(
    "lmer_task-", taskname, "_rating-", dv_keyword, "_", as.character(Sys.Date()), "_cooksd.txt",
    sep = ""
  )
)

cooksd <- lmer_twofactor_cooksd(
  data,  taskname,  iv1,  stim_con1,  stim_con2,  dv,  subject = "sub",  dv_keyword,  model_savefname,  'random_intercept',
  print_lmer_output = FALSE
)
influential <- as.numeric(names(cooksd)[(cooksd > (4 / as.numeric(length(unique(
  data$sub
)))))])
data_screen <- data[-influential,]

################################################################################
# plot :: reorder column levels and names for plots ____________________________
data_screen$cue_name[data_screen$cue == "high_cue"] <-  "high cue"
data_screen$cue_name[data_screen$cue == "low_cue"] <-  "low cue"

data_screen$stim_name[data_screen$stimintensity == "high_stim"] <-  "high"
data_screen$stim_name[data_screen$stimintensity == "med_stim"] <-  "med"
data_screen$stim_name[data_screen$stimintensity == "low_stim"] <-  "low"

data_screen$stim_ordered <- factor(data_screen$stim_name, levels = c("low", "med", "high"))
data_screen$cue_ordered <- factor(data_screen$cue_name, levels = c("low cue", "high cue"))
model_iv1 <- "stim_ordered"
model_iv2 <- "cue_ordered"

################################################################################
# plot :: calculate mean and se  _______________________________________________
NPSstimcue_subjectwise <- meanSummary(data_screen,
                                      c(subject, model_iv1, model_iv2), dv)
NPSstimcue_groupwise <- summarySEwithin(
  data = NPSstimcue_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
NPSstimcue_groupwise$task <- taskname
signature_key <- "PE (Jepma)"
taskname <- "pain"
plot_keyword <- "stimulusintensity"
ggtitle_phrase <-  ""
data_screen$task = factor(data_screen$task)
plot_keys <- list(
    sub_mean = "mean_per_sub",
    group_mean = "mean_per_sub_norm_mean",
    legend_keyword = "stimulus intensity",
    se = "se",
    subject = "sub",
    ggtitle = paste0(
      str_to_title(signature_key),
      " dot product: ", str_to_title(taskname), ' ', ggtitle_phrase, " (N = ", length(unique(data_screen$sub)), ")"
    ),
    title = paste0(
      str_to_title(signature_key), " - ", str_to_title(plot_keyword)
    ),
    xlab = "",
    ylab = paste(signature_key, " (dot product)"),
    ylim = c(-250, 500)
  )

################################################################################
# Lineplots {.unlisted .unnumbered} ____________________________________________
fig.PE <- plot_lineplot_twofactor(NPSstimcue_groupwise,
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("#5D5C5C", "#941100"),
                        ggtitle = paste0( "PE", " (N = ", length(unique(data_screen$sub)), ")"
    ),
                        xlab = "Stimulus intensity", ylab = "PE")
fig.PE

```

## C. behavior PE plot

```{r}
################################################################################
# contrast coding ______________________________________________________________

data <- clean_merge_df
stim_con1 <- "STIM_linear"
stim_con2 <- "STIM_quadratic"
iv1 <- "CUE_high_gt_low"
dv <- "beh_PE"
subject <- "sub"

################################################################################
# linear model _________________________________________________________________
model_savefname <- file.path(
  analysis_dir,
  paste("lmer_task-", taskname, "_rating-", dv_keyword, "_", as.character(Sys.Date()), "_cooksd.txt", sep = ""  )
)

cooksd <- lmer_twofactor_cooksd(
  data,  taskname,  iv1,  stim_con1,  stim_con2,  dv,  subject = "sub",  dv_keyword,  model_savefname,  'random_intercept',
  print_lmer_output = FALSE
)
influential <- as.numeric(names(cooksd)[(cooksd > (4 / as.numeric(length(unique(
  data$sub
)))))])
# data_screen <- data[-influential,]
data_screen <- data
################################################################################
# plot :: reorder column levels and names for plots ____________________________
data_screen$cue_name[data_screen$cue == "high_cue"] <-  "high cue"
data_screen$cue_name[data_screen$cue == "low_cue"] <-  "low cue"

data_screen$stim_name[data_screen$stimintensity == "high_stim"] <-  "high"
data_screen$stim_name[data_screen$stimintensity == "med_stim"] <-  "med"
data_screen$stim_name[data_screen$stimintensity == "low_stim"] <-  "low"

data_screen$stim_ordered <- factor(data_screen$stim_name, levels = c("low", "med", "high"))
data_screen$cue_ordered <- factor(data_screen$cue_name, levels = c("low cue", "high cue"))
model_iv1 <- "stim_ordered"
model_iv2 <- "cue_ordered"

################################################################################
# plot :: calculate mean and se  _______________________________________________
NPSstimcue_subjectwise <- meanSummary(data_screen,
                                      c(subject, model_iv1, model_iv2), dv)
NPSstimcue_groupwise <- summarySEwithin(
  data = NPSstimcue_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
NPSstimcue_groupwise$task <- taskname
signature_key <- "PE (behavioral)"
taskname <- "pain"
plot_keyword <- "stimulusintensity"
ggtitle_phrase <-  ""
data_screen$task = factor(data_screen$task)
plot_keys <- list(
    sub_mean = "mean_per_sub",
    group_mean = "mean_per_sub_norm_mean",
    legend_keyword = "stimulus intensity",
    se = "se",
    subject = "sub",
    ggtitle = paste0(
      str_to_title(signature_key), " dot product: ", str_to_title(taskname), ' ', ggtitle_phrase, " (N = ", length(unique(data_screen$sub)), ")"
    ),
    title = paste0(      str_to_title(signature_key), " - ", str_to_title(plot_keyword)    ),
    xlab = "",
    ylab = paste(signature_key, " (dot product)"),
    ylim = c(-250, 500)
  )

################################################################################
# Lineplots {.unlisted .unnumbered} ____________________________________________
fig.PE_beh <- plot_lineplot_twofactor(NPSstimcue_groupwise,
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("#5D5C5C", "#941100"),
                        ggtitle = paste0( "PE (behavioral) ", " (N = ", length(unique(data_screen$sub)), ")"    ),
                        xlab = "Stimulus intensity", ylab = "PE")
fig.PE_beh

```

## D. outcome rating plot

```{r}
################################################################################
# contrast coding ______________________________________________________________

data <- clean_merge_df

stim_con1 <- "STIM_linear"
stim_con2 <- "STIM_quadratic"
iv1 <- "CUE_high_gt_low"
dv <- "RATING_outcome"
subject <- "sub"

################################################################################
# linear model _________________________________________________________________
model_savefname <- file.path(
  analysis_dir,
  paste("lmer_task-", taskname, "_rating-", dv_keyword, "_", as.character(Sys.Date()), "_cooksd.txt", sep = ""  )
)

cooksd <- lmer_twofactor_cooksd(
  data,  taskname,  iv1,  stim_con1,  stim_con2,  dv,  subject = "sub",  dv_keyword,  model_savefname,  'random_intercept',
  print_lmer_output = FALSE
)
influential <- as.numeric(names(cooksd)[(cooksd > (4 / as.numeric(length(unique(
  data$sub
)))))])
# data_screen <- data[-influential,]
data_screen <- data
################################################################################
# plot :: reorder column levels and names for plots ____________________________
data_screen$cue_name[data_screen$cue == "high_cue"] <-  "high cue"
data_screen$cue_name[data_screen$cue == "low_cue"] <-  "low cue"

data_screen$stim_name[data_screen$stimintensity == "high_stim"] <-  "high"
data_screen$stim_name[data_screen$stimintensity == "med_stim"] <-  "med"
data_screen$stim_name[data_screen$stimintensity == "low_stim"] <-  "low"

data_screen$stim_ordered <- factor(data_screen$stim_name, levels = c("low", "med", "high"))
data_screen$cue_ordered <- factor(data_screen$cue_name, levels = c("low cue", "high cue"))
model_iv1 <- "stim_ordered"
model_iv2 <- "cue_ordered"

################################################################################
# plot :: calculate mean and se  _______________________________________________
NPSstimcue_subjectwise <- meanSummary(data_screen,
                                      c(subject, model_iv1, model_iv2), dv)
NPSstimcue_groupwise <- summarySEwithin(
  data = NPSstimcue_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
NPSstimcue_groupwise$task <- taskname
signature_key <- "Outcome rating"
taskname <- "pain"
plot_keyword <- "stimulusintensity"
ggtitle_phrase <-  ""
data_screen$task = factor(data_screen$task)
plot_keys <- list(
    sub_mean = "mean_per_sub",
    group_mean = "mean_per_sub_norm_mean",
    legend_keyword = "stimulus intensity",
    se = "se",
    subject = "sub",
    ggtitle = paste0(
      str_to_title(signature_key), " dot product: ", str_to_title(taskname), ' ', ggtitle_phrase, " (N = ", length(unique(data_screen$sub)), ")"
    ),
    title = paste0(      str_to_title(signature_key), " - ", str_to_title(plot_keyword)    ),
    xlab = "",
    ylab = paste(signature_key, " (dot product)"),
    ylim = c(-250, 500)
  )

################################################################################
# Lineplots {.unlisted .unnumbered} ____________________________________________
fig.outcome <- plot_lineplot_twofactorthick(NPSstimcue_groupwise,
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("skyblue", "red"),
                        ggtitle = paste0( "Outcome rating ", " (N = ", length(unique(data_screen$sub)), ")"    ),
                        xlab = "Stimulus intensity", ylab = "Outcome rating")
fig.outcome <- fig.outcome + theme(aspect.ratio=1)
ggsave(file.path(analysis_dir, "iv-cue-stim-dv-outcome.png"), plot = fig.outcome, bg = "transparent", device = "png")

```

```{r}
model.outcome <- lmer(RATING_outcome ~ CUE_high_gt_low*STIM_linear + CUE_high_gt_low*STIM_quadratic + (CUE_high_gt_low+STIM_linear|sub),data = clean_merge_df, REML=FALSE,lmerControl(optimizer = "nloptwrap",
                                   optCtrl = list(maxfun = 2e5, tol = 1e-2),
                                   ))
summary(model.outcome)

```

## E. behavioral PE

```{r}
clean_merge_df$PE =   clean_merge_df$RATING_outcome - clean_merge_df$RATING_expectation
# Lag expectation rating ______________________________________________________
# per run/ses/sub
data_a3lag <- clean_merge_df %>%
  group_by(sub,ses,run) %>%
  mutate(prev_trial.RATING_expectation = lag(RATING_expectation, n = 1, default = NA)) %>%
  mutate(next_trial.RATING_expectation = lead(RATING_expectation, n = 1, default = NA)) %>%
  mutate(ave.RATING_expectation = mean(RATING_expectation, na.rm = TRUE))
data_a3lag <- data_a3lag[!is.na(data_a3lag$ave.RATING_expectation),]
taskname = 'pain'
data_a3lag$next_trial.RATING_expect_fill = coalesce(data_a3lag$next_trial.RATING_expectation, data_a3lag$ave.RATING_expectation)
data_a3lag$prev_trial.RATING_expect_fill = coalesce(data_a3lag$prev_trial.RATING_expectation, data_a3lag$ave.RATING_expectation)

data_a3lag <- data_a3lag[data_a3lag$task == 'pain',]
# EXPECTUPDATE :: expectation (N) - expectation (N-1) ________________________
clean_merge_df <- data_a3lag %>%
  # group_by(sub,ses,run) %>%
  mutate(EXPECTUPDATE_NEXT =  next_trial.RATING_expect_fill-RATING_expectation )  %>%
  mutate(EXPECTUPDATE_NEXT_JEPMA =  (next_trial.RATING_expect_fill - RATING_expectation)/((PE)+1))
```

## F. PE plot

```{r message=FALSE, warning=FALSE}
################################################################################
# contrast coding ______________________________________________________________

data <- clean_merge_df
stim_con1 <- "STIM_linear"
stim_con2 <- "STIM_quadratic"
iv1 <- "CUE_high_gt_low"
dv <- "NPSpos"
subject <- "sub"

################################################################################
# linear model _________________________________________________________________
model_savefname <- file.path(
  analysis_dir,
  paste(
    "lmer_task-", taskname, "_rating-", dv_keyword, "_", as.character(Sys.Date()), "_cooksd.txt",
    sep = ""
  )
)

cooksd <- lmer_twofactor_cooksd(
  data,  taskname,  iv1,  stim_con1,  stim_con2,  dv,  subject = "sub",  dv_keyword,  model_savefname,  'random_intercept',
  print_lmer_output = FALSE
)
influential <- as.numeric(names(cooksd)[(cooksd > (4 / as.numeric(length(unique(
  data$sub
)))))])
data_screen <- data[-influential,]

################################################################################
# plot :: reorder column levels and names for plots ____________________________
data_screen$cue_name[data_screen$cue == "high_cue"] <-  "high cue"
data_screen$cue_name[data_screen$cue == "low_cue"] <-  "low cue"

data_screen$stim_name[data_screen$stimintensity == "high_stim"] <-  "high"
data_screen$stim_name[data_screen$stimintensity == "med_stim"] <-  "med"
data_screen$stim_name[data_screen$stimintensity == "low_stim"] <-  "low"

data_screen$stim_ordered <- factor(data_screen$stim_name, levels = c("low", "med", "high"))
data_screen$cue_ordered <- factor(data_screen$cue_name, levels = c("low cue", "high cue"))
model_iv1 <- "stim_ordered"
model_iv2 <- "cue_ordered"

################################################################################
# plot :: calculate mean and se  _______________________________________________
NPSstimcue_subjectwise <- meanSummary(data_screen,
                                      c(subject, model_iv1, model_iv2), dv)
NPSstimcue_groupwise <- summarySEwithin(
  data = NPSstimcue_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
NPSstimcue_groupwise$task <- taskname
signature_key <- "PE (Jepma)"
taskname <- "pain"
plot_keyword <- "stimulusintensity"
ggtitle_phrase <-  ""
data_screen$task = factor(data_screen$task)
plot_keys <- list(
    sub_mean = "mean_per_sub",
    group_mean = "mean_per_sub_norm_mean",
    legend_keyword = "stimulus intensity",
    se = "se",
    subject = "sub",
    ggtitle = paste0(
      str_to_title(signature_key),
      " dot product: ", str_to_title(taskname), ' ', ggtitle_phrase, " (N = ", length(unique(data_screen$sub)), ")"
    ),
    title = paste0(
      str_to_title(signature_key), " - ", str_to_title(plot_keyword)
    ),
    xlab = "",
    ylab = paste(signature_key, " (dot product)"),
    ylim = c(-250, 500)
  )

################################################################################
# Lineplots {.unlisted .unnumbered} ____________________________________________
fig.PE <- plot_lineplot_twofactor(NPSstimcue_groupwise,
                        iv1 = "stim_ordered", iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("#5D5C5C", "#941100"),
                        ggtitle = paste0( "PE", " (N = ", length(unique(data_screen$sub)), ")"
    ),
                        xlab = "Stimulus intensity", ylab = "PE")
fig.PE

```

## 1. Relationship between NPS and PE

```{r}
# demean NPS just i case
clean_merge_df <- clean_merge_df %>%
  dplyr::group_by(.data[["sub"]]) %>%
  select(everything())  %>%
  mutate(NPSpos_demean = .data[["NPSpos"]] - mean(.data[["NPSpos"]]))

# check range of value
range(clean_merge_df$NPSpos)
range(clean_merge_df$NPSpos_demean)
range(clean_merge_df$PE_mdl2)
```

### 1.1 lmer model 1 - NPSpos_demean ~ PE + (PE | sub) >> singular

- IV: PE (Jepma)
- DV: NPSpos (demean)
- random effects: random slopes, PE effects per subject

```{r}
library(optimx)
clean_merge_df$sub <- factor(clean_merge_df$sub)

model.NPSRL = lmer(NPSpos_demean ~ PE_mdl2 + (PE_mdl2| sub) , data = clean_merge_df,
                   REML = FALSE, lmerControl(optimizer ="Nelder_Mead"))
          # control = lmerControl(
          #                  optimizer ='optimx', optCtrl=list(method='L-BFGS-B')))
summary(model.NPSRL)
```

### 1.2 lmer model 2 - No demean: NPSpos ~ PE + ( PE | sub)

- IV: PE (Jepma)
- DV: NPSpos
- random effects: random intercepts per subject

```{r}
library(optimx)
model.NPSRL = lmer(NPSpos ~ PE_mdl2 + (PE_mdl2| sub) , data = clean_merge_df,
                   REML = FALSE, lmerControl(optimizer ="Nelder_Mead"))

summary(model.NPSRL)
```

model 2

```{r}
hist(clean_merge_df$PE_mdl2)
```

### 1.3 lmer model 3

- IV: PE (Jepma) _ Stim _ cue
- DV: NPSpos
- random effects: random intercepts per subject

```{r}
model.NPSRL = lmer(NPSpos ~ STIM_linear*cue*PE_mdl2 + STIM_quadratic*cue*PE_mdl2 +
                     (1 + STIM_linear | sub) , data = clean_merge_df,
                   REML = FALSE, lmerControl(optimizer ="Nelder_Mead"))
summary(model.NPSRL)
```

structure: sub, NPS, PE
subjectwise correlations

### 1.4 plot group level slope of PE & NPS, alongside subjectwise slopes

```{r}
library(ggplot2)

min_value <- -40
max_value <- 40
clean_merge_df$sub <- factor(clean_merge_df$sub)
ggplot(clean_merge_df, aes(x = PE_mdl2, y = NPSpos)) +
  geom_point(aes(colour = sub), size = .1) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .3, linetype = "dashed") +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = .5, color = "black") +  # Group regression line
  ylim(min_value, max_value) +  # Set y-axis limits
  theme_classic2()  # Use a theme with a white background

```

#### 1.4.1 subsetting medium intensity value - are the aforementioned effects mainly driven by the medium stimulus intensity?

```{r}
subset_med <- clean_merge_df[clean_merge_df$stimintensity == "med_stim", ]

min_value <- -40
max_value <- 40
subset_med$sub <- factor(subset_med$sub)
ggplot(subset_med, aes(x = PE_mdl2, y = NPSpos)) +
  geom_point(aes(colour = sub), size = .1) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .3, linetype = "dashed") +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = .5, color = "black") +  # Group regression line
  # ylim(min_value, max_value) +  # Set y-axis limits
  theme_classic2()  # Use a theme with a white background

```

#### 1.4.2 subsetting high intensity value - are the aforementioned effects mainly driven by the medium stimulus intensity?

```{r}
subset_high <- clean_merge_df[clean_merge_df$stimintensity == "high_stim", ]

min_value <- -40
max_value <- 40
subset_high$sub <- factor(subset_high$sub)
ggplot(subset_high, aes(x = PE_mdl2, y = NPSpos)) +
  geom_point(aes(colour = sub), size = .1) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .3, linetype = "dashed") +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = .5, color = "black") +  # Group regression line
  # ylim(min_value, max_value) +  # Set y-axis limits
  theme_classic2()  # Use a theme with a white background

```

#### 1.4.3 subsetting low intensity value - are the aforementioned effects mainly driven by the medium stimulus intensity?

```{r}
subset_low <- clean_merge_df[clean_merge_df$stimintensity == "low_stim", ]
min_value <- -40;max_value <- 40
subset_low$sub <- factor(subset_low$sub)
ggplot(subset_high, aes(x = PE_mdl2, y = NPSpos)) +
  geom_point(aes(colour = sub), size = .1) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .3, linetype = "dashed") +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = .5, color = "black") +  # Group regression line
  # ylim(min_value, max_value) +  # Set y-axis limits
  theme_classic2()  # Use a theme with a white background

```

## 2. Relationship between behavioral PE and NPS

```{r}
hist(clean_merge_df$beh_PE)
```

### 2.1 lmer model 1 - NPSpos_demean ~ PE + (PE | sub) >> singular

- IV: PE (beh)
- DV: NPSpos (demean)
- random effects: random slopes, PE effects per subject

```{r}
library(optimx)
clean_merge_df <- clean_merge_df %>%
  dplyr::group_by(.data[["sub"]]) %>%
  select(everything())  %>%
  mutate(NPSpos_demean = .data[["NPSpos"]] - mean(.data[["NPSpos"]]))
model.behPE1 = lmer(NPSpos ~ beh_PE + (beh_PE| sub) , data = clean_merge_df,
                   REML = FALSE, lmerControl(optimizer ="Nelder_Mead"))
summary(model.behPE1)
isSingular(model.behPE1)
```

### 2.2 lmer model 2 - No demean: NPSpos ~ PE + ( PE | sub)

- IV: PE (beh)
- DV: NPSpos
- random effects: random intercepts per subject

```{r}
library(optimx)
model.behPE2 = lmer(NPSpos ~ beh_PE + (beh_PE| sub) , data = clean_merge_df,
                   REML = FALSE, lmerControl(optimizer ="Nelder_Mead"))

summary(model.behPE2)
```

### 2.3 lmer model 3 - INCORRECT - PE is redundant with Stim and Cue

- IV: PE (beh) _ Stim _ cue
- DV: NPSpos
- random effects: random intercepts per subject

```{r}
model.behPE3 = lmer(NPSpos ~ STIM_linear*cue*beh_PE + STIM_quadratic*cue*beh_PE +
                     (1| sub) , data = clean_merge_df,
                   REML = FALSE, lmerControl(optimizer ="Nelder_Mead"))
summary(model.behPE3)
```

### 2.4 plot behavioral PE & NPS.

group level slope, alongside subjectwise slopes

```{r}
library(ggplot2)

min_value <- -40
max_value <- 40
clean_merge_df$sub <- factor(clean_merge_df$sub)
plot.PE_NPS <- ggplot(clean_merge_df, aes(x = beh_PE, y = NPSpos)) +
  geom_point(aes(colour = sub), size = .1) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .3, linetype = "dashed") +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = .5, color = "black") +  # Group regression line
  ylim(min_value, max_value) +  # Set y-axis limits
  theme_classic2()  # Use a theme with a white background
plot.PE_NPS
```

## 3. What did I submit to SfN?

- I Modeled the NPS as a function of PE, cue, and stim.
- A discussion on whether this is a valid model would help.
- NOTE: The significant results I report today are coming from a model with just NPS and PE.

### 3.1 test relationship between PE and cue type and stimintensity (06/16/2023)

```{r}
model.PENPS <- lmer(NPSpos ~ PE_mdl2*cue*stimintensity + (1|sub), data = clean_merge_df)
summary(model.PENPS)
```

### 3.2 plot using PE and NPS as a function of cue

```{r}

subjectwise_2dv <- meanSummary_2dv(clean_merge_df, c("sub","stimintensity", "cue"),
                                   "PE_mdl2", "NPSpos" )
plot.SfN_PE_NPS <- ggplot(data = subjectwise_2dv,
       aes(x = .data[["DV1_mean_per_sub"]],
           y = .data[["DV2_mean_per_sub"]],
           color = .data[["cue"]],
           # shape = .data[["stimintensity"]],
           # size = .5
           )) +
  geom_point(size = 2, alpha = .5  ) +
  ylim(-50,50) +
  xlim(-50,50) +
  coord_fixed() +
  scale_color_manual(values = c("high_cue" ="red","low_cue" =  "#5D5C5C"))+
  geom_abline(intercept = 0, slope = 1, color = "#373737", linetype = "dashed", linewidth = .5) +
  xlab("PE") +
  ylab("NPSpos")+
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    plot.subtitle = ggtext::element_textbox_simple(size = 1),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20)

  )
plot.SfN_PE_NPS
```

### 3.3 plot the relationship between PE and NPS as a function of cue and stimulus intensity

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

df_low = clean_merge_df[clean_merge_df$stimintensity == "low_stim", ]
low <-
  plot_twovariable(
    df_low, iv1 = "PE_mdl2", iv2 = "NPSpos",
    group = "cue", subject = "sub",
    xmin=-50, xmax=50, ymin=-50, ymax=50,
    xlab = "PE (jepma)", ylab = "NPSpos",
    ggtitle = "Low intensity",
    color_scheme = c("high_cue" ="#FF8800","low_cue" =  "#5D5C5C"),
    alpha = .8, fit_lm = TRUE, lm_method = "lm", identity_line = TRUE
  )

df_med = clean_merge_df[clean_merge_df$stimintensity == "med_stim", ]
med <-
  plot_twovariable(
    df_med, iv1 = "PE_mdl2", iv2 = "NPSpos",
    group = "cue", subject = "sub",
    xmin=-50, xmax=50, ymin=-50, ymax=50,
    xlab = "PE (jepma)", ylab = "NPSpos",
    ggtitle = "Medium intensity",
    color_scheme = c("high_cue" ="#DB6000","low_cue" =  "#5D5C5C"),
    alpha = .8, fit_lm = TRUE, lm_method = "lm", identity_line = TRUE
  )
df_high = clean_merge_df[clean_merge_df$stimintensity == "high_stim", ]
high <-
  plot_twovariable(
    df_high, iv1 = "PE_mdl2", iv2 = "NPSpos",
    group = "cue", subject = "sub",
    xmin=-50, xmax=50, ymin=-50, ymax=50,
    xlab = "PE (jepma)", ylab = "NPSpos",
    ggtitle = "High intensity",
    color_scheme = c("high_cue" ="#941100","low_cue" =  "#5D5C5C"),
    alpha = .8, fit_lm = TRUE, lm_method = "lm", identity_line = TRUE
  )
plots <- ggpubr::ggarrange(low, med, high, ncol = 3, nrow = 1, common.legend = FALSE, legend = "bottom")
plots_title <- annotate_figure(plots, top = text_grob("individual differences\n - cue effects from outcome ratings", color = "black", face = "bold", size = 15))
plots
```

## 4. Manipulation check: bin the Jepma PE levels and look at the relationship with behavioral PE

```{r echo=FALSE}
# df <- load_task_social_df(datadir,taskname = taskname,subject_varkey = subject_varkey,iv = iv,exclude = exclude  )
iv2 = "beh_PE"; levels = 10
iv1 = "PE_mdl2";
df_dropna <- clean_merge_df[!is.na(clean_merge_df[, iv1]) & !is.na(clean_merge_df[, iv2]), ]
k <-df_dropna %>% group_by(sub) %>% filter(n()>= 5) %>% ungroup()

clean_merge_df <- k %>%
  dplyr::group_by(.data[["sub"]]) %>%
  select(everything())  %>%
  mutate(
    bin = ggplot2::cut_interval(.data[[iv1]], n = levels),
    pelevels = as.numeric(cut_interval(.data[[iv1]], n = levels))
  )

swp <- ggplot(
  clean_merge_df,
  aes(y = beh_PE,
      x = pelevels,
      colour = subject),
  size = .01,
  color = 'gray'
) +
  geom_point(position = position_jitter(width = .1),size = .1, alpha = .3) +
  # geom_smooth(method = 'lm', formula= y ~ x, se = FALSE, size = .1) +
  geom_smooth(method = 'rlm', se = F, linewidth = .1, alpha = .5) +
  theme(axis.line = element_line(colour = "grey50"),
      panel.background = element_blank(),
      plot.subtitle = ggtext::element_textbox_simple(size= 11))

# ADD description
swp
```

## 5. Relationshipe between NPS and binned PE

### 5.1 lmer

- IV: PE (beh) _ Stim _ cue
- DV: NPSpos
- random effects: random intercepts per subject

```{r}
model.binPE <- lmer(NPSpos ~ pelevels + (pelevels|sub), data=clean_merge_df)
summary(model.binPE)
```

```{r}
model.binPE_cue_stim <- lmer(NPSpos ~ pelevels*cue*stimintensity + (pelevels|sub), data=clean_merge_df)
summary(model.binPE_cue_stim)
```

### 5.2. plot NPS and binned PE (jepma)

```{r}
iv1 = "PE_mdl2"; iv2 = "NPSpos"; levels = 10
k <-clean_merge_df %>% group_by(sub) %>% filter(n()>= 5) %>% ungroup()

clean_merge_df <- k %>%
  dplyr::group_by(.data[["sub"]]) %>%
  select(everything())  %>%
  mutate(
    bin = ggplot2::cut_interval(.data[[iv1]], n = levels),
    pelevels = as.numeric(cut_interval(.data[[iv1]], n = levels))
  )

# swp <- ggplot(
#   clean_merge_df,
#   aes(y = NPSpos,
#       x = pelevels,
#       colour = subject),
#   size = .01,
#   color = 'gray'
# ) +
#   geom_point(position = position_jitter(width = .1),size = .1, alpha = .3) +
#   # geom_smooth(method = 'lm', formula= y ~ x, se = FALSE, size = .1) +
#   geom_smooth(method = 'rlm', se = F, linewidth = .1, alpha = .5) +
#   theme(axis.line = element_line(colour = "grey50"),
#       panel.background = element_blank(),
#       plot.subtitle = ggtext::element_textbox_simple(size= 11))
# swp


ggplot(clean_merge_df, aes(x = pelevels, y = NPSpos)) +
  geom_point(aes(colour = sub), size = .1) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .3, linetype = "dashed") +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = .5, color = "black") +  # Group regression line
  ylim(min_value, max_value) +  # Set y-axis limits
xlab( "PE (binned)" ) + ylab("NPSpos") +
  theme_classic2()  # Use a theme with a white background

```

### 5.3 plot NPS and binned PE (within subjects: average within bins -> aggregate this at the group lvel)

```{r}
iv1 = "PE_mdl2"; iv2 = "NPSpos"; levels = 10
k <-clean_merge_df %>% group_by(sub) %>% filter(n()>= 5) %>% ungroup()

clean_merge_df <- k %>%
  dplyr::group_by(.data[["sub"]]) %>%
  select(everything())  %>%
  mutate(
    bin = ggplot2::cut_interval(.data[[iv1]], n = levels),
    pelevels = as.numeric(cut_interval(.data[[iv1]], n = levels))
  )
################################################################################
model_iv1 <- "pelevels"
model_iv2 <- "NPSpos"
dv <- "NPSpos"
clean_merge_df$pelevels <- factor(clean_merge_df$pelevels)
PEbin_subjectwise <- meanSummary(clean_merge_df,
                                      c(subject, model_iv1), dv)
PEbin_groupwise <- summarySEwithin(
  data = PEbin_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1), #, model_iv2),
  idvar = subject
)
PEbin_groupwise$task <- taskname
signature_key <- "PE (Jepma)"
taskname <- "pain"
plot_keyword <- "stimulusintensity"
ggtitle_phrase <-  ""
data_screen$task = factor(data_screen$task)
plot_keys <- list(
    sub_mean = "mean_per_sub",
    group_mean = "mean_per_sub_norm_mean",
    legend_keyword = "stimulus intensity",
    se = "se",
    subject = "sub",
    ggtitle = paste0(
      str_to_title(signature_key), " dot product: ", str_to_title(taskname), ' ', ggtitle_phrase, " (N = ", length(unique(data_screen$sub)), ")"
    ),
    title = paste0(str_to_title(signature_key), " - ", str_to_title(plot_keyword)),
    xlab = "",
    ylab = paste(signature_key, " (dot product)"),
    ylim = c(-250, 500)
  )

################################################################################
# Lineplots {.unlisted .unnumbered} ____________________________________________
fig.PE_jepmabin <- plot_lineplot_onefactor(PEbin_groupwise, taskname = "pain",
                        iv = model_iv1, #iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("#5D5C5C", "#941100"),
                        ggtitle = paste0( "PE (Jepma) ", " (N = ", length(unique(data_screen$sub)), ")"    ),
                        xlab = "PE (binned)",
                        ylab = "NPSpos")
fig.PE_jepmabin

```

```{r}
frequency_table <- table(clean_merge_df$sub, clean_merge_df$pelevels)
print(frequency_table)
heatmap(frequency_table)
```

### 5.4. plot NPS,binned PE and cue type

```{r}
iv1 = "PE_mdl2"; iv2 = "NPSpos"; levels = 10
k <-clean_merge_df %>% group_by(sub) %>% filter(n()>= 5) %>% ungroup()

clean_merge_df <- k %>%
  dplyr::group_by(.data[["sub"]]) %>%
  select(everything())  %>%
  mutate(
    bin = ggplot2::cut_interval(.data[[iv1]], n = levels),
    pelevels = as.numeric(cut_interval(.data[[iv1]], n = levels))
  )
################################################################################
model_iv1 <- "pelevels"
model_iv2 <- "cue"
dv <- "NPSpos"
clean_merge_df$pelevels <- factor(clean_merge_df$pelevels)
PEbin_subjectwise <- meanSummary(clean_merge_df,
                                      c(subject, model_iv1, model_iv2), dv)
PEbin_groupwise <- summarySEwithin(
  data = PEbin_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
PEbin_groupwise$task <- taskname
signature_key <- "PE (Jepma)"
taskname <- "pain"
plot_keyword <- "stimulusintensity"
ggtitle_phrase <-  ""
data_screen$task = factor(data_screen$task)
plot_keys <- list(
    sub_mean = "mean_per_sub",
    group_mean = "mean_per_sub_norm_mean",
    legend_keyword = "stimulus intensity",
    se = "se",
    subject = "sub",
    ggtitle = paste0(
      str_to_title(signature_key), " dot product: ", str_to_title(taskname), ' ', ggtitle_phrase, " (N = ", length(unique(data_screen$sub)), ")"
    ),
    title = paste0(str_to_title(signature_key), " - ", str_to_title(plot_keyword)),
    xlab = "",
    ylab = paste(signature_key, " (dot product)"),
    ylim = c(-250, 500)
  )

################################################################################
# Lineplots {.unlisted .unnumbered} ____________________________________________
fig.PE_beh <- plot_lineplot_twofactor(PEbin_groupwise, #taskname = "pain",
                        iv = model_iv1, iv2 = model_iv2,
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("#5D5C5C", "#941100"),
                        ggtitle = paste0( "PE (Jepma) ", " (N = ", length(unique(data_screen$sub)), ")"    ),
                        xlab = "PE (binned)",
                        ylab = "NPSpos")
fig.PE_beh

```

### 5.5 plot the relationship between PE and NPS as a function of cue and stimulus intensity

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
model_iv1 <- "pelevels"
model_iv2 <- "cue"
dv <- "NPSpos"


df_low = clean_merge_df[clean_merge_df$stimintensity == "low_stim", ]
PEbinlow_subjectwise <- meanSummary(df_low,
                                      c(subject, model_iv1, model_iv2), dv)
PEbinlow_groupwise <- summarySEwithin(
  data = PEbinlow_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
PEbinlow_groupwise$task <- taskname
low <- plot_lineplot_twofactor(PEbinlow_groupwise, #taskname = "pain",
                        iv = model_iv1, iv2 = model_iv2,
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("#5D5C5C", "#941100"),
                        ggtitle = paste0( "Stim intensity Low ", " (N = ", length(unique(data_screen$sub)), ")"    ),
                        xlab = "PE (binned)",
                        ylab = "NPSpos")

################################################################################
df_med = clean_merge_df[clean_merge_df$stimintensity == "med_stim", ]
PEbinmed_subjectwise <- meanSummary(df_med,
                                      c(subject, model_iv1, model_iv2), dv)
PEbinmed_groupwise <- summarySEwithin(
  data = PEbinmed_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
PEbinmed_groupwise$task <- taskname
med <- plot_lineplot_twofactor(PEbinmed_groupwise, #taskname = "pain",
                        iv = model_iv1, iv2 = model_iv2,
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("#5D5C5C", "#941100"),
                        ggtitle = paste0( "Stim intensity med ", " (N = ", length(unique(data_screen$sub)), ")"    ),
                        xlab = "PE (binned)",
                        ylab = "NPSpos")

################################################################################
df_high = clean_merge_df[clean_merge_df$stimintensity == "high_stim", ]
PEbinhigh_subjectwise <- meanSummary(df_high,
                                      c(subject, model_iv1, model_iv2), dv)
PEbinhigh_groupwise <- summarySEwithin(
  data = PEbinhigh_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
PEbinhigh_groupwise$task <- taskname
high <- plot_lineplot_twofactor(PEbinhigh_groupwise, #taskname = "pain",
                        iv = model_iv1, iv2 = model_iv2,
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("#5D5C5C", "#941100"),
                        ggtitle = paste0( "Stim intensity High ", " (N = ", length(unique(data_screen$subΩ)), ")"    ),
                        xlab = "PE (binned)",
                        ylab = "NPSpos")

################################################################################
plots <- ggpubr::ggarrange(low, med, high, ncol = 3, nrow = 1, common.legend = FALSE, legend = "bottom")
plots_title <- annotate_figure(plots, top = text_grob("individual differences\n - cue effects from outcome ratings", color = "black", face = "bold", size = 15))
plots
```

## scale the pelevel

```{r}


clean_merge_df <- clean_merge_df %>%
  group_by(sub) %>%
  mutate(Exp_mdl2_scaled = (Exp_mdl2 - mean(Exp_mdl2, na.rm = TRUE)) / sd(Exp_mdl2, na.rm = TRUE)) %>%
  mutate(PE_mdl2_scaled = (PE_mdl2 - mean(PE_mdl2, na.rm = TRUE)) / sd(PE_mdl2, na.rm = TRUE)) %>%
  mutate(RATING_expectation_scaled = (RATING_expectation - mean(RATING_expectation, na.rm = TRUE)) / sd(RATING_expectation, na.rm = TRUE)) %>%
  mutate(RATING_outcome_scaled = (RATING_outcome - mean(RATING_outcome, na.rm = TRUE)) / sd(RATING_outcome, na.rm = TRUE)) %>%
  ungroup()

iv1 = "PE_mdl2_scaled"; iv2 = "NPSpos"; levels = 10
k <-clean_merge_df %>% group_by(sub) %>% filter(n()>= 5) %>% ungroup()
clean_merge_df <- k %>%
  dplyr::group_by(.data[["sub"]]) %>%
  select(everything())  %>%
  mutate(
    bin = ggplot2::cut_interval(.data[[iv1]], n = levels),
    pelevels_scaled = as.numeric(cut_interval(.data[[iv1]], n = levels))
  )
################################################################################
model_iv1 <- "pelevels_scaled"
# model_iv2 <- "NPSpos"
dv <- "NPSpos"
clean_merge_df$pelevels_scaled <- factor(clean_merge_df$pelevels_scaled)
PEbin_subjectwise <- meanSummary(clean_merge_df,
                                      c(subject, model_iv1), dv)
PEbin_groupwise <- summarySEwithin(
  data = PEbin_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1), #, model_iv2),
  idvar = subject
)
PEbin_groupwise$task <- taskname
signature_key <- "PE (Jepma)"
taskname <- "pain"
plot_keyword <- "stimulusintensity"
ggtitle_phrase <-  ""
data_screen$task = factor(data_screen$task)
plot_keys <- list(
    sub_mean = "mean_per_sub",
    group_mean = "mean_per_sub_norm_mean",
    legend_keyword = "stimulus intensity",
    se = "se",
    subject = "sub",
    ggtitle = paste0(
      str_to_title(signature_key), " dot product: ", str_to_title(taskname), ' ', ggtitle_phrase, " (N = ", length(unique(data_screen$sub)), ")"
    ),
    title = paste0(str_to_title(signature_key), " - ", str_to_title(plot_keyword)),
    xlab = "",
    ylab = paste(signature_key, " (dot product)"),
    ylim = c(-250, 500)
  )

#

################################################################################
# Lineplots {.unlisted .unnumbered} ____________________________________________
fig.PE_jepmabin <- plot_lineplot_onefactor(PEbin_groupwise, taskname = "pain",
                        iv = model_iv1, #iv2 = "cue_ordered",
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("#5D5C5C", "#941100"),
                        ggtitle = paste0( "PE (Jepma) ", " (N = ", length(unique(data_screen$sub)), ")"    ),
                        xlab = "pelevels_scaled (binned)",
                        ylab = "NPSpos")
fig.PE_jepmabin

################################################################################
# plots with gorup level effect and random slopes
clean_merge_df$sub <- factor(clean_merge_df$sub)
plot.PE_NPS <- ggplot(clean_merge_df, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  geom_point(aes(colour = sub), size = .3, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .3, linetype = "dashed") +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 1, color = "black") +  # Group regression line
  ylim(min_value, max_value) +  # Set y-axis limits
  xlim(-5, 5) +
  theme(  # Then apply additional styling
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12)  # Set legend text size
  ) +
  xlab("Prediction Error") +
  ylab("Pain Biomarker (A.U.)")
  #theme_classic2()  # Use a theme with a white background
plot.PE_NPS
################################################################################
# plots with gorup level effect and random slopes - customized palettes!
library(ggplot2)
library(RColorBrewer)

# Define a color palette using RColorBrewer, which will be more suitable for many subjects
# 'Greys' can be changed to any other palette like 'Purples', 'Blues', 'Greens', etc.
# The number '60' should be equal to or greater than the number of subjects you have
palette <- brewer.pal(name = "OrRd", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))

plot.PE_NPS <- ggplot(clean_merge_df, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  # Your layers here
  scale_colour_manual(values = palette) + # Add this line to change colors
  # The rest of your theme and plot customizations
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-5, 5) +
  theme(  # Then apply additional styling
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12)  # Set legend text size
  ) +
  xlab("Prediction Error") +
  ylab("Pain Biomarker (A.U.)")
# If running in a script, explicitly print the plot
print(plot.PE_NPS)
plot.PE_NPS
plot.PE_NPS <- plot.PE_NPS + theme(aspect.ratio=.8)
ggsave(file.path(analysis_dir, "iv-PE-dv-NPS.png"), plot = plot.PE_NPS, bg = "transparent", device = "png")
################################################################################
# what's the frequency of each pe level?
frequency_table <- table(clean_merge_df$sub, clean_merge_df$pelevels_scaled)
print(frequency_table)
heatmap(frequency_table)
```

## SFN PE NPS

```{r}

model1<- lmer(NPSpos~PE_mdl2 + (PE_mdl2|sub), data = clean_merge_df, REML=TRUE,
                          lmerControl(optimizer = "Nelder_Mead",
                                   optCtrl = list(maxfun = 2e4, tol = 1e-3)))
summary(model1)
```

## 6. meeting

mediator: model based expectation.
cue
cue + exp_mdl2

```{r}
range(clean_merge_df$Exp_mdl2)
range(clean_merge_df$NPSpos)
hist(clean_merge_df$Exp_mdl2)
original_vector <- clean_merge_df$Exp_mdl2
#
# # Normalize your data to be between 0 and 1
# normalized_vector <- (original_vector - min(original_vector)) / (max(original_vector) - min(original_vector))
#
# # Apply a quantile transformation assuming a beta distribution
# # Specify your alpha (shape1) and beta (shape2) parameters for the beta distribution
# alpha <- 7
# beta <- 4
# clean_merge_df$beta_Exp_mdl2 <- qbeta(normalized_vector, shape1 = alpha, shape2 = beta)
#
# hist(clean_merge_df$beta_Exp_mdl2 )
```

```{r}
# bin simulated expectation ratings from Jepmap model
clean_merge_df_copy <- clean_merge_df
# clean_merge_df <- clean_merge_df_copy[clean_merge_df$sub != 74, ]
clean_merge_df <- clean_merge_df_copy[!clean_merge_df_copy$sub %in% c(74, 23, 129), ]

library(optimx)
iv1 = "RATING_expectation"; iv2 = "NPSpos"; levels = 10
k <-clean_merge_df %>% group_by(sub) %>% filter(n()>= 5) %>% ungroup()
clean_merge_df <- k %>%
  dplyr::group_by(.data[["sub"]]) %>%
  select(everything())  %>%
  mutate(
    bin = ggplot2::cut_interval(.data[[iv1]], n = levels),
    EXPlevels = as.numeric(cut_interval(.data[[iv1]], n = levels))
  )

# demean simulated expectation ratings from Jepmap model
clean_merge_df <- clean_merge_df %>%
  dplyr::group_by(.data[["sub"]]) %>%
  select(everything())  %>%
  mutate(Exp_mdl2_demean = .data[["Exp_mdl2"]] - mean(.data[["Exp_mdl2"]]))

# beta transform
original_vector <- clean_merge_df$Exp_mdl2
normalized_vector <- (original_vector - min(original_vector)) / (max(original_vector) - min(original_vector))
# Apply a quantile transformation assuming a beta distribution
# Specify your alpha (shape1) and beta (shape2) parameters for the beta distribution
alpha <- 2
beta <- 5
clean_merge_df$beta_Exp_mdl2 <- qbeta(normalized_vector, shape1 = alpha, shape2 = beta)

#
clean_merge_df <- clean_merge_df %>%
  group_by(sub) %>%
  mutate(Exp_mdl2_scaled = (Exp_mdl2 - mean(Exp_mdl2, na.rm = TRUE)) / sd(Exp_mdl2, na.rm = TRUE)) %>%
  mutate(RATING_expectation_scaled = (RATING_expectation - mean(RATING_expectation, na.rm = TRUE)) / sd(RATING_expectation, na.rm = TRUE)) %>%
  mutate(RATING_outcome_scaled = (RATING_outcome - mean(RATING_outcome, na.rm = TRUE)) / sd(RATING_outcome, na.rm = TRUE)) %>%
  ungroup()

################################################################################
clean_merge_df$ses <- factor(clean_merge_df$ses)
clean_merge_df$sub <- factor(clean_merge_df$sub)
clean_merge_df$stim <- factor(clean_merge_df$stim)
model.suggested = lmer(NPSpos ~ EXPlevels* STIM_linear + EXPlevels*STIM_quadratic
                       + ( EXPlevels* STIM_linear  | sub), data = clean_merge_df, REML=FALSE,
                       control = lmerControl(optimizer = "Nelder_Mead", boundary.tol = 1e-3))
                       # control = lmerControl(optimizer = "Nelder_Mead",
                       #              optCtrl = list(maxfun = 100000, # Increase max function evaluations
                       #                             tol = 1e-3),   # Decrease tolerance
                       #              check.conv.grad = .makeCC("warning", tol = 1e-3), # Adjust gradient check
                       #              check.conv.singular = .makeCC("warning", tol = 1e-3) # Adjust singularity check
                       #              ))
                         #lmerControl(optimizer = "Nelder_Mead",
                          #          optCtrl = list(maxfun = 2e3, tol = 1e-2)))
                       # nAGQ=20)
                       # control=lmerControl(optimizer="Nelder_Mead"))#"nlminbwrap"))
#"nloptwrap")) #"nlminbwrap"))
                   # REML = TRUE) #lmerControl(optimizer ="Nelder_Mead"))

# strict_tol <- lmerControl(optCtrl=list(xtol_abs=1e-8, ftol_abs=1e-8))
# if (all(model.suggested@optinfo$optimizer=="nloptwrap")) {
#     model.suggested.tol <- update(model.suggested, control=strict_tol)
# }
# fm1.all <- allFit(model.suggested)
summary(model.suggested)
vif(model.suggested)

```

```{r}
ggplot(clean_merge_df, aes(x = Exp_mdl3, y = NPSpos, color = STIM_linear)) +
  geom_point() +
  facet_wrap(~ sub, ncol = 20) +  # Adjust ncol to your desired number of columns
  labs(x = "Expectations values (dynamic model)", y = "NPS positive") +
  theme_minimal()

```

```{r}
ggplot(clean_merge_df, aes(x = Exp_mdl2, y = NPSpos, color = STIM_linear)) +
  geom_point() +
  facet_wrap(~ sub, ncol = 20) +  # Adjust ncol to your desired number of columns
  labs(x = "Expectations values (Jepma)", y = "NPS positive") +
  theme_minimal()

```

```{r}
trial_counts_df <- clean_merge_df %>%
  group_by(sub) %>%
  summarise(TrialCount = n())

# View the results
print(trial_counts_df)
```

```{r}
ggplot(clean_merge_df, aes(x = RATING_expectation, y = NPSpos, color = STIM_linear)) +
  geom_point() +
  facet_wrap(~ sub, ncol = 20) +  # Adjust ncol to your desired number of columns
  labs(x = "Expectations (behavioral)", y = "NPS positive") +
    theme_minimal() +
  theme(strip.text.x = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title = element_text(size = 10)) +
  theme_minimal()

```

```{r}
ggplot(clean_merge_df, aes(x = RATING_outcome, y = NPSpos, color = STIM_linear)) +
  geom_point() +
  facet_wrap(~ sub, ncol = 20) +  # Adjust ncol to your desired number of columns
  labs(x = "Outcome (behavioral)", y = "NPS positive") +
    theme_minimal() +
  theme(strip.text.x = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title = element_text(size = 10)) +
  theme_minimal()

```

```{r}
ggplot(clean_merge_df, aes(x = EXPlevels, y = NPSpos, color = STIM_linear)) +
  geom_point() +
  facet_wrap(~ sub, ncol = 20) +  # Adjust ncol to your desired number of columns
  labs(x = "Expectations (behavioral)", y = "NPS positive") +
    theme_minimal() +
  theme(strip.text.x = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title = element_text(size = 10)) +
  theme_minimal()

```

```{r}
model.suggested2 = lmer(NPSpos ~ Exp_mdl2* STIM_linear + Exp_mdl2*STIM_quadratic
                       + ( STIM_linear | sub) + (1|ses), data = clean_merge_df, REML=FALSE,
                       # nAGQ=20)
                       control=lmerControl(optimizer="Nelder_Mead"))#"nlminbwrap"))
# summarize_model(model.suggested, ci = FALSE)
summary(model.suggested2)
vif(model.suggested2)
```

```{r}
summary(fm1.all)
```

### plots

```{r}
################################################################################
# bin expectation ratings
iv1 = "Exp_mdl2"; iv2 = "NPSpos"; levels = 10
k <-clean_merge_df %>% group_by(sub) %>% filter(n()>= 5) %>% ungroup()
clean_merge_df <- k %>%
  dplyr::group_by(.data[["sub"]]) %>%
  select(everything())  %>%
  mutate(
    bin = ggplot2::cut_interval(.data[[iv1]], n = levels),
    EXPlevels = as.numeric(cut_interval(.data[[iv1]], n = levels))
  )

################################################################################
palette <- brewer.pal(name = "Reds", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))
df_high = clean_merge_df[clean_merge_df$stimintensity == "high_stim", ]
plot.PE_high<- ggplot(df_high, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  scale_colour_manual(values = palette) +
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-5, 5) +
  ggtitle("High intensity") +
  # coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12),  # Set legend text size
    legend.position = "none"
  ) +
  xlab("Prediction Error") +
  ylab("Pain Biomarker (A.U.)")

print(plot.PE_high)

################################################################################
palette <- brewer.pal(name = "OrRd", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))
df_med = clean_merge_df[clean_merge_df$stimintensity == "med_stim", ]
plot.PE_med<- ggplot(df_med, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  scale_colour_manual(values = palette) +
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-5, 5) +
  ggtitle("Medium intensity") +
  # coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12),  # Set legend text size
    legend.position = "none"
  ) +
  xlab("Prediction Error") +
  ylab("Pain Biomarker (A.U.)")

print(plot.PE_med)

################################################################################
palette <- brewer.pal(name = "Oranges", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))
df_low = clean_merge_df[clean_merge_df$stimintensity == "low_stim", ]
plot.PE_low<- ggplot(df_low, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  scale_colour_manual(values = palette) +
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-5, 5) +
  ggtitle("Low intensity") +
  # coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12),  # Set legend text size
    legend.position = "none"
  ) +
  xlab("Prediction Error") +
  ylab("Pain Biomarker (A.U.)")

print(plot.PE_low)

################################################################################
aspect_ratio <- 1
plots <- ggpubr::ggarrange(plot.PE_low, plot.PE_med, plot.PE_high, ncol = 3, nrow = 1, common.legend = FALSE, widths = c(3,3,3)) #, heights = c(1, 1, 1) * aspect_ratio  )
plots_title <- annotate_figure(plots) #, color = "black", face = "bold", size = 15)
plots

ggsave(file.path(analysis_dir, "combined_plots.png"), plots_title, width = 18, height = 5, units = "in")
```

## behavioral PE update

```{r}
# bin expectation ratings
iv1 = "RATING_expectation"; iv2 = "RATING_outcome"; levels = 10
k <-clean_merge_df %>% group_by(sub) %>% filter(n()>= 5) %>% ungroup()
clean_merge_df <- k %>%
  dplyr::group_by(.data[["sub"]]) %>%
  select(everything())  %>%
  mutate(
    bin = ggplot2::cut_interval(.data[[iv1]], n = levels),
    EXPlevels = as.numeric(cut_interval(.data[[iv1]], n = levels))
  )


model.aryan1108 <- lmer(RATING_outcome ~ EXPlevels*STIM_linear + EXPlevels*STIM_quadratic + (EXPlevels |sub), data = clean_merge_df)
summary(model.aryan1108 )
```

```{r}
################################################################################
# bin expectation ratings
iv1 = "RATING_expectation"; iv2 = "RATING_outcome"; levels = 10
k <-clean_merge_df %>% group_by(sub) %>% filter(n()>= 5) %>% ungroup()
clean_merge_df <- k %>%
  dplyr::group_by(.data[["sub"]]) %>%
  select(everything())  %>%
  mutate(
    bin = ggplot2::cut_interval(.data[[iv1]], n = levels),
    EXPlevels = as.numeric(cut_interval(.data[[iv1]], n = levels))
  )

################################################################################
palette <- brewer.pal(name = "Reds", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))
df_high = clean_merge_df[clean_merge_df$stimintensity == "high_stim" & clean_merge_df$cue == 'high_cue', ]
plot.PE_high<- ggplot(df_high, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  scale_colour_manual(values = palette) +
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-5, 5) +
  ggtitle("High intensity") +
  # coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12),  # Set legend text size
    legend.position = "none"
  ) +
  xlab("Expectation") +
  ylab("Pain rating")


print(plot.PE_high)

################################################################################
palette <- brewer.pal(name = "OrRd", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))
df_med = clean_merge_df[clean_merge_df$stimintensity == "med_stim" & clean_merge_df$cue == 'high_cue', ]
plot.PE_med<- ggplot(df_med, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  scale_colour_manual(values = palette) +
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-5, 5) +
  ggtitle("Medium intensity") +
  # coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12),  # Set legend text size
    legend.position = "none"
  ) +
  xlab("Expectation") +
  ylab("Pain rating")


print(plot.PE_med)

################################################################################
palette <- brewer.pal(name = "Oranges", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))
df_low = clean_merge_df[clean_merge_df$stimintensity == "low_stim" & clean_merge_df$cue == 'high_cue', ]
plot.PE_low<- ggplot(df_low, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  scale_colour_manual(values = palette) +
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-5, 5) +
  ggtitle("Low intensity") +
  # coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12),  # Set legend text size
    legend.position = "none"
  ) +
  xlab("Expectation") +
  ylab("Pain rating")


print(plot.PE_low)


################################################################################
### low cue
################################################################################
palette <- brewer.pal(name = "Blues", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))
df_high_lowcue = clean_merge_df[clean_merge_df$stimintensity == "high_stim" & clean_merge_df$cue == 'low_cue', ]
plot.PE_high_lowcue<- ggplot(df_high_lowcue, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  scale_colour_manual(values = palette) +
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-5, 5) +
  ggtitle("High intensity") +
  # coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12),  # Set legend text size
    legend.position = "none"
  ) +
  xlab("Expectation") +
  ylab("Pain rating")


print(plot.PE_high_lowcue)

################################################################################
palette <- brewer.pal(name = "BuGn", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))
df_med_lowcue = clean_merge_df[clean_merge_df$stimintensity == "med_stim"& clean_merge_df$cue == 'low_cue', ]
plot.PE_med_lowcue<- ggplot(df_med_lowcue, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  scale_colour_manual(values = palette) +
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-5, 5) +
  ggtitle("Medium intensity") +
  # coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12),  # Set legend text size
    legend.position = "none"
  ) +
  xlab("Expectation") +
  ylab("Pain rating")

print(plot.PE_med_lowcue)

################################################################################
palette <- brewer.pal(name = "BuPu", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))
df_low_lowcue = clean_merge_df[clean_merge_df$stimintensity == "low_stim"& clean_merge_df$cue == 'low_cue', ]
plot.PE_low_lowcue<- ggplot(df_low_lowcue, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  scale_colour_manual(values = palette) +
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-3, 3) +
  ggtitle("Low intensity") +
  # coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12),  # Set legend text size
    legend.position = "none"
  ) +
  xlab("Expectation") +
  ylab("Pain rating")


print(plot.PE_low_lowcue)
################################################################################
aspect_ratio <- 1
plots <- ggpubr::ggarrange(plot.PE_low, plot.PE_med, plot.PE_high, plot.PE_low_lowcue, plot.PE_med_lowcue, plot.PE_high_lowcue , ncol = 3, nrow = 2, common.legend = FALSE, widths = c(3,3,3)) #, heights = c(1, 1, 1) * aspect_ratio  )
plots_title <- annotate_figure(plots) #, color = "black", face = "bold", size = 15)
plots

ggsave(file.path(analysis_dir, "combined_plots_behPE.png"), plots_title, width = 18, height = 5, units = "in")
```

# 6.SfN NPS and expectation as a function of cue and stim

```{r}

################################################################################
# bin expectation ratings
iv1 = "RATING_expectation"; iv2 = "NPS"; levels = 10
k <-clean_merge_df %>% group_by(sub) %>% filter(n()>= 5) %>% ungroup()
clean_merge_df <- k %>%
  dplyr::group_by(.data[["sub"]]) %>%
  select(everything())  %>%
  mutate(
    bin = ggplot2::cut_interval(.data[[iv1]], n = levels),
    EXPlevels = as.numeric(cut_interval(.data[[iv1]], n = levels))
  )

################################################################################
palette <- brewer.pal(name = "Reds", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))
df_high = clean_merge_df[clean_merge_df$stimintensity == "high_stim" & clean_merge_df$cue == 'high_cue', ]
plot.PE_high<- ggplot(df_high, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  scale_colour_manual(values = palette) +
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-5, 5) +
  ggtitle("High intensity") +
  # coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12),  # Set legend text size
    legend.position = "none"
  ) +
  xlab("Expectation") +
  ylab("Pain rating")


print(plot.PE_high)

################################################################################
palette <- brewer.pal(name = "OrRd", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))
df_med = clean_merge_df[clean_merge_df$stimintensity == "med_stim" & clean_merge_df$cue == 'high_cue', ]
plot.PE_med<- ggplot(df_med, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  scale_colour_manual(values = palette) +
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-5, 5) +
  ggtitle("Medium intensity") +
  # coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12),  # Set legend text size
    legend.position = "none"
  ) +
  xlab("Expectation") +
  ylab("Pain rating")


print(plot.PE_med)

################################################################################
palette <- brewer.pal(name = "Oranges", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))
df_low = clean_merge_df[clean_merge_df$stimintensity == "low_stim" & clean_merge_df$cue == 'high_cue', ]
plot.PE_low<- ggplot(df_low, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  scale_colour_manual(values = palette) +
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-5, 5) +
  ggtitle("Low intensity") +
  # coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12),  # Set legend text size
    legend.position = "none"
  ) +
  xlab("Expectation") +
  ylab("Pain rating")


print(plot.PE_low)


################################################################################
### low cue
################################################################################
palette <- brewer.pal(name = "Blues", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))
df_high_lowcue = clean_merge_df[clean_merge_df$stimintensity == "high_stim" & clean_merge_df$cue == 'low_cue', ]
plot.PE_high_lowcue<- ggplot(df_high_lowcue, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  scale_colour_manual(values = palette) +
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-5, 5) +
  ggtitle("High intensity") +
  # coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12),  # Set legend text size
    legend.position = "none"
  ) +
  xlab("Expectation") +
  ylab("Pain rating")


print(plot.PE_high_lowcue)

################################################################################
palette <- brewer.pal(name = "BuGn", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))
df_med_lowcue = clean_merge_df[clean_merge_df$stimintensity == "med_stim"& clean_merge_df$cue == 'low_cue', ]
plot.PE_med_lowcue<- ggplot(df_med_lowcue, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  scale_colour_manual(values = palette) +
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-5, 5) +
  ggtitle("Medium intensity") +
  # coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12),  # Set legend text size
    legend.position = "none"
  ) +
  xlab("Expectation") +
  ylab("Pain rating")

print(plot.PE_med_lowcue)

################################################################################
palette <- brewer.pal(name = "BuPu", n = min(9, length(unique(clean_merge_df$sub))))
palette <- colorRampPalette(palette)(length(unique(clean_merge_df$sub)))
df_low_lowcue = clean_merge_df[clean_merge_df$stimintensity == "low_stim"& clean_merge_df$cue == 'low_cue', ]
plot.PE_low_lowcue<- ggplot(df_low_lowcue, aes(x = PE_mdl2_scaled, y = NPSpos)) +
  scale_colour_manual(values = palette) +
  geom_point(aes(colour = sub), size = 1, alpha = .2) +  # Points colored by subject
  geom_smooth(aes(colour = sub), method = 'lm', formula = y ~ x, se = FALSE, size = .5, linetype = "dashed", alpha=.5) +  # Subject-wise regression lines
  geom_smooth(method = 'lm', formula = y ~ x, se = FALSE, size = 2.5, color = "#4A4A49") +  # Group regression line
  ylim(-35, 35) +  # Set y-axis limits
  xlim(-3, 3) +
  ggtitle("Low intensity") +
  # coord_fixed(ratio = 1) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text = element_text(size = 15),  # Set axis text size
    axis.title = element_text(size = 25),  # Set axis title size
    legend.text = element_text(size = 12),  # Set legend text size
    legend.position = "none"
  ) +
  xlab("Expectation") +
  ylab("Pain rating")


print(plot.PE_low_lowcue)
################################################################################
aspect_ratio <- 1
plots <- ggpubr::ggarrange(plot.PE_low, plot.PE_med, plot.PE_high, plot.PE_low_lowcue, plot.PE_med_lowcue, plot.PE_high_lowcue , ncol = 3, nrow = 2, common.legend = FALSE, widths = c(3,3,3)) #, heights = c(1, 1, 1) * aspect_ratio  )
plots_title <- annotate_figure(plots) #, color = "black", face = "bold", size = 15)
plots

ggsave(file.path(analysis_dir, "combined_plots_behPE.png"), plots_title, width = 18, height = 5, units = "in")
```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
model_iv1 <- "Exp_mdl2_scaled"
model_iv2 <- "cue"
dv <- "NPSpos"


df_low = clean_merge_df[clean_merge_df$stimintensity == "low_stim", ]
PEbinlow_subjectwise <- meanSummary(df_low,
                                      c(subject, model_iv1), dv)
PEbinlow_groupwise <- summarySEwithin(
  data = PEbinlow_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1),
  idvar = subject
)
PEbinlow_groupwise$task <- taskname
low <- plot_lineplot_twofactor(PEbinlow_groupwise, #taskname = "pain",
                        iv = model_iv1,
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("#5D5C5C", "#941100"),
                        ggtitle = paste0( "Stim intensity Low ", " (N = ", length(unique(data_screen$sub)), ")"    ),
                        xlab = "PE (binned)",
                        ylab = "NPSpos")

################################################################################
df_med = clean_merge_df[clean_merge_df$stimintensity == "med_stim", ]
PEbinmed_subjectwise <- meanSummary(df_med,
                                      c(subject, model_iv1, model_iv2), dv)
PEbinmed_groupwise <- summarySEwithin(
  data = PEbinmed_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
PEbinmed_groupwise$task <- taskname
med <- plot_lineplot_twofactor(PEbinmed_groupwise, #taskname = "pain",
                        iv = model_iv1, iv2 = model_iv2,
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("#5D5C5C", "#941100"),
                        ggtitle = paste0( "Stim intensity med ", " (N = ", length(unique(data_screen$sub)), ")"    ),
                        xlab = "PE (binned)",
                        ylab = "NPSpos")

################################################################################
df_high = clean_merge_df[clean_merge_df$stimintensity == "high_stim", ]
PEbinhigh_subjectwise <- meanSummary(df_high,
                                      c(subject, model_iv1, model_iv2), dv)
PEbinhigh_groupwise <- summarySEwithin(
  data = PEbinhigh_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
PEbinhigh_groupwise$task <- taskname
high <- plot_lineplot_twofactor(PEbinhigh_groupwise, #taskname = "pain",
                        iv = model_iv1, iv2 = model_iv2,
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("#5D5C5C", "#941100"),
                        ggtitle = paste0( "Stim intensity High ", " (N = ", length(unique(data_screen$subΩ)), ")"    ),
                        xlab = "PE (binned)",
                        ylab = "NPSpos")

################################################################################
plots <- ggpubr::ggarrange(low, med, high, ncol = 3, nrow = 1, common.legend = FALSE, legend = "bottom")
plots_title <- annotate_figure(plots, top = text_grob("individual differences\n - cue effects from outcome ratings", color = "black", face = "bold", size = 15))
plots
```

## NOTE. check for duplicates

```{r}
# Assuming your dataframe is called 'df'
duplicates <- duplicated(clean_merge_df)

# To see if there are any duplicates at all
any(duplicates)

```

## 7. suggested mediation model

```{r}

detach_package <- function(pkg, character.only = FALSE)
{
  if(!character.only)
  {
    pkg <- deparse(substitute(pkg))
  }
  search_item <- paste("package", pkg, sep = ":")
  while(search_item %in% search())
  {
    detach(search_item, unload = TRUE, character.only = TRUE)
  }
}
#
# model.A = lmer(NPSpos ~ cue + (1| sub) , data = clean_merge_df,
#                    REML = FALSE, lmerControl(optimizer ="Nelder_Mead"))
#
# model.C = lmer(NPSpos ~ cue + Exp_mdl2 + (1 + Exp_mdl2 + stim| sub) , data = clean_merge_df,
#                    REML = FALSE, lmerControl(optimizer ="Nelder_Mead"))
#
# summary(model.suggested)
# getME(model.suggested,c("theta","beta")
# Y =
# fit.totaleffect <- lmer(Y ~ X1 +(1| ID)  + Xc2 + Xc3, data = df)
# fit.mediator    <- lmer(M ~ X1 +(1| ID)  + Xc2 + Xc3, data = df)
# fit.dv          <- lmer(Y ~ M + X1 +(1| ID)  + Xc2 + Xc3, data = df)
library(mediation)
detach_package(lmerTest)
fit.totaleffect <- lmer(NPSpos ~ CUE_high_gt_low +(1| sub)  + STIM_linear+STIM_quadratic, data = clean_merge_df)
fit.mediator    <- lmer(Exp_mdl2_scaled ~ CUE_high_gt_low + (1|sub) +STIM_linear+STIM_quadratic, data = clean_merge_df)
fit.dv          <- lmer(NPSpos ~ Exp_mdl2_scaled + CUE_high_gt_low +(1|sub)  +STIM_linear+STIM_quadratic, data = clean_merge_df)
# summary(fit.mediator)

results <- mediation::mediate(fit.mediator, fit.dv, treat='CUE_high_gt_low', mediator='Exp_mdl2_scaled')
```

## 8. predictive coding

```{r}
model.PEcoding <- lmer(Exp_mdl2_scaled ~ PE_mdl2 + (PE_mdl2|sub), data = clean_merge_df)
summary(model.PEcoding)
```

```{r}
################################################################################
model.predictivecoding = lmer(NPSpos ~ Exp_mdl2_scaled + PE_mdl2 + (Exp_mdl2_scaled + PE_mdl2| sub), data = clean_merge_df,
                       control=lmerControl(optimizer="nlminbwrap"))
                   # REML = TRUE) #lmerControl(optimizer ="Nelder_Mead"))

summary(model.predictivecoding)

```

```{r}
model.suggested_augmented = lmer(NPSpos ~ cue + RATING_expectation_scaled + STIM_linear + STIM_quadratic + RATING_outcome_scaled
                       + (1 + RATING_expectation + STIM_linear + RATING_outcome| sub), data = clean_merge_df,
                       control=lmerControl(optimizer="nlminbwrap"))
                   # REML = TRUE) #lmerControl(optimizer ="Nelder_Mead"))
print("\nVIF from model 1\n")
print(vif(model.suggested_augmented))
# summary(model.suggested_augmented)

model.suggested_augmented2 = lmer(NPSpos ~ cue + RATING_expectation_scaled + STIM_linear + STIM_quadratic + RATING_outcome_scaled
                       + (1 + RATING_expectation + STIM_linear + RATING_outcome| sub), data = clean_merge_df,
                       control=lmerControl(optimizer="nlminbwrap"))
                   # REML = TRUE) #lmerControl(optimizer ="Nelder_Mead"))
print("\nVIF from model\n")
print(vif(model.suggested_augmented2))
summary(model.suggested_augmented2)
```

# write csv

```{r}
# Assuming your dataframe is called 'df'
# And the column you're checking is 'some_column'
# And the value you want to drop is 'value_to_drop'

df_clean_merge_df <- clean_merge_df[clean_merge_df$sub != 23, ]

write.csv(df_clean_merge_df , file.path(main_dir, "data", "hlm", 'cleanmerge_NPS_RL.csv'))
```

##### mediation

```{r}
# install.packages("lme4")
# install.packages("merTools")
library(lme4)
library(merTools)
med.model <- lmer(NPSpos ~ RATING_expectation + STIM + (1 | sub), data = clean_merge_df)

dv.model <- lmer(RATING_outcome ~ NPSpos + RATING_expectation + STIM + (1 | sub), data = clean_merge_df)
# Extract coefficients (fixed effects)
med.coef_EXP <- fixef(med.model)["RATING_expectation"]
med.coef_STIM <- fixef(med.model)["STIM"]
out.coef_NPS <- fixef(dv.model)["NPSpos"]

# Compute indirect effects
indirect_effect_EXP <- med.coef_EXP * out.coef_NPS
indirect_effect_STIM <- med.coef_STIM * out.coef_NPS
# Example of bootstrapping for EXP's indirect effect on PAIN through NPS
boot <- merTools::predictInterval(med.model, n.sims = 1000, level = 0.95, type = "linear.prediction", which = "fixed")

# Calculate the indirect effect for each simulation
boot_indirect_effects <- boot$fit * fixef(dv.model)["NPSpos"]

# Obtain the confidence interval from the bootstrapped indirect effects
boot_ci <- quantile(boot_indirect_effects, probs = c(0.025, 0.975))

```

```{r}
install.packages("semPlot")
library(semPlot)
# Assuming you have the following coefficients
# a1 (EXP -> NPS), a2 (STIM -> NPS), b (NPS -> PAIN),
# c' (EXP -> PAIN), and c' (STIM -> PAIN) direct effects without mediator
# c (EXP -> PAIN) and c (STIM -> PAIN) total effects
a1 <- med.coef_EXP
a2 <- med.coef_STIM
b <- out.coef_NPS
c <-

# Create a data frame with the paths and coefficients
path_coefficients <- data.frame(
  from = c("EXP", "STIM", "NPS", "EXP", "STIM"),
  to = c("NPS", "NPS", "PAIN", "PAIN", "PAIN"),
  est = c(a1, a2, b, c_prime1, c_prime2),
  label = c("a1", "a2", "b", "c'", "c'")
)

# If you have calculated total effects 'c', you can add them as well
semPaths(
  path_coefficients,
  whatLabels = "est", # Use estimated coefficients for labels
  edge.label.cex = 0.75, # Adjust the size of the edge labels
  layout = "tree" # Choose a layout that fits your model
)

```

#### mediation 1

```{r}
mediationmodel.lmer <- lmer(formula = RATING_outcome ~ 0 +
                              NPSpos + RATING_expectation +

                                (1|sub)
                              ,
                  data=clean_merge_df)
#viewing and putting model summary into an object

(medmodelsummary <- summary(mediationmodel.lmer))
```

```{r}
# X1, RATING_expect
# X2, STIM
# M, NPSpos
# Y, RATING_outcome
###################
# model layout
# X1 X2 -> M -> Y
# M = a1*X1
# M = a1*X1 + a2*X2
# Y = c1*X1 + c2*X2 + b1*M
#################
myModel <- '
RATING_outcome ~ b1*NPSpos + c1*RATING_expectation + c2*STIM_linear
NPSpos ~ a1*RATING_expectation + a2*STIM_linear
#indirect effects
indirect1:=a1 * b1
indirect2:= a2 * b1
# total effect
total1:=c1 + (a1 * b1)
total2:= c2 + (a2 * b1) '

library("lavaan")
fit <- sem(myModel,
    data=clean_merge_df,
    se = "bootstrap",
    bootstrap = 1000,
    control = list(optCtrl = list(tol = 1e-3)))
```

```{r}
# Y ~ b2 * NPSpos + c2*STIM
myModel <- '
Y ~ b1 * M1 + b2 * M2 + c1 * X1 + c2 * X2 + c3 * C

M1 ~ a1 * X1 + a2 * X2 + a5 * C

M2 ~ a3 * X1 + a4 * X2 + a6 * C
#indirect effects
indirect1 := a1 * b1
indirect2 := a3 * b2
indirect3 := a2 * b1
indirect4 := a4 * b2
# contrasts
con1 := a1 * b1 - a3 * b2
con2 := a2 * b1 - a4 * b2
con3 := (a1-a2) * b1
con4 := (a3-a4) * b2
# total effect
total1 := c1 + (a1 * b1) + (a3 * b2)
total2 := c2 + (a2 * b1) + (a4 * b2)
total3 := c3 + (a5 * b1) + (a6 * b2)
# covariates
M1 ~~ M2
```
