# beh :: expectation ~ cue {#beh-expect-cue}


## What is the purpose of this notebook? {.unlisted .unnumbered}

Here, I plot the expectation ratings as a function of cue.

- Main model: `lmer(expect_rating ~ cue)`
- Main question: do expectations ratings differ as a function of cue type?
- If there is a main effect of cue on expectation ratings, does this cue effect differ depending on task type?
- IV: cue (high / low)
- DV: expectation rating

Also, Do those who have larger IQRs for expectation ratings also show greater cue effects?

```{r load_libraries_1, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(psych)
library(car)
library(lme4)
library(lmerTest)
library(plyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(png)
library(knitr)
library(TMB)
library(sjPlot)
library(ggpubr)
library(gridExtra)
library(merTools)
library(sjstats) #to get ICC
library(broom)
library(tidyverse)
library(GGally)
library(RCurl)
library(rstanarm)
library(reshape)
library(boot)
library(afex)
library(cowplot)
library(readr)
library(rmarkdown)
library(stringr)
library(gghalves)
library(ggpubr)
source("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")
main_dir = dirname(dirname(getwd()))
file.sources = list.files(file.path(main_dir, "scripts/step02_R/utils"),
                          pattern="*.R",
                          full.names=TRUE,
                          ignore.case=TRUE)
sapply(file.sources,source,.GlobalEnv)
```

```{r parameters, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
main_dir = dirname(dirname(getwd()))
print(main_dir)
datadir = file.path(main_dir, 'data', 'beh', 'beh02_preproc')
analysis_dir = file.path(main_dir, 'analysis', 'mixedeffect', "model02_iv-cue_dv-expect", as.character(Sys.Date()))
```

```{r}
for (taskname in c("pain", "vicarious", "cognitive")) {
    dv_keyword <- "expect"
    model_savefname <- file.path(
        analysis_dir,
        paste("lmer_task-", taskname,
            "_rating-", dv_keyword,
            "_", as.character(Sys.Date()), ".txt",
            sep = ""
        )
    )
    iv <- "param_stimulus_type"
    dv <- "event02_expect_angle"
    subject_varkey <- "src_subject_id"

    print_lmer_output = TRUE
    exclude <- "sub-0001|sub-0999"
    # load data, run model, and exclude outliers
    data <- df_load_beh(datadir, taskname, subject_varkey, iv, dv, exclude)

    data$subject = factor(data$src_subject_id)
    data$stim_name[data$param_stimulus_type == "high_stim"] <- "high"
    data$stim_name[data$param_stimulus_type == "med_stim"] <- "med"
    data$stim_name[data$param_stimulus_type == "low_stim"] <- "low"

    data$stimlin[data$param_stimulus_type == "high_stim"] <- 0.5
    data$stimlin[data$param_stimulus_type == "med_stim"] <- 0
    data$stimlin[data$param_stimulus_type == "low_stim"] <- -0.5

    data$stimquad[data$param_stimulus_type == "high_stim"] <- -0.34
    data$stimquad[data$param_stimulus_type == "med_stim"] <- 0.66
    data$stimquad[data$param_stimulus_type == "low_stim"] <- -0.34

        data$cue_name[data$param_cue_type == "high_cue"] <- "high"
    data$cue_name[data$param_cue_type == "low_cue"] <- "low"

            data$cue_con[data$param_cue_type == "high_cue"] <- 0.5
    data$cue_con[data$param_cue_type == "low_cue"] <- -0.5
    # DATA$levels_ordered <- factor(DATA$param_stimulus_type, levels=c("low", "med", "high"))

    data$stim_ordered <- factor(
        data$stim_name,
        levels = c("low", "med", "high")
    )
    iv <- "stim_ordered"
    dv <- "event02_expect_angle"
    print(taskname)
    model <- lmer(event02_expect_angle ~ cue_con + (1|src_subject_id), data = data)
    print(summary(model))
}
```

```{r ARCHIVE_originalfunction_forloop, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
for (taskname in c("pain", "vicarious", "cognitive")) {
    model_savefname <- file.path(
        analysis_dir,
        paste("lmer_task-", taskname,
            "_rating-", dv_keyword,
            "_", as.character(Sys.Date()), ".txt",
            sep = ""
        )
    )
    iv = "param_stimulus_type"
    print_lmer_output = TRUE
    # load data, run model, and exclude outliers
    data <- df_load_beh(datadir, taskname, subject_varkey, iv, dv, exclude)



    data$subject = factor(data$src_subject_id)
    data$stim_name[data$param_stimulus_type == "high_stim"] <- "high"
    data$stim_name[data$param_stimulus_type == "med_stim"] <- "med"
    data$stim_name[data$param_stimulus_type == "low_stim"] <- "low"

    data$stimlin[data$param_stimulus_type == "high_stim"] <- 0.5
    data$stimlin[data$param_stimulus_type == "med_stim"] <- 0
    data$stimlin[data$param_stimulus_type == "low_stim"] <- -0.5

    data$stimquad[data$param_stimulus_type == "high_stim"] <- -0.34
    data$stimquad[data$param_stimulus_type == "med_stim"] <- 0.66
    data$stimquad[data$param_stimulus_type == "low_stim"] <- -0.34

        data$cue_name[data$param_cue_type == "high_cue"] <- "high"
    data$cue_name[data$param_cue_type == "low_cue"] <- "low"

            data$cue_con[data$param_cue_type == "high_cue"] <- 0.5
    data$cue_con[data$param_cue_type == "low_cue"] <- -0.5
    # DATA$levels_ordered <- factor(DATA$param_stimulus_type, levels=c("low", "med", "high"))

    data$stim_ordered <- factor(
        data$stim_name,
        levels = c("low", "med", "high")
    )
    iv <- "stim_ordered"
    dv <- "event02_expect_angle"
    dv_keyword <- "expect"
    model <- lmer(event02_expect_angle ~ cue_con + (1|src_subject_id), data = data)
    anova(model)
    cooksd <- lmer_onefactor_cooksd(
        data, taskname, iv, dv, subject, dv_keyword, model_savefname, print_lmer_output
    )
    influential <- as.numeric(names(cooksd)[
    (cooksd > (4 / as.numeric(length(unique(data$subject)))))])
    data_screen <- data[-influential, ]
    # summary statistics
    subjectwise <- meanSummary(data_screen, c(subject, iv), dv)
    groupwise <- summarySEwithin(
        data = subjectwise,
        measurevar = "mean_per_sub", # variable created from above
        withinvars = c(iv), # iv
        idvar = "subject"
    )

    subjectwise_mean <- "mean_per_sub";    group_mean <- "mean_per_sub_norm_mean"
    se <- "se";    subject <- "subject"
    ggtitle <- paste(taskname, " - Expectation Rating (degree)");    title <- paste(taskname, " - Expect")
    xlab <- "";    ylab <- "ratings (degree)";
    w = 5; h = 3; dv_keyword <- "expect"
    if (any(startsWith(dv_keyword, c("expect", "Expect")))) {
        color_scheme <- c("#1B9E77", "#D95F02")
    } else {
        color_scheme <- c("#4575B4", "#D73027")
    }
    plot_savefname <- file.path(
        analysis_dir,
        paste("raincloud_task-", taskname,
            "_rating-", dv_keyword,
            "_", as.character(Sys.Date()), ".png",
            sep = ""
        )
    )
    plot_rainclouds_onefactor(
        subjectwise, groupwise,
        iv, subjectwise_mean, group_mean, se, subject,
        ggtitle, title, xlab, ylab, task_name,ylim,
        w, h, dv_keyword, color_scheme, plot_savefname
    )
randEffect$newcoef <- mapvalues(randEffect$term,
    from = c("(Intercept)",
             "data[, iv]low_cue"
             ),
    to = c("rand_intercept", "rand_cue")
)

rand_subset <- subset(randEffect, select = -c(grpvar, term, condsd))
wide_rand <- spread(rand_subset, key = newcoef, value = condval)

wide_fix <- do.call(
    "rbind",
    replicate(nrow(wide_rand),
        as.data.frame(t(as.matrix(fixEffect))),
        simplify = FALSE
    )
)
rownames(wide_fix) <- NULL
new_wide_fix <- dplyr::rename(wide_fix,
    fix_intercept = `(Intercept)`,
    fix_cue = `data[, iv]low_cue`,
)

total <- cbind(wide_rand, new_wide_fix)
total$task <- taskname
new_total <- total %>% dplyr::select(task, everything())
new_total <- dplyr::rename(total, subj = grp)

rand_savefname <- file.path(
    analysis_dir,
    paste("randeffect_task-", taskname, "_",
        as.character(Sys.Date()), "_outlier-cooksd.csv",
        sep = ""
    )
)
write.csv(new_total, rand_savefname, row.names = FALSE)
}
```

```{r common_parameters, message=FALSE, warning=FALSE, paged.print=FALSE}
# parameters _____________________________________ # nolint
subject_varkey <- "src_subject_id"
iv <- "param_cue_type"; iv_keyword <- "cue"; dv <- "event02_expect_angle"; dv_keyword <- "expect"
xlab <- ""; ylim = c(0,180); ylab <- "ratings (degree)"
subject <- "subject"
exclude <- "sub-0001|sub-0003|sub-0004|sub-0005|sub-0025|sub-0999"
subjectwise_mean <- "mean_per_sub"; group_mean <- "mean_per_sub_norm_mean"; se <- "se"
color_scheme <-     if (any(startsWith(dv_keyword, c("expect", "Expect")))) {
        color_scheme <- c("#1B9E77", "#D95F02")
    } else {
        color_scheme <- c("#4575B4", "#D73027")
    }
print_lmer_output <- FALSE
ggtitle_phrase <- " - Expectation Rating (degree)"
analysis_dir <- file.path(main_dir, "analysis", "mixedeffect", "model01_iv-cue_dv-expect", as.character(Sys.Date()))
dir.create(analysis_dir, showWarnings = FALSE, recursive = TRUE)
```

```{r ggplotfunction, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
ggplot_onefactor_pertask <- function(taskname, subject_varkey, subject, exclude,
                                     analysis_dir, iv, dv, dv_keyword,
                                     subjectwise_mean, group_mean, se,
                                     xlab, ylim, ylab, ggtitle_phrase, print_lmer_output) {
    ## designate where the lmer output lives
    model_savefname <- file.path(
        analysis_dir, paste("lmer_task-", taskname,"_iv-", iv_keyword, "_dv-rating-", dv_keyword,"_", as.character(Sys.Date()), ".txt",
            sep = ""))
    ## load data, run model, and exclude outliers
    data <- df_load_beh(datadir, taskname, subject_varkey, iv, dv, exclude)
    data$subject = factor(data$src_subject_id)
    data = data[!is.na(data[, dv] ),] # removing NA values
    #print(length(unique(data$subject)))
    #sink()
    cooksd <- lmer_onefactor_cooksd(data, taskname, iv, dv, subject, dv_keyword, model_savefname, print_lmer_output) # run lmer
    influential <- as.numeric(names(cooksd)[
    (cooksd > (4 / as.numeric(length(unique(data$subject)))))])
    data_screen <- data[-influential, ]

    ## summary statistics
    subjectwise <- meanSummary(data_screen, c(subject, iv), dv)
    groupwise <- summarySEwithin(
        data = subjectwise,
        measurevar = subjectwise_mean, # variable created from above
        withinvars = c(iv), # iv
        idvar = "subject"
    )

    ## designate plot save location
    ggtitle <- paste0(str_to_title(taskname), ggtitle_phrase, " N = (", length(unique(data$subject)), ")");
    title <- paste0(str_to_title(taskname), " - ", str_to_title(dv_keyword))
    w = 5; h = 3;
    plot_savefname <- file.path(analysis_dir,
                                paste0("raincloud_task", taskname,"iv-", iv_keyword, "_dv-rating-", dv_keyword,"_", as.character(Sys.Date()), ".png")
                                )

    # plot_rainclouds_onefactor
    p1 <- plot_halfrainclouds_onefactor(
        subjectwise, groupwise,
        iv, subjectwise_mean, group_mean, se, subject,
        ggtitle, title, xlab, ylab, task_name,ylim,
        w, h, dv_keyword, color_scheme, plot_savefname
    )
randEffect$newcoef <- mapvalues(randEffect$term,
    from = c(as.character(unique(randEffect$term)[1]),
             as.character(unique(randEffect$term)[2])
             ),
    to = c("rand_intercept", "rand_cue")
)

rand_subset <- subset(randEffect, select = -c(grpvar, term, condsd))
wide_rand <- spread(rand_subset, key = newcoef, value = condval)

wide_fix <- do.call(
    "rbind",
    replicate(nrow(wide_rand),
        as.data.frame(t(as.matrix(fixEffect))),
        simplify = FALSE
    )
)
rownames(wide_fix) <- NULL
new_wide_fix <- dplyr::rename(wide_fix,
    fix_intercept = colnames(wide_fix)[1],
    fix_cue = colnames(wide_fix)[2],
)

total <- cbind(wide_rand, new_wide_fix)
total$task <- taskname
new_total <- total %>% dplyr::select(task, everything())
new_total <- dplyr::rename(total, subj = grp)

rand_savefname <- file.path(
    analysis_dir,
    paste("randeffect_task-", taskname, "_",
        as.character(Sys.Date()), "_outlier-cooksd.csv",
        sep = ""
    )
)
write.csv(new_total, rand_savefname, row.names = FALSE)
return(p1)
}
```

## Pain

### For the pain task, what is the effect of cue on expectation ratings? {.unlisted .unnumbered}

[ INSERT DESCRIPTION ]

```{r pain_iv-cue_dv-expect, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
taskname = 'pain'
ggplot_onefactor_pertask(taskname, subject_varkey, subject, exclude,
                                     analysis_dir, iv, dv, dv_keyword,
                                     subjectwise_mean, group_mean, se,
                                     xlab, ylim, ylab, ggtitle_phrase, print_lmer_output)
```

## Vicarious

### For the vicarious task, what is the effect of cue on expectation ratings? {.unlisted .unnumbered}

[ INSERT DESCRIPTION ]

```{r vicarious_iv-cue_dv-expect, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
taskname = 'vicarious'
ggplot_onefactor_pertask(taskname, subject_varkey, subject, exclude,
                                     analysis_dir, iv, dv, dv_keyword,
                                     subjectwise_mean, group_mean, se,
                                     xlab, ylim, ylab, ggtitle_phrase, print_lmer_output)
```

## Cognitive

### For the cognitive task, what is the effect of cue on expectation ratings? {.unlisted .unnumbered}

[ INSERT DESCRIPTION ]

```{r cognitive_iv-cue_dv-expect, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
taskname = 'cognitive'
ggplot_onefactor_pertask(taskname, subject_varkey, subject, exclude,
                                     analysis_dir, iv, dv, dv_keyword,
                                     subjectwise_mean, group_mean, se,
                                     xlab, ylim, ylab, ggtitle_phrase, print_lmer_output)
```

```{r random_effects, message=FALSE, warning=TRUE, include=FALSE, paged.print=FALSE}
# test function
rand_dir <- file.path(main_dir, "analysis", "mixedeffect", "model01_iv-cue_dv-expect", as.character(Sys.Date()))
dir.create(rand_dir, showWarnings = FALSE, recursive = TRUE)
dfP <- read.csv(file.path(
    rand_dir,
    paste("randeffect_task-pain", "_", as.character(Sys.Date()), "_outlier-cooksd.csv", sep = "")
))
dfV <- read.csv(file.path(
    rand_dir,
    paste("randeffect_task-vicarious", "_", as.character(Sys.Date()), "_outlier-cooksd.csv", sep = "")
))
dfC <- read.csv(file.path(
    rand_dir,
    paste("randeffect_task-cognitive", "_", as.character(Sys.Date()), "_outlier-cooksd.csv", sep = "")
))

pvc <- merge_recurse(list(dfP, dfV, dfC))

save_fname <- file.path(
    analysis_dir,
    paste("randeffect_task-all_",
        as.character(Sys.Date()), ".csv",
        sep = ""
    )
)
write.csv(pvc, save_fname, row.names = FALSE)
```

## Individual difference analysis

### Are cue effects (on expectation ratings) similar across tasks? {.unlisted .unnumbered}

> Using the random slopes of cue effects, here we plot them side by side
> with all three tasks of pain, cognitive, vicarious. As we can see, there
> is a high correlation across the random effects of cue across
> pain-cognitive, pain-vicarious, and cognitive-vicarious. These plots
> suggest a universal mechansim in the cue-expectancy effect, although
> some may critic that the cues were identical across tasks, thereby the
> cue effects are identical due to the stimuli itself, not necessarily a
> domain-general expectation process.

```{r random effects scatter plot, echo=FALSE, message=FALSE, paged.print=FALSE}
pvc_rand_cue_subset <- subset(pvc, select = c(task, subj, rand_cue))
pvc_rand_cue <- spread(pvc_rand_cue_subset, key = task, value = rand_cue)
# plot individually
pv <- plot_ggplot_correlation(data = pvc_rand_cue, x = 'vicarious', y = 'pain', p_acc = 0.001, r_acc = 0.01, limit_min = -40, limit_max = 40, label_position = 38)
vc <- plot_ggplot_correlation(data = pvc_rand_cue, x = 'cognitive', y = 'vicarious', p_acc = 0.001, r_acc = 0.01, limit_min = -40, limit_max = 40, label_position = 38)
cp <- plot_ggplot_correlation(data = pvc_rand_cue, x = 'pain', y = 'cognitive', p_acc = 0.001, r_acc = 0.01, limit_min = -40, limit_max = 40, label_position = 38)
# combine plots and add title
plots <- ggpubr::ggarrange(pv, vc, cp, ncol = 3, nrow = 1, common.legend = FALSE, legend = "bottom")
plots_title <- annotate_figure(plots, top = text_grob("individual differences\n - cue effects from expectation ratings", color = "black", face = "bold", size = 15))
save_plotname <- file.path(
    analysis_dir,
    paste("randeffect_scatterplot_task-all_",
        as.character(Sys.Date()), ".png",
        sep = ""
    )
)
ggsave(save_plotname, width = 10, height = 3)
plots
```
