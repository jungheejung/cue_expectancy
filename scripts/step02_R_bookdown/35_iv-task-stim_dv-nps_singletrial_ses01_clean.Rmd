# [fMRI] NPSses01ses03 ~ singletrial {#ch35_singletrial_Pses01ses03clean}


## What is the purpose of this notebook? {.unlisted .unnumbered}

* Here, I model NPS dot products as a function of cue, stimulus intensity and expectation ratings. 
* One of the findings is that low cues lead to higher NPS dotproducts in the high intensity group, and that this effect becomes non-significant across sessions. 
* 03/23/2023: For now, I'm grabbing participants that have complete data, i.e. 18 runs, all three sessions. 


```{r libraries_nps_stim, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(car)
library(psych)
library(reshape)
library(PupillometryR)
library(dplyr)
library(tidyselect)
library(tidyr)
library(stringr)
library(lmerTest)
library(gghalves)
library(plyr)
library(ggpubr)
library(r2mlm)
library(effectsize)
library(devtools)
options(es.use_symbols = TRUE) # get nice symbols when printing! (On Windows, requires R >= 4.2.0)
library(EMAtools)
library(emmeans)
library(equatiomatic)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(DT)
library(raincloudplots)
# devtools::source_url("https://raw.githubusercontent.com/RainCloudPlots/RainCloudPlots/master/tutorial_R/R_rainclouds.R")
# devtools::source_url("https://raw.githubusercontent.com/RainCloudPlots/RainCloudPlots/master/tutorial_R/summarySE.R")

devtools::source_url("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")
file.sources = list.files(c("/Users/h/Dropbox/projects_dropbox/social_influence_analysis/scripts/step02_R/utils"),
                          pattern="*.R", 
                          full.names=TRUE, 
                          ignore.case=TRUE)
sapply(file.sources,source,.GlobalEnv)
# file.sources = list.files(c("https://raw.githubusercontent.com/jungheejung/cue_expectancy/main/scripts/step02_R/utils"), pattern="*.R", full.names=TRUE, ignore.case=TRUE)
# sapply(file.sources,source,.GlobalEnv)
```


```{r function::summary_for_plots_pvc, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
summary_for_plots_PVC <- function(df, groupwise_measurevar, subject_keyword, model_iv1, model_iv2, dv) {
    #  [ PLOT ] calculate mean and se  _________________________
    subjectwise <- meanSummary(
        df,
        c(subject_keyword, model_iv1, model_iv2), dv
    )
    groupwise <- summarySEwithin(
        data = subjectwise,
        measurevar = groupwise_measurevar,
        withinvars = c(model_iv1, model_iv2), idvar = subject_keyword
    )

    return(list(subjectwise,groupwise))
}
```

```{r function::simple_contrasts_singletrial, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
simple_contrasts_singletrial <- function(df) {
# [ CONTRASTS ]  ________________________________________________________________________________ # nolint
# contrast code ________________________________________
df$STIM <- factor(df$stim)

# contrast code 1 linear
df$STIM_linear[df$stimintensity == "low"] <-  -0.5
df$STIM_linear[df$stimintensity == "med"] <-  0
df$STIM_linear[df$stimintensity == "high"] <-  0.5

# contrast code 2 quadratic
df$STIM_quadratic[df$stimintensity == "low"] <-  -0.33
df$STIM_quadratic[df$stimintensity == "med"] <-  0.66
df$STIM_quadratic[df$stimintensity == "high"] <-  -0.33

# cue contrast
df$CUE_high_gt_low[df$cuetype == "cuetype-low"] <-  -0.5 # social influence task
df$CUE_high_gt_low[df$cuetype == "cuetype-high"] <-  0.5 # no influence task

df$stim_ordered <- factor(
        df$stimintensity,
        levels = c("low", "med", "high")
    )

df$cue_name[df$cuetype == "cuetype-low"] <- "low"
df$cue_name[df$cuetype == "cuetype-high"] <- "high"

df$cue_ordered <- factor(
        df$cue_name,
        levels = c("low", "high")
    )
return(df)
}
```

```{r function::NPS_lineplot_34, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
two_factor_lineplot <-
  function(df, iv1, iv2, mean, error, xlab, ylab) {
    g <- ggplot(
      data = df,
      aes(
        x = .data[[iv1]],
        y = .data[[mean]],
        group = factor(.data[[iv2]]),
        color = factor(.data[[iv2]])
      ),
      cex.lab = 1.5,
      cex.axis = 2,
      cex.main = 1.5,
      cex.sub = 1.5
    ) +
      geom_errorbar(aes(
        ymin = (.data[[mean]] - .data[[error]]),
        ymax = (.data[[mean]] + .data[[error]])
      ), width = .1) +
      geom_line() +
      geom_point() +
      ggtitle(ggtitle) +
      xlab(xlab) +
      ylab(ylab) +
      #scale_color_manual(values = color) +
      theme_classic() +
      
      theme(aspect.ratio = .6) +
      expand_limits(x = 3.25) +
      #guides(fill = "none") +
      #guides(color = TRUE) +
      #guides(fill = guide_legend(title = "title")) +
      #scale_fill_manual(values = color) +
      scale_color_manual("",
                         values =  c(
                           "pain" = "#941100",
                           "vicarious" = "#008F51",
                           "cognitive" = "#011891"
                         )) +
      theme(
        legend.position = c(.99, .99),
        legend.justification = c("right", "top"),
        legend.box.just = "right",
        legend.margin = margin(6, 6, 6, 6)
      ) +
      theme(legend.key = element_rect(fill = "white", colour = "white")) +
      theme_bw()
    
    return(g)
  }
```


```{r message=FALSE, warning=FALSE, include=FALSE}

# Step 1: Common parameters
# step 1: load data
for (signature_key in c("NPSpos")) {
     #c("NPS", "NPSpos", "NPSneg", "VPS", #"VPSnooccip", "ThermalPain", "MechPain", "GeneralAversive", "AversiveVisual"
                      #  "ZhouVPS", "PINES",  "GSR", "GeuterPaincPDM")) {
  dv_keyword = signature_key
  signature_name = signature_key
  # step 1: common parameters _______
  main_dir <- dirname(dirname(getwd()))

  analysis_folder  = paste0("model35_iv-task-stim_dv-", signature_key)

  sig_name <-
    Sys.glob(file.path(
      main_dir,
      "analysis/fmri/nilearn/signature_extract",
      paste0(
        "signature-",
        signature_key,
        "_sub-all_runtype-pvc_event-stimulus.tsv"
      )
    )) # nolint
  print(sig_name)
  analysis_dir <-
    file.path(main_dir,
              "analysis",
              "mixedeffect",
              analysis_folder,
              as.character(Sys.Date())) # nolint
  dir.create(analysis_dir,
             showWarnings = FALSE,
             recursive = TRUE)
  savedir <- analysis_dir
  
  # step 2: load data
  df = read.csv(sig_name)
  sig_df = df %>% separate(
    singletrial_fname,
    sep = "_",
    c(
      "sub",
      "ses",
      "run",
      "runtype",
      "event",
      "trial",
      "cuetype",
      "stimintensity"
    )
  )
  sig_df = sig_df %>% separate(
    stimintensity,
    into = c(NA, "stimintensity"),
    extra = "drop",
    fill = "left"
  )
  pvc <- simple_contrasts_singletrial(sig_df)
  pvc$task[pvc$runtype == "runtype-pain"] <- "pain"
  pvc$task[pvc$runtype == "runtype-vicarious"] <- "vicarious"
  pvc$task[pvc$runtype == "runtype-cognitive"] <- "cognitive"
  pvc$task <- factor(pvc$task)
  
  
  # step 3: parameters
  
  taskname = "all"
  plot_keyword = "stimulusintensity"
  ggtitle_phrase =  "(3 tasks x 3 stimulus intensity)"
  
  pvc$task = factor(pvc$task)
  plot_keys <- list(
    sub_mean = "mean_per_sub",
    group_mean = "mean_per_sub_norm_mean",
    legend_keyword = "stimulus intensity",
    se = "se",
    subject = "sub",
    ggtitle = paste0(
      str_to_title(signature_key),
      " dot product: ",
      str_to_title(taskname),
      ' ',
      ggtitle_phrase,
      " (N = ",
      length(unique(pvc$sub)),
      ")"
    ),
    title = paste0(
      str_to_title(signature_key),
      " - ",
      str_to_title(plot_keyword)
    ),
    xlab = "",
    ylab = paste(signature_key, " (dot product)"),
    ylim = c(-250, 500)
  )
  
  # step 4: within between summary
  groupwise <- data.frame()
  subjectwise <- data.frame()
  summary <- summary_for_plots_PVC(
    df = pvc,
    # taskname = taskname,
    groupwise_measurevar = plot_keys$sub_mean,
    # "mean_per_sub",
    subject_keyword = plot_keys$subject,
    # "sub",
    model_iv1 =  "task",
    model_iv2 =  "stim_ordered",
    dv = signature_key #"NPSpos"
  )
  subjectwise <<- as.data.frame(summary[[1]])
  groupwise <<- as.data.frame(summary[[2]])
  if (any(startsWith(dv_keyword, c("expect", "Expect")))) {
    plot_keys$color <- c("#1B9E77", "#D95F02", "#D95F02")
  } else {
    plot_keys$color <- c("#4575B4", "#FFA500", "#D73027")
  }
  
  # step 5: plot
  
  iv2 = "stim_ordered"
  iv1 = "task"
  taskname = "all"
  if (any(startsWith(dv_keyword, c("expect", "Expect")))) {
    color <- c("#1B9E77", "#D95F02", "#D95F02")
  } else {
    color <- c("#4575B4", "#FFA500", "#D73027")
  }
  subject_mean <- "mean_per_sub"
  sub_mean = subject_mean
  group_mean <- "mean_per_sub_norm_mean"
  se <- "se"
  ylim <- c(-25, 26)
  subject <- "sub"
  ggtitle_phrase <-  "(3 tasks x 3 stimulus intensity)"
  ggtitle <-
    paste0(
      str_to_title(signature_name),
      " dot product: ",
      str_to_title(taskname),
      ' ',
      ggtitle_phrase,
      " (N = ",
      length(unique(pvc$sub)),
      ")"
    )
  
  title <-
    paste0(str_to_title(dv_keyword),
           " - ",
           str_to_title(plot_keys$legend_keyword))
  xlab <- ""
  plot_keyword = "stimintensity"
  ylab <- paste(signature_name, " (dot product)")
  plot2_savefname <- file.path(
    analysis_dir,
    paste(
      "signature_task-",
      taskname,
      "_event-",
      plot_keyword,
      "_dv-",
      signature_key,
      "_",
      as.character(Sys.Date()),
      ".png",
      sep = ""
    )
  )
  p <- plot_halfrainclouds_twofactor(
    subjectwise,
    groupwise,
    iv1,
    iv2,
    subject_mean,
    group_mean,
    se,
    subject,
    ggtitle,
    title,
    xlab,
    ylab,
    taskname,
    ylim,
    w = 10,
    h = 6,
    dv_keyword,
    color,
    plot2_savefname
  )
  p
}
```


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

# Load behavioral data

main_dir = dirname(dirname(getwd()))
print(main_dir)
datadir = file.path(main_dir, 'data', 'beh', 'beh02_preproc')
taskname = '*'
subject_varkey <- "src_subject_id"
iv <- "param_stimulus_type"; 
iv_keyword <- "stim"; 
dv <- "event04_actual_angle"; dv_keyword <- "outcome"

exclude <- "sub-0001|sub-0002|sub-0003|sub-0004|sub-0005|sub-0007|sub-0008|sub-0013|sub-0016|sub-0017|sub-0019|sub-0020|sub-0021|sub-0025|sub-0075|sub-0009|sub-0117|sub-0119|sub-0081|sub-0060"
#sub-0074|sub-0085|sub-0118|sub-0117|sub-0103|sub-0063

p.df <- load_task_social_df(datadir, taskname = "pain", subject_varkey, iv, dv, exclude)
v.df <- load_task_social_df(datadir, taskname = "vicarious", subject_varkey, iv, dv, exclude)
c.df <- load_task_social_df(datadir, taskname = "cognitive", subject_varkey, iv, dv, exclude)




p.df2= p.df %>%
  arrange(src_subject_id ) %>%
  group_by(src_subject_id) %>%
  mutate(trial_index = row_number())
data_p <- p.df2 %>% 
  group_by(src_subject_id, session_id, param_run_num) %>% 
  mutate(trial_index = row_number(param_run_num))




v.df2= v.df %>%
  arrange(src_subject_id ) %>%
  group_by(src_subject_id) %>%
  mutate(trial_index = row_number())
data_v <- v.df2 %>% 
  group_by(src_subject_id, session_id, param_run_num) %>% 
  mutate(trial_index = row_number(param_run_num))

c.df2= c.df %>%
  arrange(src_subject_id ) %>%
  group_by(src_subject_id) %>%
  mutate(trial_index = row_number()-1)
data_c <- c.df2 %>% 
  group_by(src_subject_id, session_id, param_run_num) %>% 
  mutate(trial_index = row_number(param_run_num) )
p.sub <- data_p[,c("src_subject_id", "session_id", "param_run_num", "param_task_name", "event02_expect_angle", "param_cue_type", "param_stimulus_type", "event04_actual_angle", "trial_index")]
v.sub <- data_v[,c("src_subject_id", "session_id", "param_run_num", "param_task_name", "event02_expect_angle", "param_cue_type", "param_stimulus_type", "event04_actual_angle", "trial_index")]
c.sub <- data_c[,c("src_subject_id", "session_id", "param_run_num", "param_task_name", "event02_expect_angle", "param_cue_type", "param_stimulus_type", "event04_actual_angle", "trial_index")]
# sub, ses, run, runtype, event, trial, cuetype, stimintensity
# src_subject_id, session_id, param_run_num, param_task_name, event02_expect_angle, param_cue_type, param_stimulus_type, event04_actual_angle
pvc.bind = rbind(p.sub, v.sub, c.sub)

# pvc.bind <- 
#     pvc.pvc %>%
#     group_by(param_task_name, src_subject_id, session_id, param_run_num) %>%
#     mutate(lag.04outcomeangle = dplyr::lag(event04_actual_angle, n = 1, default = NA))
# pvc.lag <- data_a3lag[complete.cases(data_a3lag$lag.04outcomeangle),]


```

```{r}
main_dir
```

### change column name
```{r}
idkey <- data.frame("original" =  c("src_subject_id", "session_id", "param_run_num", "param_task_name", "event02_expect_angle", "param_cue_type", "param_stimulus_type", "event04_actual_angle", "trial_index"), 
                    "new" = c("sub", "ses", "run", "task", "RATING_expectation", "IV_cuelevel", "IV_stimintensity", "RATING_outcome", "trialindex"), stringsAsFactors = FALSE)
library(dplyr)
pvc.clean <- pvc.bind %>%
    rename_at(vars(as.character(idkey$original)), ~ as.character(idkey$new))

pvc.order <- pvc.clean[,c("sub", "ses", "run", "task","trialindex",  "IV_cuelevel", "IV_stimintensity","RATING_expectation", "RATING_outcome" )]
head(pvc.order)
write.csv(x=pvc.order, file = file.path(main_dir, "resources", "references", "cue_behavioraldata.csv"))
```


```{r}
library(rjson)
# list_1 = vector(mode="list", length = 2)
# list_1[[1]] = c("Rick","Dan","Michelle","Ryan")
# list_1[[2]] = c("Exclusion criteria: (1) participants with problematic brain data based on fmriprep metrics and CAT12; (2) trials with no RATING_outcome", "sub-0001|sub-0002|sub-0003|sub-0004|sub-0005|sub-0007|sub-0008|sub-0013|sub-0016|sub-0017|sub-0019|sub-0020|sub-0021|sub-0025|sub-0075|sub-0009|sub-0117|sub-0119|sub-0081|sub-0060", 
#                 "NA values in outcome ratings are removed")
# myfile = toJSON(list_1)
# 
library(jsonlite)

lst <- list(exclusion_criteria_description = c("(1) participants with problematic brain data based on fmriprep metrics and CAT12", "(2) trials with no RATING_outcome"),
                  excluded_subjects = c("sub-0001", "sub-0002", "sub-0003", "sub-0004", "sub-0005", "sub-0007", "sub-0008", "sub-0009", "sub-0013", "sub-0016", "sub-0017", "sub-0019", "sub-0020", "sub-0021", "sub-0025", "sub-0060", "sub-0075", "sub-0081", "sub-0117", "sub-0119"))

myfile = prettify(jsonlite::toJSON(lst))
# {"pc1":[1,2,98],"pc2":[11,12,99],"othr":[51,51]} 
write(myfile, file.path(main_dir, "resources", "references", "cue_behavioraldata.json"))
cat(myfile)
```
                    
```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
pvc.bind$trial_ind <- pvc.bind$trial_index -1 
pvc.bind$sub <- sprintf("sub-%04d", pvc.bind$src_subject_id)
pvc.bind$ses <- sprintf("ses-%02d", pvc.bind$session_id)
pvc.bind$run <- sprintf("run-%02d", pvc.bind$param_run_num)
pvc.bind$runtype <- sprintf("runtype-%s", pvc.bind$param_task_name)
pvc.bind$trial <- sprintf("trial-%03d", pvc.bind$trial_ind)
pvc.bind[c('cue', 'DEPc')]  <- str_split_fixed(pvc.bind$param_cue_type , '_', 2)
pvc.bind$cuetype <- sprintf("cuetype-%s", pvc.bind$cue)
pvc.bind[c('stimintensity', 'DEP')]  <- str_split_fixed(pvc.bind$param_stimulus_type , '_', 2)
# pvc.bind$N_1_outcome <- pvc.bind$lag.04outcomeangle
# merge
pvc.beh <- pvc.bind[,c("sub", "ses", "run", "runtype", "trial", "cuetype", "stimintensity","event02_expect_angle", "event04_actual_angle")] #, "N_1_outcome"
df_merge <- merge(pvc, pvc.beh, 
                  by.x = c("sub", "ses", "run", "runtype", "trial", "cuetype", "stimintensity"),
                  by.y = c("sub", "ses", "run", "runtype", "trial", "cuetype", "stimintensity")
                  )


  
```



#### Contrast weight table {.unlisted .unnumbered}
```{r echo=FALSE}
tab <- matrix(c(0, .5, -.5, 
                .66, -.34, -.34), ncol=3, byrow=TRUE)
colnames(tab) <- c('pain','vicarious','cognitive')
rownames(tab) <- c('task_V_gt_C','task_P_gt_VC')
kableExtra::kable_styling(
  knitr::kable(
    tab, caption = "Contrast weights", "html"), 
  "striped", position = "left", font_size = 15)
```


## NPS ~ paintask: 2 cue x 3 stimulus_intensity

### Q. Within pain task, Does stimulus intenisty level and cue level significantly predict NPS dotproducts? {.unlisted .unnumbered}
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
combined_se_calc_cooksd <- data.frame()
taskname = "pain"
ggtitle <- paste(taskname, " - actual judgment (degree)")
title <- paste(taskname, " - actual")
subject <- "sub"
w <- 10
h <- 6
p.sig <- df_merge[df_merge$runtype == "runtype-pain" & df_merge$ses == "ses-01" |  df_merge$ses == "ses-03",]
data <- p.sig
# [ CONTRASTS ]  ________________________________________________________________________________ # nolint
# contrast code ________________________________________
data$stim[data$stimintensity == "low"] <-
  -0.5 # social influence task
data$stim[data$stimintensity == "med"] <- 0 # no influence task
data$stim[data$stimintensity == "high"] <-
  0.5 # no influence task

data$STIM <- factor(data$stimintensity)

# contrast code 1 linear
data$STIM_linear[data$stimintensity == "low"] <- -0.5
data$STIM_linear[data$stimintensity == "med"] <- 0
data$STIM_linear[data$stimintensity == "high"] <- 0.5

# contrast code 2 quadratic
data$STIM_quadratic[data$stimintensity == "low"] <- -0.33
data$STIM_quadratic[data$stimintensity == "med"] <- 0.66
data$STIM_quadratic[data$stimintensity == "high"] <- -0.33

# social cude contrast
data$CUE_high_gt_low[data$cuetype == "cuetype-low"] <-
  -0.5 # social influence task
data$CUE_high_gt_low[data$cuetype == "cuetype-high"] <-
  0.5 # no influence task

data$EXPECT <- data$event02_expect_angle
stim_con1 <- "STIM_linear"
stim_con2 <- "STIM_quadratic"
iv1 <- "CUE_high_gt_low"
dv <- "NPSpos"

# [ MODEL ] _________________________________________________ # nolint
model_savefname <- file.path(
  analysis_dir,
  paste(
    "lmer_task-",
    taskname,
    "_rating-",
    dv_keyword,
    "_",
    as.character(Sys.Date()),
    "_cooksd.txt",
    sep = ""
  )
)

cooksd <- lmer_twofactor_cooksd_fix(
  data,
  taskname,
  iv1,
  stim_con1,
  stim_con2,
  dv,
  subject,
  dv_keyword,
  model_savefname,
  'random_intercept',
  print_lmer_output = FALSE
)
influential <- as.numeric(names(cooksd)[(cooksd > (4 / as.numeric(length(unique(
  data$sub
)))))])
data_screen <- data[-influential,]
# [ PLOT ] reordering for plots _________________________ # nolint
data_screen$cue_name[data_screen$cuetype == "cuetype-high"] <-
  "high cue"
data_screen$cue_name[data_screen$cuetype == "cuetype-low"] <-
  "low cue"

data_screen$stim_name[data_screen$stimintensity == "high"] <-
  "high"
data_screen$stim_name[data_screen$stimintensity == "med"] <-
  "med"
data_screen$stim_name[data_screen$stimintensity == "low"] <-
  "low"

# DATA$levels_ordered <- factor(DATA$param_stimulus_type, levels=c("low", "med", "high"))

data_screen$stim_ordered <- factor(data_screen$stim_name,
                                   levels = c("low", "med", "high"))
data_screen$cue_ordered <- factor(data_screen$cue_name,
                                  levels = c("low cue", "high cue"))
model_iv1 <- "stim_ordered"
model_iv2 <- "cue_ordered"

#  [ PLOT ] calculate mean and se  _________________________
NPSstimcue_subjectwise <- meanSummary(data_screen,
                                      c(subject, model_iv1, model_iv2), dv)
NPSstimcue_groupwise <- summarySEwithin(
  data = NPSstimcue_subjectwise,
  measurevar = "mean_per_sub",
  withinvars = c(model_iv1, model_iv2),
  idvar = subject
)
NPSstimcue_groupwise$task <- taskname
# https://stackoverflow.com/questions/29402528/append-data-frames-together-in-a-for-loop/29419402

combined_se_calc_cooksd <-
  rbind(combined_se_calc_cooksd, NPSstimcue_groupwise)
# calculate mean and se
sub_mean <- "mean_per_sub"
group_mean <- "mean_per_sub_norm_mean"
se <- "se"
subject <- "sub"
ggtitle <- paste(taskname, " - NPSpos Cooksd removed")
title <- paste(taskname, " - NPSpos")
xlab <- ""
ylab <- "NPSpos (degree)"
ylim <- c(-10, 60)
dv_keyword <- "NPSpos"
if (any(startsWith(dv_keyword, c("expect", "Expect")))) {
  color <- c("#1B9E77", "#D95F02")
} else {
  color <- c("#4575B4", "#D73027")
} # if keyword starts with
plot_savefname <- file.path(
  analysis_dir,
  paste(
    "raincloud_task-", taskname, "_rating-", dv_keyword, "_", as.character(Sys.Date()), "_cooksd.png",
    sep = ""
  )
)
g <- plot_halfrainclouds_twofactor(
  NPSstimcue_subjectwise,
  NPSstimcue_groupwise,
  model_iv1,
  model_iv2,
  sub_mean,
  group_mean,
  se,
  subject,
  ggtitle,
  title,
  xlab,
  ylab,
  taskname,
  ylim,
  w,
  h,
  dv_keyword,
  color,
  plot_savefname
)
g
```


### Lineplots {.unlisted .unnumbered}
```{r echo=FALSE, warning=FALSE}
plot_lineplot_twofactor_subset(NPSstimcue_groupwise, taskname = "pain", 
                        iv1 = "stim_ordered", iv2 = "cue_ordered", 
                        mean = "mean_per_sub_norm_mean", error = "se",
                        color = c("#4575B4", "#D73027"), ggtitle = "Within pain task: NPS dotproducts as a function of stimulus intensity level and cue", 
                        xlab = "Stimulus intensity", ylab = "NPSpos (dot product)")
```


### Linear model results (NPS ~ paintask: 2 cue x 3 stimulus_intensity)
```{r echo=TRUE, message=FALSE, warning=TRUE, paged.print=FALSE}

model.npscuestim <- lmer(NPSpos ~ 
                          CUE_high_gt_low*STIM_linear +CUE_high_gt_low * STIM_quadratic +
                          (CUE_high_gt_low+STIM|sub), data = data_screen
                    )
sjPlot::tab_model(model.npscuestim,
                  title = "Multilevel-modeling: \nlmer(NPSpos ~ CUE * STIM + (CUE + STIM | sub), data = pvc)",
                  CSS = list(css.table = '+font-size: 12;'))
```

#### Linear model eta-squared {.unlisted .unnumbered}
```{r echo=FALSE, message=FALSE, warning=TRUE, paged.print=FALSE}
kableExtra::kable_styling(
  knitr::kable(
    eta_squared(model.npscuestim, partial = TRUE), # MODIFY
    "html"), "striped", position = "left", font_size = 12)
#parameters::model_parameters(model.npscuestim)
```

#### Linear model Cohen's d: NPS stimulus_intensity d = 1.16, cue d = 0.45 {.unlisted .unnumbered}
```{r echo=FALSE, message=FALSE, warning=TRUE, paged.print=FALSE}

kableExtra::kable_styling(
  knitr::kable(
    lme.dscore(model.npscuestim, data_screen, type = "lme4"),
    "html"), "striped", position = "left", font_size = 12)
```





### 2 cue * 3 stimulus_intensity * expectation_rating 
```{r echo=TRUE, warning=TRUE}

data_screen$EXPECT <- data_screen$event02_expect_angle
model.nps3factor <- lmer(NPSpos ~ 
                          CUE_high_gt_low*STIM_linear*EXPECT +
                           CUE_high_gt_low*STIM_quadratic*EXPECT +
                          (CUE_high_gt_low  |sub), data = data_screen
                    )
sjPlot::tab_model(model.nps3factor,
                  title = "Multilevel-modeling: \nlmer(NPSpos ~ CUE * STIM * EXPECTATION + (CUE + STIM + EXPECT | sub), data = pvc)",
                  CSS = list(css.table = '+font-size: 12;'))
```

#### eta squared {.unlisted .unnumbered}
```{r echo=FALSE, warning=TRUE}
kableExtra::kable_styling(
  knitr::kable(
    eta_squared(model.nps3factor, partial = TRUE), # MODIFY
    "html"), "striped", position = "left", font_size = 12)
```

#### Cohen's d {.unlisted .unnumbered}
```{r echo=FALSE, warning=TRUE}
kableExtra::kable_styling(
  knitr::kable(
    lme.dscore(model.nps3factor, data_screen, type = "lme4"), # MODIFY
    "html"), "striped", position = "left", font_size = 12)
```




---

## NPS_ses01 ~ SES * CUE * STIM
### Q. Is the cue effect on NPS different across sessions? {.unlisted .unnumbered}

> Quick answer: Yes, the cue effect in session 1 (for high intensity group) is significantly different; whereas this different becomes non significant in session 4. 
> To unpack, a participant was informed to experience a low  stimulus intensity, when in fact they were delivered a high intensity stimulus. This violation presumably leads to a higher NPS response, given that they were delivered a much painful stimulus than expected. The fact that the cue effect is almost non significant during the last session indicates that the cue effects are not just an anchoring effect. 

#### Session wise plots
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

combined_se_calc_cooksd <- data.frame()
for (sesname in c("ses-01", "ses-03", "ses-04")) {
taskname = "pain"
    ggtitle <- paste(taskname, " - actual judgment (degree)")
    title <- paste(taskname, " - actual")
    subject <- "sub"
    w <- 10
    h <- 6
s1.sig <- df_merge[df_merge$runtype == "runtype-pain" & df_merge$ses == sesname,]
data <- s1.sig
    # [ CONTRASTS ]  ________________________________________________________________________________ # nolint
# contrast code ________________________________________
data$stim[data$stimintensity == "low"] <- -0.5 # social influence task
data$stim[data$stimintensity == "med"] <- 0 # no influence task
data$stim[data$stimintensity == "high"] <- 0.5 # no influence task

data$STIM <- factor(data$stimintensity)

# contrast code 1 linear
data$STIM_linear[data$stimintensity == "low"] <- -0.5
data$STIM_linear[data$stimintensity == "med"] <- 0
data$STIM_linear[data$stimintensity == "high"] <- 0.5

# contrast code 2 quadratic
data$STIM_quadratic[data$stimintensity == "low"] <- -0.33
data$STIM_quadratic[data$stimintensity == "med"] <- 0.66
data$STIM_quadratic[data$stimintensity == "high"] <- -0.33

    # social cude contrast
    data$CUE_high_gt_low[data$cuetype == "cuetype-low"] <- -0.5 # social influence task
    data$CUE_high_gt_low[data$cuetype == "cuetype-high"] <- 0.5 # no influence task


    stim_con1 <- "STIM_linear"
    stim_con2 <- "STIM_quadratic"
    iv1 <- "CUE_high_gt_low"
    dv <- "NPSpos"

    # [ MODEL ] _________________________________________________ # nolint
    model_savefname <- file.path(
        analysis_dir,
        paste("lmer_task-", taskname,
            "_rating-", dv_keyword,
            "_", as.character(Sys.Date()), "_cooksd.txt",
            sep = ""
        )
    )
    
    cooksd <- lmer_twofactor_cooksd_fix(
        data, taskname, iv1, stim_con1, stim_con2, dv,
        subject, dv_keyword, model_savefname, 'random_intercept', print_lmer_output = FALSE
    )
    influential <- as.numeric(names(cooksd)[
        (cooksd > (4 / as.numeric(length(unique(data$sub)))))
    ])
    data_screen <- data[-influential, ]
    # [ PLOT ] reordering for plots _________________________ # nolint
    data_screen$cue_name[data_screen$cuetype == "cuetype-high"] <- "high cue"
    data_screen$cue_name[data_screen$cuetype == "cuetype-low"] <- "low cue"

    data_screen$stim_name[data_screen$stimintensity == "high"] <- "high"
    data_screen$stim_name[data_screen$stimintensity == "med"] <- "med"
    data_screen$stim_name[data_screen$stimintensity == "low"] <- "low"

    # DATA$levels_ordered <- factor(DATA$param_stimulus_type, levels=c("low", "med", "high"))

    data_screen$stim_ordered <- factor(
        data_screen$stim_name,
        levels = c("low", "med", "high")
    )
    data_screen$cue_ordered <- factor(
        data_screen$cue_name,
        levels = c("low cue", "high cue")
    )
    model_iv1 <- "stim_ordered"
    model_iv2 <- "cue_ordered"

    #  [ PLOT ] calculate mean and se  _________________________
    actual_subjectwise <- meanSummary(
        data_screen,
        c(subject, model_iv1, model_iv2), dv
    )
    actual_groupwise <- summarySEwithin(
        data = actual_subjectwise,
        measurevar = "mean_per_sub",
        withinvars = c(model_iv1, model_iv2), idvar = subject
    )
    actual_groupwise$task <- taskname
    actual_groupwise$ses <- sesname
    # https://stackoverflow.com/questions/29402528/append-data-frames-together-in-a-for-loop/29419402
    
    combined_se_calc_cooksd <- rbind(combined_se_calc_cooksd, actual_groupwise)
   # calculate mean and se  
    sub_mean <- "mean_per_sub"
    group_mean <- "mean_per_sub_norm_mean"
    se <- "se"
    subject <- "sub"
    ggtitle <- paste(str_to_title(taskname), " - NPSpos Cooksd removed ", sesname )
    title <- paste(str_to_title(taskname), " - cue level")
    xlab <- ""
    ylab <- "NPSpos (degree)"
    ylim <- c(-10,60)
    dv_keyword <- "NPSpos"
    if (any(startsWith(dv_keyword, c("expect", "Expect")))) {
        color <- c("#1B9E77", "#D95F02")
    } else {
        color <- c("#4575B4", "#D73027")
    } # if keyword starts with
    plot_savefname <- file.path(
        analysis_dir,
        paste("raincloud_task-", taskname,
            "_rating-", dv_keyword,
            "_", as.character(Sys.Date()), "_cooksd.png",
            sep = ""
        )
    )
    g <- plot_halfrainclouds_twofactor(
        actual_subjectwise, actual_groupwise, model_iv1, model_iv2,
        sub_mean, group_mean, se, subject,
        ggtitle, title, xlab, ylab, taskname,ylim,
        w, h, dv_keyword, color, plot_savefname
    )
print(g)
}
```


### Here are the stats models: NPS~session * cue * stimulus_intensity
1. Calculate difference score
* average high and low cue within run. 
* calculate difference between high and low cue per run
* each participant has 6 contrast scores
* run this as a function of stimulus intensity and sessions

```{r echo=FALSE, message=FALSE, warning=FALSE}
# lineplot per session

DATA = as.data.frame(combined_se_calc_cooksd)
color = c("#4C77ED", "#ED220D")
model_iv1 <- "stim_ordered"
model_iv2 <- "ses_ordered"
LINEIV1 = "stim_ordered"
LINEIV2 = "cue_ordered"
MEAN = "mean_per_sub_norm_mean"
ERROR = "se"
dv_keyword = "actual"
p1 = plot_lineplot_twofactor(DATA[DATA$ses == "ses-01",],
               LINEIV1, LINEIV2, MEAN, ERROR, color, ggtitle = 'ses-01', 
               ylab = "NPS (dot products)" )
p2 = plot_lineplot_twofactor(DATA[DATA$ses == "ses-03",],
               LINEIV1, LINEIV2, MEAN, ERROR, color, ggtitle = 'ses-03',
               ylab = "NPS (dot products)")
p3 = plot_lineplot_twofactor(DATA[DATA$ses == "ses-04",],
               LINEIV1, LINEIV2, MEAN, ERROR, color,ggtitle = 'ses-04',
               ylab = "NPS (dot products)")

ggpubr::ggarrange(p1,p2,p3,ncol = 3, nrow = 1, common.legend = TRUE,legend = "bottom")
plot_filename = file.path(analysis_dir,
                          paste('lineplot_task-all_rating-',dv_keyword,'.png', sep = ""))
ggsave(plot_filename, width = 8, height = 4)
```
---

## OUTCOME ~ NPS
### Q. Do higher NPS values indicate higher outcome ratings? (Pain task only) {.unlisted .unnumbered}

> Yes, Higher NPS values are associated with higher outcome ratings. The linear relationship between NPS value and outcome ratings are stronger for conditions where cue level is congruent with stimulus intensity levels. In other words, NPS-outcome rating relationship is stringent in the low cue-low intensity group, as is the case for high cue-ghigh intensity group. 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# plot parameters
iv2 = "event04_actual_angle"
iv1 = "NPSpos"
subject = "sub"
ylab = "Outcome rating"
xlab = "NPSpos" #signature_key
ggtitle = "All stimulus intensity"
alpha = 0.8
lm_method = "lm"
p.sig <- df_merge[df_merge$runtype == "runtype-pain" & df_merge$ses == "ses-01" |  df_merge$ses == "ses-03",]
df_dropna <- p.sig[!is.na(p.sig[, iv1]) & !is.na(p.sig[, iv2]),]
subjectwise_2dv <- meanSummary_2dv(df_dropna,
                                   c(subject),
                                   iv1, iv2)
subjectwise_naomit_2dv <- na.omit(subjectwise_2dv)
g <- ggplot(data = subjectwise_naomit_2dv,
            aes(x = .data[["DV1_mean_per_sub"]],
                y = .data[["DV2_mean_per_sub"]],)) +
  geom_point(size = 2,
             alpha = alpha) +

  theme(aspect.ratio = 1) +
  #scale_color_manual(values = color_scheme) +
  scale_shape_manual(values = c(16, 17)) +
  xlab(xlab) +
  ylab(ylab) +
  xlim(-10, 30) +
  ylim(0, 180) +
  ggtitle(ggtitle) +
  theme(
    axis.line = element_line(colour = "grey50"),
    panel.background = element_blank(),
    plot.subtitle = ggtext::element_textbox_simple(size = 11)
  ) +
  geom_ribbon(
    stat = "smooth",
    method = lm_method,
    se = TRUE,
    alpha = 0.1,
    aes(color = NULL)
  ) +
  geom_line(
    stat = "smooth",
    method = lm_method,
    alpha = 0.8,
    linewidth = 1.5
  )
g
```

### outcome_rating * cue
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
p.sig <- df_merge[df_merge$runtype == "runtype-pain" & df_merge$ses == "ses-01" |  df_merge$ses == "ses-03",]
iv2 = "event04_actual_angle"; iv1 = "NPSpos"
df_dropna <-
  p.sig[!is.na(p.sig$event04_actual_angle) & !is.na(p.sig$NPSpos),]
total <-
  plot_twovariable(
    df_dropna, iv1, iv2,
    group = "cuetype", subject = "sub",
    ymin=0, ymax=180, xmin=-10, xmax=30,
    ylab = "Outcome rating", xlab = signature_key,
    ggtitle = "all stimulus intensity", 
    color_scheme = c("cuetype-high" ="#941100","cuetype-low" =  "#BBBBBB"), 
    alpha = .8, fit_lm = TRUE, lm_method ="lm", identity_line = FALSE
  )
total + labs(title =paste0("task-",taskname, "- What is the pattern for NPS pos dotproduct and expect ratings? \nHow is does this pattern differ depending on high vs low cues?\n\n")
          )
```




### outcome_ratings * stimulus_intensity * cue
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
iv2 = "event04_actual_angle"; iv1 = "NPSpos"
group = "cuetype"; subject = "sub"
# low stimulus intensity
df_low = df_dropna[df_dropna$stimintensity == "low", ]
low <-
  plot_twovariable(
    df_low, iv1 , iv2,
    group = group, subject = subject,
    ymin=0, ymax=180, xmin=-10, xmax=30,
    ylab = "Outcome rating", xlab = signature_key,
    ggtitle = "Low intensity",
    color_scheme = c("cuetype-high" ="#FF8800","cuetype-low" =  "#5D5C5C"),
    alpha = .5, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE
  )

# med stimulus intensity
df_med = df_dropna[df_dropna$stimintensity == "med", ]
med <-
  plot_twovariable(
    df_med, iv1, iv2,
    group = group, subject = subject,
    ymin=0, ymax=180, xmin=-10, xmax=30,
    ylab = "Outcome rating", xlab = signature_key,
    ggtitle = "Medium intensity",
    color_scheme = c("cuetype-high" ="#DB6000","cuetype-low" =  "#5D5C5C"),
    alpha = .5, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE
  )

# high stimulus intensity
df_high = df_dropna[df_dropna$stimintensity == "high", ]
high <-
  plot_twovariable(
    df_high, iv1, iv2,
    group = group, subject = subject,
    ymin=0, ymax=180, xmin=-10, xmax=30,
    ylab = "Outcome rating", xlab = signature_key,
    ggtitle = "High intensity",
    color_scheme = c("cuetype-high" ="#941100","cuetype-low" =  "#5D5C5C"),
    alpha = .5, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE
  )
plots <- ggpubr::ggarrange(low, med, high, ncol = 3, nrow = 1, common.legend = FALSE, legend = "bottom")
plots_title <- annotate_figure(plots, top = text_grob(paste(str_to_title(taskname), "\n NPS/Outcome linear relationship does not differ as a function of stimulus intensity and cue"), color = "black", face = "bold", size = 12))
plots_title
```

### demeaned outcome rating * cue
```{r echo=FALSE}
remove_sub_list = c("sub-0009", "sub-0117", "sub-0081", "sub-0060", "sub-0063", "sub-0074", "sub-0080", "sub-0085", "sub-0098", "sub-0118", "sub-0129")
df_merge_drop <- subset(df_merge, !(sub %in% remove_sub_list))
freq <- count(df_merge, "sub")
subset_ses <-  df_merge_drop[df_merge_drop$task == 'pain' &
             df_merge_drop$ses == 'ses-01' |  df_merge_drop$ses == "ses-03",]
p.demean <- subset_ses %>%
group_by(sub) %>%
mutate(event04_actual_angle = as.numeric(event04_actual_angle)) %>%
mutate(event02_expect_angle = as.numeric(event02_expect_angle)) %>%
mutate(avg_outcome = mean(event04_actual_angle, na.rm = TRUE)) %>%
mutate(OUTCOME_demean = event04_actual_angle - avg_outcome) %>%
mutate(avg_expect = mean(event02_expect_angle, na.rm = TRUE)) %>%
mutate(EXPECT_demean = event02_expect_angle - avg_expect)

p.demean <- p.demean %>%
group_by(sub, ses) %>%
mutate(NPSpos = as.numeric(NPSpos)) %>%
mutate(avg_NPS = mean(NPSpos, na.rm = TRUE)) %>%
mutate(NPS_demean = NPSpos - avg_NPS) %>%
  ungroup %>%
mutate(OUTCOME_cmc = avg_outcome - mean(avg_outcome)) %>%
mutate(EXPECT_cmc = avg_expect - mean(avg_expect)) %>%
mutate(NPS_cmc = avg_NPS - mean(avg_NPS)) 
# plot parameters
iv1 = "NPSpos"
iv2 = "OUTCOME_demean"

subject = "sub"
ylab = "Outcome rating \n(subjectwise mean-centered)"
xlab = signature_key
ggtitle = "All stimulus intensity"
alpha = 0.8
lm_method = "lm"
# p.sig <- df_merge[df_merge$runtype == "runtype-pain", ]
demean_dropna <- p.demean[!is.na(p.demean[, iv1]) & !is.na(p.demean[, iv2]),]
demean_dropna$EXPECT <- demean_dropna$event02_expect_angle
total <-
  plot_twovariable(
    demean_dropna, iv1, iv2,
    group = "cuetype", subject = "sub",
    ymin=-25, ymax=25, xmin=-5, xmax=5,
    ylab,  xlab = paste(signature_key), #, "\n(subjectwise mean-centered)"),
    ggtitle = "all stimulus intensity", 
    color_scheme = c("cuetype-high" ="#941100","cuetype-low" =  "#BBBBBB"), 
    alpha = .8, fit_lm = TRUE, lm_method ="lm", identity_line = FALSE
  )
total + labs(title =paste0("task-",taskname, "- What is the pattern for NPS pos dotproduct and expect ratings? \nHow is does this pattern differ depending on high vs low cues?\n\n")
          )

```

### demeaned_outcome_ratings * stimulus_intensity * cue
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
iv2 = "OUTCOME_demean"; iv1 = "NPSpos" # "NPSpos"
ylab = "Outcome rating \n(subjectwise mean-centered)"
xlab =  paste(signature_key)
group = "cuetype"; subject = "sub"
# low stimulus intensity
demean_low = demean_dropna[demean_dropna$stimintensity == "low", ]
low <-
  plot_twovariable(
    demean_low, iv1 , iv2,
    group = group, subject = subject,
    ymin=-50, ymax=50, xmin=-25, xmax=25,
    ylab = ylab, xlab =  xlab,
    ggtitle = "Low intensity",
    color_scheme = c("cuetype-high" ="#FF8800","cuetype-low" =  "#5D5C5C"),
    alpha = .5, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE
  )

# med stimulus intensity
demean_med = demean_dropna[demean_dropna$stimintensity == "med", ]
med <-
  plot_twovariable(
    demean_med, iv1, iv2,
    group = group, subject = subject,
    ymin=-50, ymax=50, xmin=-25, xmax=25,
    ylab = ylab, xlab =  xlab,
    ggtitle = "Medium intensity",
    color_scheme = c("cuetype-high" ="#DB6000","cuetype-low" =  "#5D5C5C"),
    alpha = .5, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE
  )

# high stimulus intensity
demean_high = demean_dropna[demean_dropna$stimintensity == "high", ]
high <-
  plot_twovariable(
    demean_high, iv1, iv2,
    group = group, subject = subject,
    ymin=-50, ymax=50, xmin=-25, xmax=25,
    ylab = ylab, xlab =  xlab,
    ggtitle = "High intensity",
    color_scheme = c("cuetype-high" ="#941100","cuetype-low" =  "#5D5C5C"),
    alpha = .5, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE
  )
plots <- ggpubr::ggarrange(low, med, high, ncol = 3, nrow = 1, common.legend = FALSE, legend = "bottom")
plots_title <- annotate_figure(plots, top = text_grob(paste(str_to_title(taskname), "\n NPS/Outcome linear relationship does not differ as a function of stimulus intensity and cue"), color = "black", face = "bold", size = 12))
plots_title
```

### Is this statistically significant?

```{r echo=TRUE, message=FALSE, warning=TRUE, paged.print=FALSE}
# organize variable names
# NPS_demean vs. NPSpos
model.npsoutcome <- lmer(OUTCOME_demean ~ CUE_high_gt_low*STIM_linear*NPSpos + CUE_high_gt_low*STIM_quadratic*NPSpos + (CUE_high_gt_low*STIM*NPSpos|sub), data = demean_dropna)
sjPlot::tab_model(model.npsoutcome,
                  title = "Multilevel-modeling: \nlmer(OUTCOME_demean ~ CUE * STIM * NPSpos + (CUE * STIM *NPSpos | sub), data = pvc)",
                  CSS = list(css.table = '+font-size: 12;'))
```


---

## NPS ~ expectation_rating
### Q. What is the relationship betweeen expectation ratings & NPS? (Pain task only) {.unlisted .unnumbered}
Do we see a linear effect between expectation rating and NPS dot products? Also, does this effect differ as a function of cue and stimulus intensity ratings, as is the case for behavioral ratings?

> Quick answer: Yes, expectation ratings predict NPS dotproducts; Also, there tends to be a different relationship depending on cues, just by looking at the figures, although this needs to be tested statistically. 

### NPS ~ expect * cue
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# p.sig <- df_merge[df_merge$runtype == "runtype-pain" & df_merge$ses == "ses-01" |  df_merge$ses == "ses-03",]
remove_sub_list = c("sub-0009", "sub-0117", "sub-0081", "sub-0060", "sub-0063", "sub-0074", "sub-0080", "sub-0085", "sub-0098", "sub-0118", "sub-0129")
df_merge_drop <- subset(df_merge, !(sub %in% remove_sub_list))
freq <- count(df_merge, "sub")
p.sig <-  df_merge_drop[df_merge_drop$task == 'pain' &
             df_merge_drop$ses == 'ses-01' |  df_merge_drop$ses == "ses-03",]

iv1 = "event02_expect_angle"; iv2 = "NPSpos"
df_dropna <-
  p.sig[!is.na(p.sig$event02_expect_angle) & !is.na(p.sig$NPSpos),]
total <-
  plot_twovariable(
    df_dropna, iv1, iv2,
    group = "cuetype", subject = "sub",
    xmin =0, xmax = 200, ymin = -10, ymax = 30,
    xlab = "expectation rating",
    ylab = signature_key, 
    ggtitle = "all stimulus intensity", 
    color_scheme = c("cuetype-high" ="#941100","cuetype-low" =  "#BBBBBB"), 
    alpha = .8, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE
  )
total + labs(title =paste0("task-",taskname, "- What is the pattern for NPS pos dotproduct and expect ratings? \nHow is does this pattern differ depending on high vs low cues?\n\n")
          )
  # geom_line(method="lm", alpha=0.3, size=1, span=0.5) # geom_smooth(method=lm, se = TRUE) 
# +geom_smooth(method = "lm", alpha=0.1, size=0, span=0.5)
```

### NPS ~ expect * cue * stim
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
iv1 = "event02_expect_angle"; iv2 = "NPSpos"
group = "cuetype"; subject = "sub"
# low stimulus intensity
df_low = df_dropna[df_dropna$stimintensity == "low", ]
low <-
  plot_twovariable(
    df_low, iv1 , iv2,
    group = group, subject = subject,
    xmin =0, xmax = 200, ymin = -10, ymax = 30,
    xlab = "expectation rating", ylab = "NPSpos",
    ggtitle = "Low intensity",
    color_scheme = c("cuetype-high" ="#FF8800","cuetype-low" =  "#5D5C5C"),
    alpha = .5, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE
  )

# med stimulus intensity
df_med = df_dropna[df_dropna$stimintensity == "med", ]
med <-
  plot_twovariable(
    df_med, iv1, iv2,
    group = group, subject = subject,
    xmin =0, xmax = 200, ymin = -10, ymax = 30,
    xlab = "expectation rating", ylab = "NPSpos",
    ggtitle = "Medium intensity",
    color_scheme = c("cuetype-high" ="#DB6000","cuetype-low" =  "#5D5C5C"),
    alpha = .5, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE
  )

# high stimulus intensity
df_high = df_dropna[df_dropna$stimintensity == "high", ]
high <-
  plot_twovariable(
    df_high, iv1, iv2,
    group = group, subject = subject,
    xmin =0, xmax = 200, ymin = -10, ymax = 30,
    xlab = "expectation rating", ylab = "NPSpos",
    ggtitle = "High intensity",
    color_scheme = c("cuetype-high" ="#941100","cuetype-low" =  "#5D5C5C"),
    alpha = .5, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE
  )
plots <- ggpubr::ggarrange(low, med, high, ncol = 3, nrow = 1, common.legend = FALSE, legend = "bottom")
plots_title <- annotate_figure(plots, top = text_grob(paste(str_to_title(taskname), "\n Expect/Outcome linear relationship differs as a function of stimulus intensity and cue"), color = "black", face = "bold", size = 12))
plots_title
```


### NPS ~ demeaned_expect * cue
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
remove_sub_list = c("sub-0009", "sub-0117", "sub-0081", "sub-0060", "sub-0063", "sub-0074", "sub-0085", "sub-0098", "sub-0118")
df_merge_drop <- subset(df_merge, !(sub %in% remove_sub_list))
subset_ses <-  df_merge_drop[df_merge_drop$task == 'pain' &
             df_merge_drop$ses == 'ses-01' |  df_merge_drop$ses == "ses-03",]
p.demean <- subset_ses %>%
  group_by(sub) %>%
  mutate(event04_actual_angle = as.numeric(event04_actual_angle)) %>%
  mutate(event02_expect_angle = as.numeric(event02_expect_angle)) %>%
  mutate(avg_outcome = mean(event04_actual_angle, na.rm = TRUE)) %>%
  mutate(OUTCOME_demean = event04_actual_angle - avg_outcome) %>%
  mutate(avg_expect = mean(event02_expect_angle, na.rm = TRUE)) %>%
  mutate(EXPECT_demean = event02_expect_angle - avg_expect) %>%
  group_by(sub, ses) %>%
  mutate(NPSpos = as.numeric(NPSpos)) %>%
  mutate(avg_NPS = mean(NPSpos, na.rm = TRUE)) %>%
  mutate(NPS_demean = NPSpos - avg_NPS) %>%
  ungroup %>%
  mutate(OUTCOME_cmc = avg_outcome - mean(avg_outcome)) %>%
  mutate(EXPECT_cmc = avg_expect - mean(avg_expect)) %>%
  mutate(NPS_cmc = avg_NPS - mean(avg_NPS)) 

# plot parameters

iv1 = "EXPECT_demean"
iv2 = "NPSpos" # NPS_demean
subject = "sub"
xlab = "Expectation rating \n(subjectwise mean-centered)"
ylab = paste(signature_key) #, " \n(mean-centered)")
ggtitle = "All stimulus intensity"
alpha = 0.8
lm_method = "lm"
demean_dropna <- p.demean[!is.na(p.demean[, iv1]) & !is.na(p.demean[, iv2]),]

total <-
  plot_twovariable(
    demean_dropna, iv1, iv2,
    group = "cuetype", subject = "sub",
    ymin=-10, ymax=10, xmin=-40, xmax=40,
    xlab ,ylab,
    ggtitle = "all stimulus intensity", 
    color_scheme = c("cuetype-high" ="#941100","cuetype-low" =  "#5D5C5C"), 
    alpha = .8, fit_lm = TRUE, lm_method ="lm", identity_line = FALSE
  )
total + labs(title =paste0("task-",taskname, "- What is the pattern for NPS pos dotproduct and expect ratings? \nHow is does this pattern differ depending on high vs low cues?\n\n")
          )

```

### NPS ~ demeaned_expect * cue * stim
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
iv1 = "EXPECT_demean"; iv2 = "NPSpos" # "NPS_demean"
group = "cuetype"; subject = "sub"
xlab = "Expectation rating \n(subjectwise mean-centered)"
ylab = paste(signature_key)
# low stimulus intensity
demean_low = demean_dropna[demean_dropna$stimintensity == "low", ]
low <-
  plot_twovariable(
    demean_low, iv1 , iv2,
    group = group, subject = subject,
    ymin=-20, ymax=20, xmin=-50, xmax=50,
    xlab = xlab, ylab = ylab, 
    #, " \n(mean-centered)"),
    ggtitle = "Low intensity",
    color_scheme = c("cuetype-high" ="#FF8800","cuetype-low" =  "#5D5C5C"),
    alpha = .5, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE
  )

# med stimulus intensity
demean_med = demean_dropna[demean_dropna$stimintensity == "med", ]
med <-
  plot_twovariable(
    demean_med, iv1, iv2,
    group = group, subject = subject,
    ymin=-20, ymax=20, xmin=-50, xmax=50,
    xlab = xlab, ylab = ylab, 
    ggtitle = "Medium intensity",
    color_scheme = c("cuetype-high" ="#DB6000","cuetype-low" =  "#5D5C5C"),
    alpha = .5, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE
  )

# high stimulus intensity
demean_high = demean_dropna[demean_dropna$stimintensity == "high", ]
high <-
  plot_twovariable(
    demean_high, iv1, iv2,
    group = group, subject = subject,
    ymin=-20, ymax=20, xmin=-50, xmax=50,
    xlab = xlab, ylab = ylab, 
    ggtitle = "High intensity",
    color_scheme = c("cuetype-high" ="#941100","cuetype-low" =  "#5D5C5C"),
    alpha = .5, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE
  )
plots <- ggpubr::ggarrange(low, med, high, ncol = 3, nrow = 1, common.legend = FALSE, legend = "bottom")
plots_title <- annotate_figure(plots, top = text_grob(paste(str_to_title(taskname), "\n NPS/Outcome linear relationship does not differ as a function of stimulus intensity and cue"), color = "black", face = "bold", size = 12))
plots_title
```

```{r}
cue_high = demean_dropna[demean_dropna$cue_name == "high", ]
fig.height = 50
fig.width = 10
ggplot(aes(x=EXPECT_demean, y=NPSpos), data=cue_high) +
  geom_smooth(method='lm', se=F, size=0.75) +
  geom_point(size=0.1) + 
    # geom_abline(intercept = 0, slope = 1, color="green", 
    #              linetype="dashed", size=0.5) +
  facet_wrap(~sub) + 
  theme(legend.position='none') + 
  xlim(-50,50) + ylim(-50,50) +
  xlab("raw data from each participant: n-1 lagged outcome angle") + 
  ylab("n current expectation rating") 

```

```{r}
cue_low = demean_dropna[demean_dropna$cue_name == "low", ]
fig.height = 50
fig.width = 10
ggplot(aes(x=EXPECT_demean, y=NPSpos), data=cue_low) +
  geom_smooth(method='lm', se=F, size=0.75) +
  geom_point(size=0.1) + 
    # geom_abline(intercept = 0, slope = 1, color="green", 
    #              linetype="dashed", size=0.5) +
  facet_wrap(~sub) + 
  theme(legend.position='none') + 
  xlim(-50,50) + ylim(-50,50) +
  xlab("raw data from each participant: n-1 lagged outcome angle") + 
  ylab("n current expectation rating") 

```

#### facetwrap
```{r}
# 74, 85, 118
fig.height = 50
fig.width = 10
ggplot(aes(x=EXPECT_demean, y=NPSpos), data=demean_high) +
  geom_smooth(method='lm', se=F, size=0.75) +
  geom_point(size=0.1) + 
    # geom_abline(intercept = 0, slope = 1, color="green", 
    #              linetype="dashed", size=0.5) +
  facet_wrap(~sub) + 
  theme(legend.position='none') + 
  xlim(-50,50) + ylim(-50,50) +
  xlab("raw data from each participant: n-1 lagged outcome angle") + 
  ylab("n current expectation rating") 

```
```{r}
# 74, 85, 118, 117
fig.height = 50
fig.width = 10
ggplot(aes(x=EXPECT_demean, y=NPSpos), data=demean_low) +
  geom_smooth(method='lm', se=F, size=0.75) +
  geom_point(size=0.1) + 
    # geom_abline(intercept = 0, slope = 1, color="green", 
    #              linetype="dashed", size=0.5) +
  facet_wrap(~sub) + 
  theme(legend.position='none') + 
  xlim(-50,50) + ylim(-50,50) +
  xlab("raw data from each participant: n-1 lagged outcome angle") + 
  ylab("n current expectation rating") 

```
```{r}
# 74, 85, 118, 117
fig.height = 50
fig.width = 10
ggplot(aes(x=EXPECT_demean, y=NPSpos), data=demean_med) +
  geom_smooth(method='lm', se=F, size=0.75) +
  geom_point(size=0.1) + 
    # geom_abline(intercept = 0, slope = 1, color="green", 
    #              linetype="dashed", size=0.5) +
  facet_wrap(~sub) + 
  theme(legend.position='none') + 
  xlim(-50,50) + ylim(-50,50) +
  xlab("raw data from each participant: n-1 lagged outcome angle") + 
  ylab("n current expectation rating") 

```



 #### subjectwise plot v2
```{r}
ggplot(demean_med, aes(y = NPSpos, 
                       x = EXPECT_demean, 
                       colour = cuetype, shape = sub), size = .3, color = 'gray') + 
  geom_point(size = .1) + 
  geom_smooth(method = 'lm', formula= y ~ x, se = FALSE, size = .3) +
  scale_color_manual(values = c("cuetype-high" = "#941100", "cuetype-low" = "#BBBBBB"), ) +
  theme_classic()


```

#### subjetwise plot
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
iv1 = "EXPECT_demean"; iv2 = "NPSpos" # "NPS_demean"
group = "cuetype"; subject = "sub"
xlab = "Expectation rating \n(subjectwise mean-centered)"
ylab = paste(signature_key) #, "\n(subjectwise mean-centered)")
# low stimulus intensity
demean_low = demean_dropna[demean_dropna$stimintensity == "low", ]
low <-
  plot_twovariable(
    demean_low, iv1 , iv2,
    group = group, subject = subject,
    ymin=-20, ymax=20, xmin=-50, xmax=50,
    xlab = xlab, ylab = ylab, 
    #, " \n(mean-centered)"),
    ggtitle = "Low intensity",
    color_scheme = c("cuetype-high" ="#FF8800","cuetype-low" =  "#5D5C5C"),
    alpha = .5, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE, size = ".data[['sub']]"
  )

# med stimulus intensity
demean_med = demean_dropna[demean_dropna$stimintensity == "med", ]
med <-
  plot_twovariable(
    demean_med, iv1, iv2,
    group = group, subject = subject,
    ymin=-20, ymax=20, xmin=-50, xmax=50,
    xlab = xlab, ylab = ylab, 
    ggtitle = "Medium intensity",
    color_scheme = c("cuetype-high" ="#DB6000","cuetype-low" =  "#5D5C5C"),
    alpha = .5, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE
  )

# high stimulus intensity
demean_high = demean_dropna[demean_dropna$stimintensity == "high", ]
high <-
  plot_twovariable(
    demean_high, iv1, iv2,
    group = group, subject = subject,
    ymin=-20, ymax=20, xmin=-50, xmax=50,
    xlab = xlab, ylab = ylab, 
    ggtitle = "High intensity",
    color_scheme = c("cuetype-high" ="#941100","cuetype-low" =  "#5D5C5C"),
    alpha = .5, fit_lm = TRUE, lm_method = "lm", identity_line = FALSE
  )


plots <- ggpubr::ggarrange(low, med, high, ncol = 3, nrow = 1, common.legend = FALSE, legend = "bottom")
plots_title <- annotate_figure(plots, top = text_grob(paste(str_to_title(taskname), "\n NPS/Outcome linear relationship does not differ as a function of stimulus intensity and cue"), color = "black", face = "bold", size = 12))
plots_title
```



### ACCURATE Is this statistically significant?

#### ACCURATE: NPS ~ demean + CMC
```{r echo=TRUE, warning=TRUE, paged.print=FALSE}
model.npsexpectdemean <- lmer(NPSpos ~ 
                          CUE_high_gt_low*STIM_linear*EXPECT_demean +
                          CUE_high_gt_low*STIM_quadratic*EXPECT_demean +
                          EXPECT_cmc +
                          (CUE_high_gt_low |sub), data = demean_dropna, REML= FALSE
                    )
```

### GEORGE SUGGESTION
```{r echo=TRUE, warning=TRUE, paged.print=FALSE}
model.nps_randomintercept <- lmer(NPSpos ~ 
                          CUE_high_gt_low*STIM_linear*EXPECT_demean +
                          CUE_high_gt_low*STIM_quadratic*EXPECT_demean +
                          EXPECT_cmc +
                          (1 |sub), data = demean_dropna, REML = FALSE
                    ) 
# CUE_high_gt_low+STIM+EXPECT_demean
sjPlot::tab_model(model.npsexpectdemean,
                  title = "Multilevel-modeling: \nlmer(NPSpos ~ CUE * STIM * EXPECT_demean + (1| sub), data = pvc)",
                  CSS = list(css.table = '+font-size: 12;'))
```

```{r}
# lmerTest::
anova(model.npsexpectdemean)
```

```{r}
# summary(model.npsexpectdemean)
anova(model.nps_randomintercept, model.npsexpectdemean)
```

#### ACCURATE: NPS ~ demean + CMC + SES
```{r echo=TRUE, warning=TRUE, paged.print=FALSE}
model.npsexpectdemean <- lmer(NPSpos ~ 
                          CUE_high_gt_low*STIM_linear*EXPECT_demean +
                          CUE_high_gt_low*STIM_quadratic*EXPECT_demean +
                          EXPECT_cmc + 
                          (CUE_high_gt_low |sub), data = demean_dropna
                    ) 
# CUE_high_gt_low+STIM+EXPECT_demean
sjPlot::tab_model(model.npsexpectdemean,
                  title = "Multilevel-modeling: \nlmer(NPSpos ~ CUE * STIM * EXPECT_demean + (1| sub), data = pvc)",
                  CSS = list(css.table = '+font-size: 12;'))
```

#### simple slopes when STIM == 'high', EXPECT_demean slope difference between high vs. low cue
```{r}
interactions::sim_slopes(model=model.npsexpectdemean, pred=EXPECT_demean, modx=CUE_high_gt_low, mod2 =STIM_linear, mod2.values = 0.5, centered = 'all', data = demean_dropna)

```


#### emtrneds
```{r}
emt.t <- emtrends(model.npsexpectdemean, ~ STIM_linear | CUE_high_gt_low, 
         var = "EXPECT_demean", 
         # nuisance = c("EXPECT_cmc"),
         at = list(STIM_linear=c(0.5, 0, -0.5)),
         lmer.df = "asymp")
pairs(emt.t, simple = "each")
# contrast(emt.t, "revpairwise")
```



#### resourcees on simple slopes in lmer
```
# https://stats.stackexchange.com/questions/365466/significance-of-slope-different-than-zero-in-triple-interaction-with-factors
# https://stats.stackexchange.com/questions/586748/calculating-trends-with-emtrends-for-three-way-interaction-model-results-in-sa
# emtrends(model.npsexpectdemean, var = 'EXPECT_demean', lmer.df = "asymptotic") 

```



#### ACCURATE: NPS ~ demean + CMC
```{r echo=TRUE, message=FALSE, warning=TRUE, paged.print=FALSE}
model.npsexpectdemean <- lmer(NPSpos ~ 
                          CUE_high_gt_low*EXPECT_demean  +  EXPECT_cmc + factor(ses) +
                          (1|sub), data = demean_dropna
                    )
# CUE_high_gt_low+STIM+EXPECT_demean
sjPlot::tab_model(model.npsexpectdemean,
                  title = "Multilevel-modeling: \nlmer(NPSpos ~ CUE * STIM * EXPECT_demean + (1| sub), data = pvc)",
                  CSS = list(css.table = '+font-size: 12;'))
```

