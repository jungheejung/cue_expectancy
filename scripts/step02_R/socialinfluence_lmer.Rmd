---
title: "R Notebook"
output: html_notebook
---

# load libraries
```{r}
library(psych)
library(car)
library(lmSupport)
library(lme4)
library(lmerTest)
library(plyr)
#library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
#library(Hmisc)
#library(Rmisc)
library(png)
library(knitr)
library(TMB)
library(sjPlot)
library(ggpubr)
library(gridExtra)
library(merTools)
library(sjstats) #to get ICC
library(broom)
library(tidyverse)
library(GGally)
library(RCurl)
library(rstanarm)
library(reshape)
library(boot)
library(afex)
library(cowplot)
library(readr)
library(lavaan)
library(rmarkdown)
library(readr)
library(caTools)
library(bitops)
library(stringr)
## library(extraoperators)
##library(JWileymisc)
##library(multilevelTools)
library(ggpubr)
# library(PupillometryR)
source('http://psych.colorado.edu/~jclab/R/mcSummaryLm.R')
source("/Users/h/Documents/projects_local/RainCloudPlots/tutorial_R/R_rainclouds.R")
source("/Users/h/Documents/projects_local/RainCloudPlots/tutorial_R/summaryse.R")
source("/Users/h/Documents/projects_local/RainCloudPlots/tutorial_R/simulatedata.R")
source("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")
library(r2mlm)
source("/Users/h/Dropbox/projects_dropbox/social_influence_analysis/scripts/step02_R/utils")
```

# parameters
```{r}
main_dir = dirname(dirname(getwd()))
```

# 0. function

# 1. expectation ratings
* Do expectations ratings differ as a function of cue type?
* If there is a main effect of cue on expectation ratings, does htis differ depending on task type?
```{r}
# parameters
subject_varkey = "src_subject_id"
iv = "param_cue_type"
dv = "event02_expect_angle"
dv_keyword = "expect"
xlab = ""; ylab = "ratings (degree)"; 
subject = "subject"
exclude = ""

analysis_dir =file.path(main_dir,'analysis', 'mixedeffect', 'model01_cue_expectrating_02-2022')

for (taskname in c("pain", "vicarious", "cognitive")){

save_fname = file.path(analysis_dir, paste('lmer_task-', taskname, '_rating-',dv_keyword,'_', as.character(Sys.Date()),'.txt',sep = ''))
data = expect_df(taskname, subject_varkey, iv, dv, exclude )
cooksd = lmer_onefactor_cooksd(data,taskname, iv, dv, subject, dv_keyword, save_fname)
influential <- as.numeric(names(cooksd)[(cooksd > (4/as.numeric(length(unique(data$src_subject_id))))    )])
data_screen <- data[-influential, ]

subjectwise = meanSummary(data, c(subject, iv), dv)
groupwise = summarysewithin(
    data=subjectwise, 
                  measurevar = "mean_per_sub", # variable created from above
                    withinvars = c(iv), # iv
                    idvar = "subject")

subjectwise_mean = "mean_per_sub"; group_mean = "mean_per_sub_norm_mean"; se = "se"; subject = "subject"
ggtitle = paste(taskname, " - Expectation Rating (degree)"); TITLE = paste(taskname, " - Expect")
xlab = ""; ylab = "ratings (degree)"; dv_keyword = "expect"
if(any(startsWith(dv_keyword, c("expect", "Expect")))){COLOR = c( "#1B9E77", "#D95F02")}else{COLOR=c( "#4575B4", "#D73027")} # if keyword starts with
#save_fname = file.path(analysis_dir, paste('raincloudplot_task-', taskname,'_rating-',dv_keyword,'.png',sep = ''))

save_fname = file.path(main_dir, 'analysis','mixedeffect', 'model01_cue_expectrating_02-2022', paste('raincloudpoint_task-' ,taskname, '_rating-', dv_keyword,'_', as.character(Sys.Date()),'.png', sep = ""))
plot_expect_rainclouds(subjectwise, groupwise, 
                                  iv, subjectwise_mean, group_mean, se, subject,
                                  ggtitle, TITLE, xlab, ylab,task_name, w, h, dv_keyword,COLOR, save_fname) 

}
```


# 1-1. cue on expectation rating
# 1-2. individual differences in expectation rating cue effect 
# 2. actual ratings

# 2-1. cue on actual ratings
# 2-2. cue effect (contrast)
# 2-3. cue x stim on actual ratings
# 2-4. individual differences in cue effects
# 2-5. ICC of cue effect